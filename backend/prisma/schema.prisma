// Prisma schema for MORE App backend

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String              @id @default(cuid())
  lineUserId    String?             @unique
  email         String?             @unique
  name          String?
  avatarUrl     String?
  language      String?
  preferredLocale String?           @default("ja")
  prefecture    String?
  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt
  isOrganizer   Boolean             @default(false)
  isAdmin       Boolean             @default(false)
  status        String              @default("active")
  communities   Community[]         @relation("CommunityOwner")
  memberships   CommunityMember[]
  registrations EventRegistration[]
  payments      Payment[]
  organizerApplications OrganizerApplication[]
  aiEventDraftLogs AiEventDraftLog[]
  promptAudits  PromptAuditLog[]
  promptDefinitionsCreated PromptDefinition[] @relation("PromptCreatedBy")
  promptDefinitionsUpdated PromptDefinition[] @relation("PromptUpdatedBy")
  promptDefinitionsApproved PromptDefinition[] @relation("PromptApprovedBy")
  updatedI18nMessages I18nMessage[] @relation("I18nMessageUpdatedBy")
  analyticsEvents AnalyticsEvent[]
  gatewayEvents PaymentGatewayEvent[]
  ledgerEntries LedgerEntry[]
}

model Community {
  id             String             @id @default(cuid())
  ownerId        String
  name           String
  slug           String             @unique
  description    Json
  coverImageUrl  String?
  labels         String[]
  visibleLevel   String
  language       String?
  pricingPlanId  String?
  stripeAccountId String?
  stripeAccountOnboarded Boolean    @default(false)
  stripeSubscriptionId String?
  stripeCustomerId String?
  status         String             @default("active")
  createdAt      DateTime           @default(now())
  updatedAt      DateTime           @updatedAt
  owner          User               @relation("CommunityOwner", fields: [ownerId], references: [id])
  pricingPlan    PricingPlan?       @relation(fields: [pricingPlanId], references: [id])
  members        CommunityMember[]
  events         Event[]
  classes        Class[]
  payments       Payment[]
  aiEventDraftLogs AiEventDraftLog[]
  gatewayEvents  PaymentGatewayEvent[]
  ledgerEntries  LedgerEntry[]
}

model CommunityTagCategory {
  id        String   @id @default(cuid())
  nameJa    String
  nameEn    String?
  nameZh    String?
  order     Int      @default(1000)
  active    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  tags      CommunityTag[]
}

model CommunityTag {
  id          String   @id @default(cuid())
  categoryId  String
  nameJa      String
  nameEn      String?
  nameZh      String?
  order       Int      @default(1000)
  active      Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  category    CommunityTagCategory @relation(fields: [categoryId], references: [id])

  @@index([categoryId])
}

model CommunityMember {
  id              String    @id @default(cuid())
  communityId     String
  userId          String
  role            String    @default("member")
  status          String    @default("active")
  joinedAt        DateTime  @default(now())
  lastActiveAt    DateTime?
  totalAttendance Int       @default(0)
  totalRegistered Int       @default(0)
  totalNoShow     Int       @default(0)
  community       Community @relation(fields: [communityId], references: [id])
  user            User      @relation(fields: [userId], references: [id])

  @@unique([communityId, userId])
}

model Event {
  id                     String               @id @default(cuid())
  communityId            String
  title                  Json
  description            Json
  descriptionHtml        String?
  originalLanguage       String               @default("ja")
  category               String?
  startTime              DateTime
  endTime                DateTime
  regDeadline            DateTime
  regStartTime           DateTime?
  regEndTime             DateTime?
  locationText           String
  locationLat            Float?
  locationLng            Float?
  minParticipants        Int?
  maxParticipants        Int?
  visibility             String
  requireApproval        Boolean              @default(false)
  status                 String
  reviewStatus           String               @default("pending_review")
  reviewReason           String?
  reviewReviewedAt       DateTime?
  reviewReviewerId       String?
  registrationFormSchema Json?
  config                 Json?
  refundPolicy           Json?
  coverType              String?
  createdAt              DateTime             @default(now())
  updatedAt              DateTime             @updatedAt
  community              Community            @relation(fields: [communityId], references: [id])
  ticketTypes            EventTicketType[]
  registrations          EventRegistration[]
  checkins               EventCheckin[]
  galleries              EventGallery[]
  payments               Payment[]
  gatewayEvents          PaymentGatewayEvent[]
}

model Class {
  id                 String    @id @default(cuid())
  communityId        String
  title              Json
  description        Json?
  locationName       String?
  priceYenPerLesson  Int
  defaultCapacity    Int?
  status             String    @default("active")
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt
  community          Community @relation(fields: [communityId], references: [id])
  lessons            Lesson[]
}

model Lesson {
  id             String   @id @default(cuid())
  classId        String
  startAt        DateTime
  endAt          DateTime?
  capacity       Int?
  status         String   @default("scheduled")
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  class          Class    @relation(fields: [classId], references: [id])
  registrations  EventRegistration[]
  payments       Payment[]
  refundRequests RefundRequest[]
  checkins       EventCheckin[]
  gatewayEvents  PaymentGatewayEvent[]
  ledgerEntries  LedgerEntry[]

  @@index([classId, startAt])
}

model EventTicketType {
  id         String   @id @default(cuid())
  eventId    String
  name       Json
  type       String
  price      Int
  quota      Int?
  createdAt  DateTime @default(now())
  event      Event    @relation(fields: [eventId], references: [id])
  registrations EventRegistration[]
}

model EventRegistration {
  id            String          @id @default(cuid())
  eventId       String?
  userId        String
  ticketTypeId  String?
  lessonId      String?
  status        String
  formAnswers   Json?
  amount        Int             @default(0)
  paidAmount    Int             @default(0)
  paymentStatus String
  attended      Boolean         @default(false)
  noShow        Boolean         @default(false)
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  event         Event?          @relation(fields: [eventId], references: [id])
  user          User            @relation(fields: [userId], references: [id])
  ticketType    EventTicketType? @relation(fields: [ticketTypeId], references: [id])
  lesson        Lesson?         @relation(fields: [lessonId], references: [id])
  checkins      EventCheckin[]
  payment       Payment?        @relation("RegistrationPayment")
  refundRequest RefundRequest?
  gatewayEvents PaymentGatewayEvent[]
  ledgerEntries LedgerEntry[]

  @@unique([userId, lessonId])
  @@unique([eventId, userId])
}

model EventCheckin {
  id             String           @id @default(cuid())
  eventId        String?
  registrationId String
  lessonId       String?
  checkinAt      DateTime         @default(now())
  checkinType    String
  event          Event?           @relation(fields: [eventId], references: [id])
  registration   EventRegistration @relation(fields: [registrationId], references: [id])
  lesson         Lesson?          @relation(fields: [lessonId], references: [id])
}

model AnalyticsEvent {
  id         String   @id @default(cuid())
  eventName  String
  timestamp  DateTime @default(now())
  sessionId  String
  userId     String?
  path       String?
  isLiff     Boolean  @default(false)
  userAgent  String?
  payload    Json?
  createdAt  DateTime @default(now())

  user       User?    @relation(fields: [userId], references: [id])

  @@index([eventName, timestamp])
  @@index([sessionId])
}

model EventGallery {
  id        String   @id @default(cuid())
  eventId   String
  event     Event    @relation(fields: [eventId], references: [id])
  imageUrl  String
  isCover   Boolean  @default(true)
  order     Int      @default(0)
  createdAt DateTime @default(now())
}

model Payment {
  id                      String    @id @default(cuid())
  userId                  String
  communityId             String?
  eventId                 String?
  registrationId          String?  @unique
  lessonId                String?
  amount                  Int
  platformFee             Int      @default(0)
  feePercent              Float?
  currency                String   @default("jpy")
  status                  String   @default("pending")
  method                  String   @default("stripe")
  // provider-agnostic anchors
  provider                String?
  providerObjectId        String?
  providerObjectType      String?
  providerAccountId       String?
  providerBalanceTxId     String?
  idempotencyKey          String?   @unique
  stripePaymentIntentId   String?
  stripeChargeId          String?
  stripeRefundId          String?
  stripeCheckoutSessionId String? @unique
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt
  user                    User     @relation(fields: [userId], references: [id])
  community               Community? @relation(fields: [communityId], references: [id])
  event                   Event?    @relation(fields: [eventId], references: [id])
  registration            EventRegistration? @relation("RegistrationPayment", fields: [registrationId], references: [id])
  lesson                  Lesson?   @relation(fields: [lessonId], references: [id])
  refundRequests          RefundRequest[]
  gatewayEvents           PaymentGatewayEvent[]
  ledgerEntries           LedgerEntry[]

  @@index([provider, providerObjectId])
  @@index([providerBalanceTxId])
}

model RefundRequest {
  id               String   @id @default(cuid())
  registrationId   String   @unique
  lessonId         String?
  paymentId        String?
  idempotencyKey   String?  @unique
  decision         String?
  status           String   @default("requested")
  requestedAmount  Int
  approvedAmount   Int?
  refundedAmount   Int?
  reason           String?
  gatewayRefundId  String?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  registration     EventRegistration @relation(fields: [registrationId], references: [id])
  payment          Payment?          @relation(fields: [paymentId], references: [id])
  lesson           Lesson?           @relation(fields: [lessonId], references: [id])
}

// 保存外部決済ゲートウェイとのやり取りを全件記録する監査ログ
model PaymentGatewayEvent {
  id             String   @id @default(cuid())
  paymentId      String?
  registrationId String?
  eventId        String?
  lessonId       String?
  communityId    String?
  userId         String?
  gateway        String   // stripe/mock/other
  provider       String?  // alias of gateway, kept for compatibility
  providerEventId String?
  providerAccountId String?
  providerObjectId  String?
  eventType      String   // checkout_created/webhook/charge.refunded 等
  status         String   // success/failure/ignored
  message        String?
  payload        Json?
  payloadHash    String?
  receivedAt     DateTime @default(now())
  processedAt    DateTime?
  attempts       Int      @default(0)
  errorMessage   String?
  createdAt      DateTime @default(now())

  payment        Payment?          @relation(fields: [paymentId], references: [id])
  registration   EventRegistration? @relation(fields: [registrationId], references: [id])
  event          Event?            @relation(fields: [eventId], references: [id])
  lesson         Lesson?           @relation(fields: [lessonId], references: [id])
  community      Community?        @relation(fields: [communityId], references: [id])
  user           User?             @relation(fields: [userId], references: [id])

  @@index([paymentId])
  @@index([registrationId])
  @@index([eventId])
  @@index([lessonId])
  @@index([communityId])
  @@index([userId])
  @@index([gateway, eventType])
  @@index([status])
  @@unique([provider, providerEventId], name: "provider_providerEventId")
}

// 不可变的资金账本条目，唯一真实来源
model LedgerEntry {
  id                     String   @id @default(cuid())
  businessPaymentId      String
  businessRegistrationId String?
  businessLessonId       String?
  businessCommunityId    String?
  userId                 String?
  entryType              String   // charge/refund/dispute/adjustment
  direction              String   // in/out
  amount                 Int
  currency               String   @default("jpy")
  provider               String
  providerObjectType     String?
  providerObjectId       String?
  providerBalanceTxId    String?
  providerAccountId      String?
  idempotencyKey         String   @unique
  status                 String   @default("booked") // booked/reversed
  reversalOfLedgerId     String?
  reversedByLedgerId     String?
  occurredAt             DateTime @default(now())
  metadata               Json?
  createdAt              DateTime @default(now())

  payment      Payment? @relation(fields: [businessPaymentId], references: [id])
  registration EventRegistration? @relation(fields: [businessRegistrationId], references: [id])
  lesson       Lesson? @relation(fields: [businessLessonId], references: [id])
  community    Community? @relation(fields: [businessCommunityId], references: [id])
  user         User? @relation(fields: [userId], references: [id])

  @@index([provider, providerObjectId])
  @@index([businessPaymentId])
  @@index([businessRegistrationId])
  @@index([businessLessonId])
  @@index([businessCommunityId])
  @@index([userId])
  @@index([providerBalanceTxId])
  @@index([entryType])
}

model I18nMessage {
  id          String   @id @default(cuid())
  namespace   String
  key         String
  lang        String
  text        String
  version     Int      @default(1)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  updatedById String?
  updatedBy   User?    @relation("I18nMessageUpdatedBy", fields: [updatedById], references: [id])

  @@unique([namespace, key, lang])
}

model PricingPlan {
  id                    String      @id
  name                  String
  monthlyFee            Int
  transactionFeePercent Float
  transactionFeeFixed   Int
  payoutSchedule        String
  features              Json?
  stripePriceId         String?
  active                Boolean     @default(true)
  feePolicies           FeePolicy[]
  communities           Community[]
}

model PromptAuditLog {
  id        String   @id @default(cuid())
  promptId  String
  version   String?
  action    String
  actorId   String?
  notes     String?
  createdAt DateTime @default(now())
  actor     User?    @relation(fields: [actorId], references: [id])
}

model PromptDefinition {
  id            String   @id
  name          String
  description   String?
  version       String?
  system        String
  instructions  String?
  params        Json?
  tags          Json?
  meta          Json?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  createdById   String?
  updatedById   String?
  createdBy     User?    @relation("PromptCreatedBy", fields: [createdById], references: [id])
  updatedBy     User?    @relation("PromptUpdatedBy", fields: [updatedById], references: [id])
  status        String   @default("draft")
  approvedById  String?
  approvedAt    DateTime?
  approvedBy    User?    @relation("PromptApprovedBy", fields: [approvedById], references: [id])
}

model FeePolicy {
  id            String   @id @default(cuid())
  pricingPlanId String
  pricingPlan   PricingPlan @relation(fields: [pricingPlanId], references: [id])
  percent       Float
  fixed         Int
  startAt       DateTime @default(now())
  endAt         DateTime?
}

model OrganizerApplication {
  id         String   @id @default(cuid())
  userId     String
  user       User     @relation(fields: [userId], references: [id])
  status     String   @default("pending")
  reason     String?
  experience String?
  note       String?
  createdAt  DateTime @default(now())
  reviewedAt DateTime?
  reviewerId String?
}

model AiEventDraftLog {
  id           String    @id @default(cuid())
  communityId  String
  userId       String
  stage        String
  summary      String?
  qaState      Json?
  messages     Json
  aiResult     Json?
  promptVersion String?  @default("coach-v1")
  status       String?   @default("collecting")
  turnCount    Int?      @default(0)
  language     String?
  meta         Json?
  createdAt    DateTime  @default(now())
  community    Community @relation(fields: [communityId], references: [id])
  user         User      @relation(fields: [userId], references: [id])
}

// Managed asset for UGC images/files
model ManagedAsset {
  id               String   @id @default(cuid())
  tenantId         String
  ownerId          String
  resourceType     String
  resourceId       String?
  role             String?
  bucket           String
  objectKey        String
  originalName     String?
  mimeType         String
  size             Int
  hash             String?
  variants         Json?
  width            Int?
  height           Int?
  status           String   @default("pending")
  moderationStatus String   @default("pending")
  moderationReason String?
  visibility       String   @default("public")
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  deletedAt        DateTime?

  @@index([resourceType, resourceId])
  @@index([ownerId])
  @@index([status])
  @@index([tenantId])
}
