import{d as oe,a7 as ae,B as ne,C as ie,r as u,c as re,o as de,e as r,A as ue,i as l,s as W,u as ce,t as m,w as pe,j as V,x as w,y as k,F as E,h as z,L as ve,k as X,a9 as me,b as I,g as ge,ap as be,ab as Y,ac as fe,f as d,_ as ye}from"./index-DncFUGrq.js";import{P as he}from"./PageMarker-B9WMY3Nd.js";const _e={class:"community-settings"},we={class:"hero-card"},Ue={class:"hero-text"},Ce={class:"hero-status"},ke={class:"form-card"},Ie={class:"ios-field"},Le={class:"ios-field"},xe={class:"form-card"},Se={class:"ios-field"},De={key:0,class:"chip-row"},Fe={class:"form-card"},Ve={class:"radio-group"},Ee=["value"],Me={class:"radio-content"},Ae={class:"radio-title"},Pe={class:"radio-desc"},Be={class:"form-card"},Oe={class:"upload-grid"},Te={class:"upload-card"},Ne={key:0,class:"upload-preview"},Re=["src"],$e={key:1,class:"upload-empty"},je={class:"upload-card"},He={key:0,class:"upload-preview"},We=["src"],ze={key:1,class:"upload-empty"},Xe={class:"form-card"},Ye={class:"card-head"},qe={class:"card-head__right"},Ge=["disabled"],Je={key:0,class:"stripe-hint"},Ke=["href"],Qe={key:0,class:"form-error"},Ze={class:"form-footer"},el=["disabled"],ll=["disabled"],sl=oe({__name:"ConsoleCommunitySettingsMobile",setup(tl){const q=ne(),M=ce(),A=ae(),c=q.params.communityId,t=ie({name:"",slug:"",labels:"",visibleLevel:"public",coverImageUrl:"",logoImageUrl:"",description:""}),g=u(null),b=u(null),P=u(null),B=u(null),L=u(!1),x=u(!1),f=u(!1),p=u(null),G=[{value:"public",label:"公開",desc:"誰でも閲覧できる"},{value:"semi-public",label:"社群限定",desc:"Console / 既存メンバーのみ"},{value:"private",label:"非公開",desc:"運営メモ用・外部非公開"}],S=re(()=>t.labels.split(",").map(s=>s.trim()).filter(Boolean)),O=async()=>{if(c)try{const s=await me(c);t.name=s.name,t.slug=s.slug,t.labels=(s.labels||[]).join(", "),t.visibleLevel=s.visibleLevel??"public",t.coverImageUrl=s.coverImageUrl||"",g.value=t.coverImageUrl?I(t.coverImageUrl):null;const e=typeof s.description=="object"&&s.description?s.description:null;t.description=ge(s.description),t.logoImageUrl=(e==null?void 0:e.logoImageUrl)??"",b.value=t.logoImageUrl?I(t.logoImageUrl):null,y.value=(e==null?void 0:e._stripeOnboardLink)??null}catch(s){p.value=s instanceof Error?s.message:"社群情報の取得に失敗しました"}},J=()=>({original:t.description,lang:"ja",translations:{},logoImageUrl:t.logoImageUrl||null,_stripeOnboardLink:y.value||null}),K=()=>{var s;return(s=P.value)==null?void 0:s.click()},Q=()=>{var s;return(s=B.value)==null?void 0:s.click()},U=u(!1),y=u(null),Z=async()=>{U.value=!0,p.value=null;try{const{url:s}=await be(c);y.value=s,window.location.href=s}catch(s){p.value=s instanceof Error?s.message:"Stripe 連携リンクの取得に失敗しました"}finally{U.value=!1}},T=(s,e,o)=>new Promise((n,a)=>{const v=new FileReader;v.onload=()=>{const i=new Image;i.onload=()=>{const{width:$,height:D}=i;let h=$,_=h/e;_>D&&(_=D,h=_*e);const se=($-h)/2,te=(D-_)/2,F=Math.min(o,h),j=F/e,C=document.createElement("canvas");C.width=F,C.height=j;const H=C.getContext("2d");if(!H){a(new Error("Canvas not supported"));return}H.drawImage(i,se,te,h,_,0,0,F,j),n(C.toDataURL("image/jpeg",.85))},i.onerror=()=>a(new Error("Failed to load image")),i.src=v.result},v.onerror=()=>a(new Error("Failed to read file")),v.readAsDataURL(s)}),N=async(s,e)=>{const n=await(await fetch(s)).blob();return new File([n],e,{type:n.type||"image/jpeg"})},ee=async s=>{var n;const o=(n=s.target.files)==null?void 0:n[0];if(!(!o||L.value)){if(!c){p.value="コミュニティ ID が取得できません。ページを再読み込みしてください。";return}L.value=!0;try{const a=await T(o,1.7777777777777777,1280);g.value=a;const v=await N(a,`cover-${Date.now()}.jpg`),{imageUrl:i}=await Y(c,v,"cover");t.coverImageUrl=i,g.value=I(i)}catch(a){console.warn(a)}finally{L.value=!1}}},le=async s=>{var n;const o=(n=s.target.files)==null?void 0:n[0];if(!(!o||x.value)){if(!c){p.value="コミュニティ ID が取得できません。ページを再読み込みしてください。";return}x.value=!0;try{const a=await T(o,1,512);b.value=a;const v=await N(a,`logo-${Date.now()}.jpg`),{imageUrl:i}=await Y(c,v,"logo");t.logoImageUrl=i,b.value=I(i)}catch(a){console.warn(a)}finally{x.value=!1}}},R=async()=>{if(!c)return;f.value=!0,p.value=null;const s={labels:S.value,visibleLevel:t.visibleLevel,coverImageUrl:t.coverImageUrl||null,logoImageUrl:t.logoImageUrl||null,description:J()};try{await fe(c,s),await O(),await A.loadCommunities(!0),A.refreshActiveCommunity()}catch(e){p.value=e instanceof Error?e.message:"更新に失敗しました"}finally{f.value=!1}};return de(O),(s,e)=>(d(),r(E,null,[ue(he,{label:"P3"}),l("div",_e,[l("header",we,[l("button",{class:"hero-back",type:"button",onClick:e[0]||(e[0]=o=>W(M).back())},[...e[7]||(e[7]=[l("span",{class:"i-lucide-chevron-left"},null,-1)])]),l("div",Ue,[e[8]||(e[8]=l("p",{class:"hero-eyebrow"},"社群設定",-1)),l("h1",null,m(t.name||"コミュニティ"),1),e[9]||(e[9]=l("p",{class:"hero-subtext"},"公開情報と AI が参照するプロフィールをここで管理します。",-1))]),l("span",Ce,m(t.visibleLevel==="private"?"非公開":"公開中"),1)]),l("form",{class:"form-sections",onSubmit:pe(R,["prevent"])},[l("section",ke,[e[12]||(e[12]=l("p",{class:"card-label"},"基本情報",-1)),l("div",Ie,[e[10]||(e[10]=l("label",null,"社群名称",-1)),w(l("input",{"onUpdate:modelValue":e[1]||(e[1]=o=>t.name=o),type:"text",placeholder:"Tokyo Community...",disabled:""},null,512),[[k,t.name]])]),l("div",Le,[e[11]||(e[11]=l("label",null,"Slug",-1)),w(l("input",{"onUpdate:modelValue":e[2]||(e[2]=o=>t.slug=o),type:"text",disabled:""},null,512),[[k,t.slug]])])]),l("section",xe,[e[14]||(e[14]=l("div",{class:"card-head"},[l("p",{class:"card-label"},"ラベル"),l("p",{class:"card-hint"},"活動領域やキーワードをカンマ区切りで追加")],-1)),l("div",Se,[e[13]||(e[13]=l("label",null,"キーワード",-1)),w(l("input",{"onUpdate:modelValue":e[3]||(e[3]=o=>t.labels=o),type:"text",placeholder:"多文化, 親子, コミュニティ"},null,512),[[k,t.labels]])]),S.value.length?(d(),r("div",De,[(d(!0),r(E,null,z(S.value,o=>(d(),r("span",{key:o,class:"chip"},m(o),1))),128))])):V("",!0)]),l("section",Fe,[e[15]||(e[15]=l("div",{class:"card-head"},[l("p",{class:"card-label"},"公開範囲"),l("p",{class:"card-hint"},"ユーザー側にどこまで表示するかを選びます")],-1)),l("div",Ve,[(d(),r(E,null,z(G,o=>l("label",{key:o.value,class:"radio-tile"},[w(l("input",{"onUpdate:modelValue":e[4]||(e[4]=n=>t.visibleLevel=n),value:o.value,type:"radio"},null,8,Ee),[[ve,t.visibleLevel]]),l("div",Me,[l("p",Ae,m(o.label),1),l("p",Pe,m(o.desc),1)])])),64))])]),l("section",Be,[e[20]||(e[20]=l("p",{class:"card-label"},"ビジュアル",-1)),l("div",Oe,[l("div",Te,[e[17]||(e[17]=l("p",{class:"upload-title"},"ロゴ",-1)),l("div",{class:"upload-drop",onClick:Q},[l("input",{ref_key:"logoInput",ref:B,type:"file",accept:"image/*",class:"hidden-input",onChange:le},null,544),b.value?(d(),r("div",Ne,[l("img",{src:b.value,alt:"logo preview"},null,8,Re)])):(d(),r("div",$e,[...e[16]||(e[16]=[l("span",{class:"i-lucide-image-plus"},null,-1),l("p",null,"タップしてアップロード",-1)])]))])]),l("div",je,[e[19]||(e[19]=l("p",{class:"upload-title"},"カバー画像",-1)),l("div",{class:"upload-drop",onClick:K},[l("input",{ref_key:"coverInput",ref:P,type:"file",accept:"image/*",class:"hidden-input",onChange:ee},null,544),g.value?(d(),r("div",He,[l("img",{src:g.value,alt:"cover preview"},null,8,We)])):(d(),r("div",ze,[...e[18]||(e[18]=[l("span",{class:"i-lucide-image-plus"},null,-1),l("p",null,"タップしてアップロード",-1)])]))])])])]),l("section",Xe,[l("div",Ye,[e[23]||(e[23]=l("p",{class:"card-label"},"社群紹介",-1)),l("div",qe,[e[22]||(e[22]=l("p",{class:"card-hint"},"AI の憲法/歓迎文にも引用されます",-1)),l("button",{class:"link-btn",type:"button",disabled:U.value,onClick:Z},[e[21]||(e[21]=l("span",{class:"i-lucide-credit-card"},null,-1)),X(" "+m(U.value?"接続中…":"Stripe収款を連携"),1)],8,Ge)])]),w(l("textarea",{"onUpdate:modelValue":e[5]||(e[5]=o=>t.description=o),rows:"6",placeholder:"社群のビジョン・活動内容・歓迎する人などを記載してください。"},null,512),[[k,t.description]]),y.value?(d(),r("p",Je,[e[24]||(e[24]=X(" リンクを開けない場合はこちら: ",-1)),l("a",{href:y.value,target:"_blank"},"Stripe Onboard",8,Ke)])):V("",!0)]),p.value?(d(),r("p",Qe,m(p.value),1)):V("",!0)],32),l("footer",Ze,[l("button",{type:"button",class:"ghost-btn",disabled:f.value,onClick:e[6]||(e[6]=o=>W(M).back())},"戻る",8,el),l("button",{type:"button",class:"primary-btn",disabled:f.value,onClick:R},m(f.value?"保存中…":"保存する"),9,ll)])])],64))}}),nl=ye(sl,[["__scopeId","data-v-6b8cd0ca"]]);export{nl as default};
