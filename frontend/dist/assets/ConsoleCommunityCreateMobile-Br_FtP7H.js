import{d as te,a7 as ne,c as B,B as ie,C as re,r as c,o as ue,e as d,A as ce,i as e,t as m,w as de,j as O,x as I,y as x,F as D,h as X,L as ve,a9 as pe,b,ab as F,ac as Y,ad as me,u as ge,f as v,_ as fe}from"./index-DncFUGrq.js";import{P as be}from"./PageMarker-B9WMY3Nd.js";const ye={class:"community-form"},he={class:"hero-card"},we={class:"hero-text"},Ue={class:"hero-eyebrow"},Ce={class:"hero-status"},_e={class:"form-card"},Ie={class:"ios-field"},ke={class:"ios-field"},Le=["disabled"],xe={class:"form-card"},Fe={class:"ios-field"},Me={key:0,class:"chip-row"},Ae={class:"form-card"},Pe={class:"radio-group"},Ee=["value"],Ve={class:"radio-content"},Be={class:"radio-title"},De={class:"radio-desc"},Se={class:"form-card"},je={class:"upload-grid"},Ne={class:"upload-card"},Re={key:0,class:"upload-preview"},Te=["src"],He={key:1,class:"upload-empty"},qe={class:"upload-card"},We={key:0,class:"upload-preview"},$e=["src"],ze={key:1,class:"upload-empty"},Ge={class:"form-card"},Oe={key:0,class:"form-error"},Xe={class:"form-footer"},Ye=["disabled"],Je=te({__name:"ConsoleCommunityCreateMobile",setup(Ke){const J=ie(),S=ge(),y=ne(),r=B(()=>J.params.communityId),p=B(()=>!!r.value),o=re({name:"",slug:"",labels:"",visibleLevel:"public",coverImageUrl:"",logoImageUrl:"",description:""}),j=c(null),N=c(null),g=c(null),f=c(null),M=c(!1),A=c(!1),h=c(null),w=c(null),k=c(!1),U=c(null),K=[{value:"public",label:"公開",desc:"誰でも閲覧できる"},{value:"semi-public",label:"社群内公開",desc:"Console / 既存メンバーのみ"},{value:"private",label:"非公開",desc:"運営メモ用・外部非公開"}],P=B(()=>o.labels.split(",").map(s=>s.trim()).filter(Boolean)),Q=async()=>{if(r.value)try{const s=await pe(r.value);o.name=s.name,o.slug=s.slug,o.visibleLevel=s.visibleLevel||"public",o.labels=(s.labels||[]).join(", "),o.coverImageUrl=s.coverImageUrl||"",f.value=o.coverImageUrl?b(o.coverImageUrl):null;const l=typeof s.description=="object"&&s.description?s.description:null;o.description=(l==null?void 0:l.original)??"",o.logoImageUrl=(l==null?void 0:l.logoImageUrl)??"",g.value=o.logoImageUrl?b(o.logoImageUrl):null}catch(s){U.value=s instanceof Error?s.message:"読み込みに失敗しました"}},R=()=>({original:o.description,lang:"ja",translations:{},logoImageUrl:o.logoImageUrl||null}),Z=()=>{var s;(s=j.value)==null||s.click()},ee=()=>{var s;(s=N.value)==null||s.click()},T=(s,l,a)=>new Promise((t,n)=>{const u=new FileReader;u.onload=()=>{const i=new Image;i.onload=()=>{const{width:$,height:E}=i;let C=$,_=C/l;_>E&&(_=E,C=_*l);const ae=($-C)/2,se=(E-_)/2,V=Math.min(a,C),z=V/l,L=document.createElement("canvas");L.width=V,L.height=z;const G=L.getContext("2d");if(!G){n(new Error("Canvas not supported"));return}G.drawImage(i,ae,se,C,_,0,0,V,z),t(L.toDataURL("image/jpeg",.85))},i.onerror=()=>n(new Error("Failed to load image")),i.src=u.result},u.onerror=()=>n(new Error("Failed to read file")),u.readAsDataURL(s)}),H=async(s,l)=>{const t=await(await fetch(s)).blob();return new File([t],l,{type:t.type||"image/jpeg"})},le=async s=>{var t;const a=(t=s.target.files)==null?void 0:t[0];if(!(!a||M.value)){M.value=!0;try{const n=await T(a,1,512);g.value=n;const u=await H(n,`logo-${Date.now()}.jpg`);if(p.value&&r.value){const{imageUrl:i}=await F(r.value,u,"logo");o.logoImageUrl=i,g.value=b(i),h.value=null}else h.value=u,o.logoImageUrl=""}catch(n){console.warn(n)}finally{M.value=!1}}},oe=async s=>{var t;const a=(t=s.target.files)==null?void 0:t[0];if(!(!a||A.value)){A.value=!0;try{const n=await T(a,1.7777777777777777,1280);f.value=n;const u=await H(n,`cover-${Date.now()}.jpg`);if(p.value&&r.value){const{imageUrl:i}=await F(r.value,u,"cover");o.coverImageUrl=i,f.value=b(i),w.value=null}else w.value=u,o.coverImageUrl=""}catch(n){console.warn(n)}finally{A.value=!1}}},q=async()=>{k.value=!0,U.value=null;const s={name:o.name,slug:o.slug,labels:P.value,visibleLevel:o.visibleLevel,coverImageUrl:p.value&&o.coverImageUrl||null,logoImageUrl:p.value&&o.logoImageUrl||null,description:R()},l=async a=>{const t={};if(w.value){const{imageUrl:n}=await F(a,w.value,"cover");o.coverImageUrl=n,f.value=b(n),w.value=null,t.coverImageUrl=n}if(h.value){const{imageUrl:n}=await F(a,h.value,"logo");o.logoImageUrl=n,g.value=b(n),h.value=null,t.logoImageUrl=n}Object.keys(t).length&&(t.description=R(),await Y(a,t))};try{if(p.value&&r.value)await Y(r.value,s),await l(r.value),await y.loadCommunities(!0),y.refreshActiveCommunity();else{const a=await me({...s,coverImageUrl:null,logoImageUrl:null}),t=a==null?void 0:a.id;t?(await l(t),await y.loadCommunities(!0),y.setActiveCommunity(t)):await y.loadCommunities(!0)}S.replace({name:"ConsoleMobileHome"})}catch(a){U.value=a instanceof Error?a.message:"保存に失敗しました"}finally{k.value=!1}},W=()=>{S.back()};return ue(Q),(s,l)=>(v(),d(D,null,[ce(be,{label:"P2"}),e("div",ye,[e("header",he,[e("button",{class:"hero-back",type:"button",onClick:W},[...l[5]||(l[5]=[e("span",{class:"i-lucide-chevron-left"},null,-1)])]),e("div",we,[e("p",Ue,m(p.value?"社群設定":"新しい社群"),1),e("h1",null,m(p.value?"社群資料を更新":"社群を登録"),1),l[6]||(l[6]=e("p",{class:"hero-subtext"}," AI が社群情報を参照しながら活動助手を最適化します。ベーシックな情報から入力しましょう。 ",-1))]),e("span",Ce,m(p.value?"編集中":"草稿"),1)]),e("form",{class:"form-sections",onSubmit:de(q,["prevent"])},[e("section",_e,[l[9]||(l[9]=e("p",{class:"card-label"},"基本情報",-1)),e("div",Ie,[l[7]||(l[7]=e("label",null,"社群名称",-1)),I(e("input",{"onUpdate:modelValue":l[0]||(l[0]=a=>o.name=a),type:"text",placeholder:"Tokyo Community...",required:""},null,512),[[x,o.name]])]),e("div",ke,[l[8]||(l[8]=e("label",null,"Slug",-1)),I(e("input",{"onUpdate:modelValue":l[1]||(l[1]=a=>o.slug=a),type:"text",disabled:p.value,placeholder:"tokyo-community",required:""},null,8,Le),[[x,o.slug]])])]),e("section",xe,[l[11]||(l[11]=e("div",{class:"card-head"},[e("p",{class:"card-label"},"ラベル"),e("p",{class:"card-hint"},"カンマ区切りで入力 / ワンタップで編集")],-1)),e("div",Fe,[l[10]||(l[10]=e("label",null,"キーワード",-1)),I(e("input",{"onUpdate:modelValue":l[2]||(l[2]=a=>o.labels=a),type:"text",placeholder:"親子, 多文化, NPO"},null,512),[[x,o.labels]])]),P.value.length?(v(),d("div",Me,[(v(!0),d(D,null,X(P.value,a=>(v(),d("span",{key:a,class:"chip"},m(a),1))),128))])):O("",!0)]),e("section",Ae,[l[12]||(l[12]=e("div",{class:"card-head"},[e("p",{class:"card-label"},"公開範囲"),e("p",{class:"card-hint"},"ユーザー側にどこまで公開するかを決めます")],-1)),e("div",Pe,[(v(),d(D,null,X(K,a=>e("label",{key:a.value,class:"radio-tile"},[I(e("input",{"onUpdate:modelValue":l[3]||(l[3]=t=>o.visibleLevel=t),value:a.value,type:"radio"},null,8,Ee),[[ve,o.visibleLevel]]),e("div",Ve,[e("p",Be,m(a.label),1),e("p",De,m(a.desc),1)])])),64))])]),e("section",Se,[l[17]||(l[17]=e("p",{class:"card-label"},"ビジュアル",-1)),e("div",je,[e("div",Ne,[l[14]||(l[14]=e("p",{class:"upload-title"},"ロゴ画像",-1)),e("div",{class:"upload-drop",onClick:Z},[e("input",{ref_key:"logoInput",ref:j,type:"file",accept:"image/*",class:"hidden-input",onChange:le},null,544),g.value?(v(),d("div",Re,[e("img",{src:g.value,alt:"logo preview"},null,8,Te)])):(v(),d("div",He,[...l[13]||(l[13]=[e("span",{class:"i-lucide-image-plus"},null,-1),e("p",null,"タップしてアップロード",-1)])]))])]),e("div",qe,[l[16]||(l[16]=e("p",{class:"upload-title"},"カバー画像",-1)),e("div",{class:"upload-drop",onClick:ee},[e("input",{ref_key:"coverInput",ref:N,type:"file",accept:"image/*",class:"hidden-input",onChange:oe},null,544),f.value?(v(),d("div",We,[e("img",{src:f.value,alt:"cover preview"},null,8,$e)])):(v(),d("div",ze,[...l[15]||(l[15]=[e("span",{class:"i-lucide-image-plus"},null,-1),e("p",null,"タップしてアップロード",-1)])]))])])])]),e("section",Ge,[l[18]||(l[18]=e("div",{class:"card-head"},[e("p",{class:"card-label"},"紹介文"),e("p",{class:"card-hint"},"AI に渡る原稿です。ミッション・活動内容・対象者などを書きましょう。")],-1)),I(e("textarea",{"onUpdate:modelValue":l[4]||(l[4]=a=>o.description=a),rows:"6",placeholder:"例：Tokyo Community Organizations Meetup Group は..."},null,512),[[x,o.description]])]),U.value?(v(),d("p",Oe,m(U.value),1)):O("",!0)],32),e("footer",Xe,[e("button",{type:"button",class:"ghost-btn",onClick:W},"キャンセル"),e("button",{type:"button",class:"primary-btn",disabled:k.value,onClick:q},m(k.value?"保存中…":"保存する"),9,Ye)])])],64))}}),el=fe(Je,[["__scopeId","data-v-a457d54b"]]);export{el as default};
