import{d as Ne,l as Re,c as r,A as He,r as s,C as oe,o as Ve,a0 as We,b as i,h as t,p as De,i as d,y as ne,t as o,z as ue,s as ce,w as ie,n as ve,v as de,x as pe,a1 as me,a2 as $e,u as Oe,a3 as Xe,a4 as Ye,a5 as qe,e as n,_ as Ge}from"./index-CT-XDF2b.js";const ze="data:image/svg+xml,%3csvg%20width='420'%20height='420'%20viewBox='0%200%20420%20420'%20fill='none'%20xmlns='http://www.w3.org/2000/svg'%3e%3cdefs%3e%3clinearGradient%20id='bgGradient'%20x1='0'%20y1='0'%20x2='1'%20y2='1'%3e%3cstop%20offset='0%25'%20stop-color='%23FFF4E6'%20/%3e%3cstop%20offset='60%25'%20stop-color='%23FFD9B2'%20/%3e%3cstop%20offset='100%25'%20stop-color='%23FFBA78'%20/%3e%3c/linearGradient%3e%3c/defs%3e%3crect%20width='420'%20height='420'%20rx='210'%20fill='url(%23bgGradient)'%20/%3e%3ccircle%20cx='135'%20cy='110'%20r='36'%20fill='rgba(255,255,255,0.45)'%20/%3e%3ccircle%20cx='300'%20cy='105'%20r='32'%20fill='rgba(255,255,255,0.35)'%20/%3e%3cpath%20d='M80%20320C120%20255%20300%20255%20340%20320V410H80V320Z'%20fill='rgba(255,255,255,0.4)'%20/%3e%3cg%20transform='translate(120%20150)'%3e%3crect%20x='0'%20y='0'%20width='90'%20height='130'%20rx='24'%20fill='%23FFFFFF'%20opacity='0.95'%20/%3e%3crect%20x='120'%20y='0'%20width='90'%20height='130'%20rx='24'%20fill='%23FFFFFF'%20opacity='0.95'%20/%3e%3cpath%20d='M0%2075H210'%20stroke='%23F39B55'%20stroke-width='20'%20stroke-linecap='round'%20/%3e%3ccircle%20cx='45'%20cy='52'%20r='20'%20fill='%23F39B55'%20/%3e%3ccircle%20cx='165'%20cy='52'%20r='20'%20fill='%23F39B55'%20/%3e%3c/g%3e%3c/svg%3e",Le={class:"setup-page"},je={class:"setup-scene"},Ze={class:"avatar-area"},Je=["disabled"],Ke=["src"],Qe={key:0,class:"status"},ea={class:"name-block"},aa={key:0,class:"status name-status"},ta={key:0,class:"user-id-block"},la={class:"user-id-chip"},sa={class:"chip-text"},ra={class:"setup-actions"},oa=["disabled"],na={key:0,class:"setup-overlay"},ua={class:"setup-overlay__panel"},ca={class:"cropper-image-base"},ia=["src"],va={class:"slider-row"},da={class:"overlay-actions"},pa=["disabled"],ma={key:0,class:"setup-overlay"},fa={class:"setup-overlay__panel"},ha={key:0,class:"status"},ya={class:"overlay-actions"},ga=["disabled"],m=280,H=720,xa=Ne({__name:"SetupProfile",setup(_a){var se;const V=He(),W=Oe(),{user:v,fetchCurrentUser:fe,setUserProfile:Z}=Re(),M=r(()=>V.query.mode||"dev"),J=r(()=>{const e=V.query.redirect;return e&&e.startsWith("/")?e:"/"}),K=r(()=>M.value!=="dev"),Q=r(()=>M.value==="email"),he=r(()=>M.value==="email"),ye=r(()=>M.value==="dev"),ee=s(null),u=s(((se=v.value)==null?void 0:se.name)??""),y=s(""),S=s(!1),I=s(!1),P=s(""),g=s(""),ae=s(null),x=s(""),f=s(!1),B=s(!1);r(()=>{var a,l;return(((a=u.value)==null?void 0:a.trim())||((l=v.value)==null?void 0:l.email)||"M").charAt(0).toUpperCase()||"M"});const ge=r(()=>{var e;return(e=v.value)!=null&&e.avatarUrl?v.value.avatarUrl:ze}),te=r(()=>ge.value),D=r(()=>{var e;return!!((e=v.value)!=null&&e.avatarUrl)});oe(()=>{var e;return(e=v.value)==null?void 0:e.name},e=>{I.value||(u.value=e??"")},{immediate:!0}),oe(()=>{var e;return(e=v.value)==null?void 0:e.avatarUrl},()=>{x.value=""});const T=()=>{v.value||W.replace({name:"auth-login",query:{redirect:V.fullPath}})},xe=()=>{var e;T(),(e=ee.value)==null||e.click()},b=s(null),w=s(null),h=s(1.2),c=s({x:0,y:0}),U=s(0),A=s(0),k=s(!1),C=s(!1),$=s({x:0,y:0}),O=s({x:0,y:0}),_e=r(()=>({width:`${U.value}px`,height:`${A.value}px`,transform:`translate(${c.value.x}px, ${c.value.y}px)`})),be=r(()=>({width:`${U.value}px`,height:`${A.value}px`,transform:`scale(${h.value})`})),we=e=>{var E;const a=e.target,l=(E=a==null?void 0:a.files)==null?void 0:E[0];if(!l)return;const p=new FileReader;p.onload=()=>{const _=p.result;ke(_)},p.readAsDataURL(l),a&&(a.value="")},ke=e=>{const a=new Image;a.onload=()=>{b.value=e,w.value=a;const l=Math.max(m/a.naturalWidth,m/a.naturalHeight);U.value=a.naturalWidth*l,A.value=a.naturalHeight*l,h.value=1.2,c.value={x:0,y:0},X(),k.value=!0},a.src=e},Ce=e=>{var a;k.value&&(C.value=!0,$.value={x:e.clientX,y:e.clientY},O.value={...c.value},(a=e.currentTarget)==null||a.setPointerCapture(e.pointerId))},Fe=e=>{if(!C.value)return;const a=e.clientX-$.value.x,l=e.clientY-$.value.y;c.value={x:O.value.x+a,y:O.value.y+l},X()},le=e=>{var a;C.value&&(C.value=!1,(a=e.currentTarget)==null||a.releasePointerCapture(e.pointerId))},X=()=>{const e=Math.max(0,(U.value*h.value-m)/2),a=Math.max(0,(A.value*h.value-m)/2);c.value={x:Math.min(e,Math.max(-e,c.value.x)),y:Math.min(a,Math.max(-a,c.value.y))}},Ee=()=>{k.value=!1,b.value=null,w.value=null},Me=async()=>{if(w.value){f.value=!0;try{const e=await Se(),a=new File([e],"avatar.jpg",{type:e.type||"image/jpeg"}),l=await Xe(a);Z(l),x.value="",k.value=!1,b.value=null,w.value=null}catch(e){x.value=e instanceof Error?e.message:"上传失败"}finally{f.value=!1}}},Se=()=>new Promise((e,a)=>{const l=w.value;if(!l){a(new Error("No image to crop"));return}const p=document.createElement("canvas");p.width=H,p.height=H;const E=p.getContext("2d");if(!E){a(new Error("无法创建画布"));return}const _=Math.max(m/l.naturalWidth,m/l.naturalHeight)*h.value,G=m/_,z=m/_,Ue=l.naturalWidth/2-c.value.x/_,Ae=l.naturalHeight/2-c.value.y/_;let L=Ue-G/2,j=Ae-z/2;L=Math.max(0,Math.min(l.naturalWidth-G,L)),j=Math.max(0,Math.min(l.naturalHeight-z,j)),E.drawImage(l,L,j,G,z,0,0,H,H),p.toBlob(re=>{re?e(re):a(new Error("截取失败"))},"image/jpeg",.92)}),Y=()=>{T(),K.value&&(P.value=u.value,g.value="",I.value=!0,Ye(()=>{var e;(e=ae.value)==null||e.focus()}))},N=()=>{I.value=!1,g.value=""},Ie=async()=>{if(!K.value){N();return}const e=P.value.trim();if(!e){g.value="请输入昵称";return}if(e===u.value){N();return}S.value=!0;try{const a=await qe({name:e});Z(a),u.value=a.name||"",y.value="",N()}catch(a){g.value=a instanceof Error?a.message:"保存失败"}finally{S.value=!1}},Pe=async()=>{if(T(),he.value&&!D.value){x.value="请先添加头像";return}if(Q.value&&!u.value.trim()){y.value="请输入昵称",Y();return}B.value=!0;try{await fe(),await W.replace(J.value)}catch(e){y.value=e instanceof Error?e.message:"保存失败"}finally{B.value=!1}},Be=()=>{W.replace(J.value)},R=r(()=>{var e;return((e=v.value)==null?void 0:e.id)||""}),q=s(!1);let F=null;const Te=async()=>{if(R.value)try{await navigator.clipboard.writeText(R.value),q.value=!0,F&&clearTimeout(F),F=setTimeout(()=>{q.value=!1},1500)}catch(e){console.error("Failed to copy user id",e)}};return Ve(()=>{T(),!u.value&&Q.value&&(y.value="请输入昵称")}),We(()=>{C.value=!1,F&&clearTimeout(F)}),(e,a)=>(n(),i("div",Le,[t("div",je,[t("div",Ze,[t("button",{type:"button",class:"avatar-circle",disabled:f.value,onClick:xe},[te.value?(n(),i("img",{key:0,src:te.value,alt:"avatar",class:"avatar-image"},null,8,Ke)):d("",!0),t("div",{class:ne(["avatar-overlay-cta",{"avatar-overlay-cta--visible":f.value||!D.value}])},[a[2]||(a[2]=t("span",{class:"i-lucide-camera"},null,-1)),t("span",null,o(f.value?"上传中...":D.value?"点击更换":"点击添加头像"),1)],2)],8,Je),x.value?(n(),i("p",Qe,o(x.value),1)):d("",!0)]),t("div",ea,[t("p",{class:ne(["name-text",{"name-text--placeholder":!u.value}]),onClick:Y},o(u.value||"请设置昵称"),3),t("button",{type:"button",class:"name-edit",onClick:Y},o(u.value?"修改昵称":"设置昵称"),1),y.value?(n(),i("p",aa,o(y.value),1)):d("",!0)]),R.value?(n(),i("div",ta,[a[4]||(a[4]=t("p",{class:"user-id-label"},"你的编号",-1)),t("div",la,[a[3]||(a[3]=t("span",{class:"i-lucide-hash"},null,-1)),t("span",sa,o(R.value),1),t("button",{type:"button",onClick:Te},o(q.value?"已复制":"复制"),1)])])):d("",!0)]),t("div",ra,[t("button",{type:"button",class:"confirm-btn",disabled:B.value,onClick:Pe},o(B.value?"处理中...":"我确定了"),9,oa),ye.value?(n(),i("button",{key:0,type:"button",class:"skip-btn",onClick:Be},"暂不设置")):d("",!0)]),t("input",{ref_key:"fileInput",ref:ee,type:"file",accept:"image/*",class:"sr-only",onChange:we},null,544),(n(),De($e,{to:"body"},[ue(me,{name:"fade"},{default:ce(()=>[k.value?(n(),i("div",na,[t("div",ua,[a[6]||(a[6]=t("p",{class:"overlay-title"},"截取头像",-1)),t("div",{class:"cropper-viewport",onPointerdown:ie(Ce,["prevent"]),onPointermove:ie(Fe,["prevent"]),onPointerup:le,onPointerleave:le},[t("div",ca,[t("div",{class:"cropper-image-shift",style:ve(_e.value)},[b.value?(n(),i("img",{key:0,src:b.value,style:ve(be.value),draggable:"false"},null,12,ia)):d("",!0)],4)]),a[5]||(a[5]=t("div",{class:"cropper-mask"},null,-1))],32),t("div",va,[de(t("input",{type:"range",min:"1",max:"3",step:"0.01","onUpdate:modelValue":a[0]||(a[0]=l=>h.value=l),onInput:X},null,544),[[pe,h.value,void 0,{number:!0}]])]),t("div",da,[t("button",{type:"button",class:"ghost",onClick:Ee},"取消"),t("button",{type:"button",class:"primary",disabled:f.value,onClick:Me},o(f.value?"上传中...":"使用此头像"),9,pa)])])])):d("",!0)]),_:1}),ue(me,{name:"fade"},{default:ce(()=>[I.value?(n(),i("div",ma,[t("div",fa,[a[7]||(a[7]=t("p",{class:"overlay-title"},"输入昵称",-1)),de(t("input",{ref_key:"nameInput",ref:ae,"onUpdate:modelValue":a[1]||(a[1]=l=>P.value=l),type:"text",maxlength:"40",placeholder:"请输入昵称"},null,512),[[pe,P.value]]),g.value?(n(),i("p",ha,o(g.value),1)):d("",!0),t("div",ya,[t("button",{type:"button",class:"ghost",onClick:N},"取消"),t("button",{type:"button",class:"primary",disabled:S.value,onClick:Ie},o(S.value?"保存中...":"完成"),9,ga)])])])):d("",!0)]),_:1})]))]))}}),wa=Ge(xa,[["__scopeId","data-v-3eda36ec"]]);export{wa as default};
