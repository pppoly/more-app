import{d as Y,B as W,r as m,c as Z,e as c,A as Q,i,j as h,t as I,s as ee,F as te,h as ne,am as P,an as se,u as oe,f as u,x as ae,y as ie,_ as re}from"./index-D9GuT0xz.js";import{P as le}from"./PageMarker-CiSmMvmB.js";const ce={class:"note-editor"},ue={class:"note-editor__nav"},de={class:"note-editor__meta"},pe={class:"note-editor__blocks"},fe={key:0,class:"note-block__actions"},ve=["onClick"],me={key:1,class:"note-block__actions"},ge=["onClick"],_e=["onUpdate:modelValue","placeholder","data-block-id","onFocus","onClick","onKeyup","onInput"],he={key:3,class:"note-image"},ye=["src"],xe=["onClick"],Ie={key:4,class:"note-block__actions"},ke=["onClick"],Ce={key:5,class:"note-block__actions"},be=["onClick"],Ee={key:0,class:"note-editor__status"},A=9,Be=5*1024*1024,Se=Y({__name:"ConsoleEventNoteEditorMobile",setup(Ne){const C=oe(),b=W(),E=b.params.communityId,B=b.query.eventId,f=(()=>{try{const e=sessionStorage.getItem(P);return e?(sessionStorage.removeItem(P),JSON.parse(e)):{}}catch{return{}}})(),a=m([]),d=m(""),y=m(!1),S=m(null),k=m({}),g=m({blockId:null,position:"after"}),F=new Intl.DateTimeFormat("ja-JP",{month:"long",day:"numeric",weekday:"short"}).format(new Date),$=Z(()=>a.value.filter(e=>e.type==="text").reduce((e,n)=>e+n.value.trim().length,0)),p=(e="")=>({id:`text-${Date.now()}-${Math.random().toString(36).slice(2)}`,type:"text",value:e}),v=e=>({id:`image-${Date.now()}-${Math.random().toString(36).slice(2)}`,type:"image",src:e}),_=()=>{if(!a.value.length){a.value.push(p());return}a.value.every(e=>e.type==="image")&&a.value.unshift(p())},D=e=>{if(typeof window>"u"||typeof window.DOMParser>"u")return[];try{const t=new DOMParser().parseFromString(e,"text/html"),s=[];return t.body.childNodes.forEach(o=>{var r;if(o.nodeName==="P"){const J=o.innerHTML.replace(/<br\s*\/?>/gi,`
`).replace(/<[^>]+>/g,"");s.push(p(J))}else if(o.nodeName==="FIGURE"){const l=o.querySelector("img");l!=null&&l.getAttribute("src")&&s.push(v(l.getAttribute("src")))}else if(o.nodeName==="#text"){const l=(r=o.textContent)==null?void 0:r.trim();l&&s.push(p(l))}}),s.filter(o=>o.type==="text"?o.value.trim().length>0:!!o.src)}catch{return[]}};(()=>{let e=[];f.html?e=D(f.html):f.text&&(e=[p(f.text)]),e.length||(e=[p()]),f.images&&f.images.length&&!e.some(n=>n.type==="image")&&f.images.forEach(n=>{e.push(v(n.src))}),a.value=e,_()})();const x=(e,n)=>{var s;const t=n.target;k.value={...k.value,[e]:t.selectionStart??((s=t.value)==null?void 0:s.length)??0}},N=(e,n="after")=>{var t;if(g.value={blockId:e,position:n},a.value.filter(s=>s.type==="image").length>=A){d.value="最多上传 9 张图片";return}(t=S.value)==null||t.click()},R=e=>new Promise((n,t)=>{const s=new FileReader;s.onload=()=>n(s.result),s.onerror=t,s.readAsDataURL(e)}),L=async e=>{var r;const n=e.target;if(!n.files)return;const t=a.value.filter(l=>l.type==="image").length,s=A-t;if(s<=0){d.value="最多上传 9 张图片",n.value="";return}const o=Array.from(n.files).slice(0,s);for(const l of o){if(!((r=l.type)!=null&&r.startsWith("image/"))){d.value="仅支持上传图片文件";continue}if(l.size>Be){d.value="图片过大，请压缩后再试";continue}try{const O=await R(l);U(O),d.value=""}catch{d.value="图片读取失败，请重试"}}n.value=""},V=e=>{const n=a.value[e];if(!n||n.type!=="text")return{insertIndex:e,trailingBlock:null};const t=k.value[n.id]??n.value.length;if(t<=0||t>=n.value.length)return{insertIndex:e,trailingBlock:null};const s=n.value.slice(0,t),o=n.value.slice(t);n.value=s;const r=p(o);return a.value.splice(e+1,0,r),{insertIndex:e,trailingBlock:r}},U=e=>{const n=g.value;if(!n.blockId){const s=n.position==="before"?0:a.value.length;a.value.splice(s,0,v(e)),_(),g.value={blockId:null,position:"after"};return}const t=a.value.findIndex(s=>s.id===n.blockId);if(t===-1){a.value.push(v(e)),_(),g.value={blockId:null,position:"after"};return}if(a.value[t].type==="text"){const{insertIndex:s,trailingBlock:o}=V(t);let r=s+(n.position==="before"?0:1);o&&n.position==="after"&&(r+=1),a.value.splice(r,0,v(e))}else{const s=n.position==="before"?t:t+1;a.value.splice(s,0,v(e))}_(),g.value={blockId:null,position:"after"}},T=(e,n)=>{const t=p();if(!e){const r=n==="before"?0:a.value.length;a.value.splice(r,0,t);return}const s=a.value.findIndex(r=>r.id===e);if(s===-1){a.value.splice(n==="before"?0:a.value.length,0,t);return}const o=n==="before"?s:s+1;a.value.splice(o,0,t)},j=e=>{a.value=a.value.filter(n=>n.id!==e),_()},w=(e,n,t)=>{if(e.type==="text"){const s=n==="before"?a.value[t-1]:a.value[t+1];if((s==null?void 0:s.type)==="image")return!1}return!0},H=e=>e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"),K=()=>a.value.map(e=>{if(e.type==="text"){const n=e.value.split(/\n{2,}/).map(t=>t.trim()).filter(Boolean);return n.length?n.map(t=>`<p>${H(t).replace(/\n/g,"<br />")}</p>`).join(""):""}return e.src?`<figure class="note-image"><img src="${e.src}" alt="活动详情图片" /></figure>`:""}).filter(Boolean).join(""),X=()=>a.value.filter(e=>e.type==="text").map(e=>e.value.trim()).filter(Boolean).join(`

`),q=()=>a.value.filter(e=>e.type==="image").map(e=>({id:e.id,src:e.src})),M=()=>{if(!E){C.back();return}C.replace({name:"ConsoleMobileEventForm",params:{communityId:E},query:B?{eventId:B}:void 0})},z=()=>{M()},G=()=>{if(y.value)return;y.value=!0;const e={text:X(),html:K(),images:q()};sessionStorage.setItem(se,JSON.stringify(e)),y.value=!1,M()};return(e,n)=>(u(),c("section",ce,[Q(le,{label:"P5"}),i("header",ue,[i("button",{type:"button",class:"nav-btn ghost",onClick:z},"取消"),n[0]||(n[0]=i("p",null,"活动详情",-1)),i("button",{type:"button",class:"nav-btn primary",onClick:G},I(y.value?"保存中…":"完成"),1)]),i("div",de,[i("span",null,I(ee(F)),1),i("span",null,I($.value)+" 字",1)]),i("section",pe,[(u(!0),c(te,null,ne(a.value,(t,s)=>(u(),c("div",{key:t.id,class:"note-block"},[t.type==="text"&&w(t,"before",s)?(u(),c("div",fe,[i("button",{type:"button",class:"insert-btn ghost",onClick:o=>N(t.id,"before")}," ＋ 在这里插入图片 ",8,ve)])):h("",!0),t.type==="image"?(u(),c("div",me,[i("button",{type:"button",class:"insert-btn ghost",onClick:o=>T(t.id,"before")}," ＋ 在这里添加文字 ",8,ge)])):h("",!0),t.type==="text"?ae((u(),c("textarea",{key:2,"onUpdate:modelValue":o=>t.value=o,class:"note-textarea",placeholder:s===0?"像 iOS 备忘录一样，讲述你的活动故事…":"继续输入...","data-block-id":t.id,onFocus:o=>x(t.id,o),onClick:o=>x(t.id,o),onKeyup:o=>x(t.id,o),onInput:o=>x(t.id,o)},null,40,_e)),[[ie,t.value]]):(u(),c("div",he,[i("img",{src:t.src,alt:"note image"},null,8,ye),i("button",{type:"button",class:"note-photo__delete",onClick:o=>j(t.id)},"×",8,xe)])),t.type==="text"&&w(t,"after",s)?(u(),c("div",Ie,[i("button",{type:"button",class:"insert-btn ghost",onClick:o=>N(t.id,"after")}," ＋ 在这里插入图片 ",8,ke)])):h("",!0),t.type==="image"?(u(),c("div",Ce,[i("button",{type:"button",class:"insert-btn ghost",onClick:o=>T(t.id,"after")}," ＋ 在这里添加文字 ",8,be)])):h("",!0)]))),128))]),n[1]||(n[1]=i("p",{class:"note-editor__hint"},"尺寸 750×X，最多上传 9 张，默认第一张为详情页主图",-1)),d.value?(u(),c("p",Ee,I(d.value),1)):h("",!0),i("input",{ref_key:"fileInputRef",ref:S,type:"file",multiple:"",accept:"image/*",class:"hidden-input",onChange:L},null,544)]))}}),Pe=re(Se,[["__scopeId","data-v-cb01a61c"]]);export{Pe as default};
