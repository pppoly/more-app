import{d as U,a7 as X,r as f,c as I,o as K,e as i,F as M,i as s,j as S,h as $,t as p,w as H,k as J,z as R,au as Q,a9 as Y,u as Z,f as o,av as ee,a5 as te,_ as ne}from"./index-D9GuT0xz.js";var q="https://js.stripe.com/v3",ae=/^https:\/\/js\.stripe\.com\/v3\/?(\?.*)?$/;var se=function(){for(var n=document.querySelectorAll('script[src^="'.concat(q,'"]')),r=0;r<n.length;r++){var l=n[r];if(ae.test(l.src))return l}return null},V=function(n){var r="",l=document.createElement("script");l.src="".concat(q).concat(r);var e=document.head||document.body;if(!e)throw new Error("Expected document.body not to be null. Stripe.js requires a <body> element.");return e.appendChild(l),l},re=function(n,r){!n||!n._registerWrapper||n._registerWrapper({name:"stripe-js",version:"4.6.0",startTime:r})},k=null,P=null,L=null,le=function(n){return function(){n(new Error("Failed to load Stripe.js"))}},ie=function(n,r){return function(){window.Stripe?n(window.Stripe):r(new Error("Stripe.js not available"))}},oe=function(n){return k!==null?k:(k=new Promise(function(r,l){if(typeof window>"u"||typeof document>"u"){r(null);return}if(window.Stripe){r(window.Stripe);return}try{var e=se();if(!(e&&n)){if(!e)e=V(n);else if(e&&L!==null&&P!==null){var v;e.removeEventListener("load",L),e.removeEventListener("error",P),(v=e.parentNode)===null||v===void 0||v.removeChild(e),e=V(n)}}L=ie(r,l),P=le(l),e.addEventListener("load",L),e.addEventListener("error",P)}catch(m){l(m);return}}),k.catch(function(r){return k=null,Promise.reject(r)}))},ue=function(n,r,l){if(n===null)return null;var e=n.apply(void 0,r);return re(e,l),e},C,W=!1,G=function(){return C||(C=oe(null).catch(function(n){return C=null,Promise.reject(n)}),C)};Promise.resolve().then(function(){return G()}).catch(function(d){W||console.warn(d)});var ce=function(){for(var n=arguments.length,r=new Array(n),l=0;l<n;l++)r[l]=arguments[l];W=!0;var e=Date.now();return G().then(function(v){return ue(v,r,e)})};const de={class:"sub-header"},ve=["disabled"],me={key:0,class:"empty"},pe={key:1,class:"empty"},fe={key:2,class:"plan-list"},ye=["disabled","onClick"],he={class:"plan-head"},_e={class:"plan-name"},be={class:"plan-price"},we={key:0},Se={key:1},ge={key:0,class:"plan-badge"},Ee={class:"plan-meta"},ke={class:"plan-meta"},Ce={class:"plan-meta"},Pe={class:"plan-action"},Le={key:0,class:"loading"},je={key:1,class:"loading"},Fe={key:2,class:"current"},xe={key:3,class:"action-cta"},Ae={key:0,class:"empty"},Be={key:3,class:"error"},Ie={class:"payment-sheet"},Te={class:"pay-header"},Me={class:"pay-title"},Re=["disabled"],Ve={key:0,class:"pay-amount"},qe=["disabled"],We={key:0,class:"spinner"},Ge={key:1,class:"error"},Ne=U({__name:"SubscriptionMobile",setup(d){const n=X();Z();const r=f([]),l=f(!1),e=f(null),v=f(null),m=f(!1),h=f(null),_=f(null),j=f(null);let b=null,w=null,y=null;const g=I(()=>n.activeCommunityId.value),F=I(()=>{var t;return((t=n.getActiveCommunity())==null?void 0:t.pricingPlanId)??null}),T=async()=>{e.value=null,l.value=!0;try{r.value=await Q()}catch(t){e.value=t instanceof Error?t.message:"无法获取套餐列表"}finally{l.value=!1}},N=t=>{if(!t.features||typeof t.features!="object")return"基础支持";const a=Object.values(t.features).flat();return a.length?a.slice(0,3).join(" / "):"基础支持"},z=async t=>{var a;if(!(!g.value||v.value)){v.value=t,e.value=null;try{const u=await ee(g.value,t);if(u.clientSecret&&u.publishableKey)_.value=t,h.value=u.clientSecret,await D(u.clientSecret,u.publishableKey);else{if((a=x(t))!=null&&a.monthlyFee&&x(t).monthlyFee>0)throw new Error("支付配置缺失，请检查后端 Stripe publishable key");await E(),window.alert("已切换套餐")}}catch(u){e.value=u instanceof Error?u.message:"订阅失败"}finally{v.value=null}}},x=t=>r.value.find(a=>a.id===t),A=I(()=>_.value?x(_.value):null),E=async()=>{if(await n.loadCommunities(!0),g.value){const t=await Y(g.value).catch(()=>null);t!=null&&t.id&&n.setActiveCommunity(t.id)}await T()};K(async()=>{n.loaded.value||(await n.loadCommunities(),n.ensureActiveCommunity()),await T()});const D=async(t,a)=>{if(!a)throw new Error("缺少 Stripe publishable key");if(b=await ce(a),!b)throw new Error("Stripe 初始化失败");w=b.elements({clientSecret:t,appearance:{theme:"flat"}}),await te(),y&&y.unmount(),j.value&&(y=w.create("payment"),y.mount(j.value))},B=()=>{h.value=null,_.value=null,m.value=!1,y&&(y.unmount(),y=null),w=null,b=null},O=async()=>{if(!b||!w||!h.value){e.value="支付信息未准备好";return}m.value=!0,e.value=null;try{const{error:t}=await w.submit();if(t){e.value=t.message||"请检查支付信息后重试",m.value=!1;return}const{error:a,paymentIntent:u}=await b.confirmPayment({elements:w,clientSecret:h.value,redirect:"if_required",confirmParams:{}});if(a){e.value=a.message||"支付失败，请重试";return}if((u==null?void 0:u.status)==="succeeded"){await E(),B(),window.alert("支付完成，正在刷新套餐状态");return}if((u==null?void 0:u.status)==="processing"){window.alert("支付处理中，请稍后查看状态"),await E();return}window.alert("支付未完成，请重试"),await E()}catch(t){console.error("confirmPayment failed",t),e.value=t instanceof Error?t.message:"支付失败，请重试"}finally{m.value=!1}};return(t,a)=>{var u;return o(),i("div",{class:R(["subscription-page",{"subscription-page--payment":!!h.value}])},[h.value?(o(),i("div",{key:1,class:"payment-overlay",onClick:H(B,["self"])},[s("section",Ie,[s("header",Te,[a[5]||(a[5]=s("div",{class:"pay-handle"},null,-1)),s("div",Me,[a[3]||(a[3]=s("p",{class:"sub-label"},"支付确认",-1)),s("h1",null,p(((u=A.value)==null?void 0:u.name)||"套餐支付"),1)]),s("button",{class:"close-btn",type:"button",disabled:m.value,onClick:B},[...a[4]||(a[4]=[s("span",{class:"i-lucide-x"},null,-1)])],8,Re)]),A.value?(o(),i("div",Ve," ¥"+p(A.value.monthlyFee)+"/月 ",1)):S("",!0),a[7]||(a[7]=s("div",{class:"payment-tip"},"请在应用内完成支付，成功后自动开通套餐",-1)),s("div",{ref_key:"paymentElementContainer",ref:j,class:"payment-element"},null,512),s("button",{class:"pay-btn",type:"button",disabled:m.value,onClick:O},[m.value?(o(),i("span",We)):S("",!0),a[6]||(a[6]=J(" 确认并支付 ",-1))],8,qe),e.value?(o(),i("p",Ge,p(e.value),1)):S("",!0)])])):(o(),i(M,{key:0},[s("header",de,[a[1]||(a[1]=s("div",null,[s("p",{class:"sub-label"},"订阅计划"),s("h1",null,"选择你的收款能力")],-1)),s("button",{class:"refresh-btn",type:"button",onClick:E,disabled:l.value||m.value},[...a[0]||(a[0]=[s("span",{class:"i-lucide-refresh-ccw"},null,-1)])],8,ve)]),l.value?(o(),i("div",me,"加载中…")):g.value?(o(),i("div",fe,[(o(!0),i(M,null,$(r.value,c=>(o(),i("button",{key:c.id,class:R(["plan-card",{active:c.id===F.value,paying:_.value===c.id}]),type:"button",disabled:v.value===c.id||m.value,onClick:ze=>z(c.id)},[s("div",he,[s("div",null,[s("p",_e,p(c.name),1),s("p",be,[c.monthlyFee>0?(o(),i("span",we,"¥"+p(c.monthlyFee)+"/月",1)):(o(),i("span",Se,"免费"))])]),c.id===F.value?(o(),i("span",ge,"当前")):S("",!0)]),s("p",Ee,"手续费："+p(c.transactionFeePercent)+"% + ¥"+p(c.transactionFeeFixed),1),s("p",ke,"结算："+p(c.payoutSchedule),1),s("p",Ce,"功能："+p(N(c)),1),s("div",Pe,[v.value===c.id?(o(),i("span",Le,"处理中...")):_.value===c.id?(o(),i("span",je,"填写支付信息")):c.id===F.value?(o(),i("span",Fe,"已订阅")):(o(),i("span",xe,"开通"))])],10,ye))),128)),r.value.length?S("",!0):(o(),i("div",Ae,"暂无可选套餐"))])):(o(),i("div",pe,[...a[2]||(a[2]=[s("p",null,"请先选择一个社群再订阅套餐。",-1)])])),e.value?(o(),i("p",Be,p(e.value),1)):S("",!0)],64))],2)}}}),Oe=ne(Ne,[["__scopeId","data-v-352bc475"]]);export{Oe as default};
