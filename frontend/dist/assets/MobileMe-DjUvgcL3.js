import{d as Z,l as j,c as y,r as w,a as r,e as s,h as B,q as E,t as d,i as P,j as G,F as H,f as K,u as ee,z as te,X as se,b as i,w as ae,_ as oe}from"./index-OEpVzuiB.js";const ne={class:"mobile-me m-page"},re={class:"me-hero"},ie=["disabled"],ce={key:0,class:"me-hero__avatar-spinner"},le=["src"],ue={key:2},pe={class:"me-hero__info"},de={class:"me-hero__subtitle"},he={class:"me-hero__chips"},_e={key:0,class:"chip chip--success"},ve={key:1,class:"chip chip--ghost"},me={class:"service-form-group"},ge=["onSubmit"],fe={class:"service-form__body"},ye={class:"service-form__label"},we={class:"service-form__meta"},be={type:"submit",class:"service-form__submit"},ke=200*1024,Me=Z({__name:"MobileMe",setup(Ae){const c=ee(),S=te(),{user:l,setUserProfile:U}=j(),b=y(()=>!!l.value),q=y(()=>{var a;return!!((a=l.value)!=null&&a.isOrganizer)}),L=y(()=>{var a,e,o;return((o=(e=(a=l.value)==null?void 0:a.name)==null?void 0:e.charAt(0))==null?void 0:o.toUpperCase())??"M"}),T=y(()=>{var e;switch(((e=l.value)==null?void 0:e.language)??"ja"){case"zh":return"中文 / Chinese";case"en":return"English";default:return"日本語 / Japanese"}}),z=()=>{c.push({name:"my-events"})},V=()=>{c.push({name:"my-payments"})},D=()=>{c.push({name:"favorites"})},N=()=>{c.push({name:"MobileSettings"})},X=[{title:"参加したイベント",description:"予約・チケット",cta:"確認する",action:()=>z()},{title:"支払い履歴",description:"お支払い記録",cta:"見る",action:()=>V()},{title:"お気に入りイベント",description:"お気に入り",cta:"開く",action:()=>D()},{title:"設定",description:"アプリ環境",cta:"設定する",action:()=>N()}],O=()=>{b.value?c.push({path:"/me"}):c.push({name:"auth-login",query:{redirect:S.fullPath}})},I=w(null),g=w(!1),h=w(""),k=w("success"),R=()=>{var a;if(!b.value){c.push({name:"auth-login",query:{redirect:S.fullPath}});return}h.value="",(a=I.value)==null||a.click()},W=a=>new Promise((e,o)=>{const n=new FileReader;n.onload=()=>{const t=new Image;t.onload=()=>{const u=Math.min(t.width,t.height),J=(t.width-u)/2,Q=(t.height-u)/2,F=_=>{const v=document.createElement("canvas");v.width=_,v.height=_;const p=v.getContext("2d");return p?(p.drawImage(t,J,Q,u,u,0,0,_,_),v):null};(_=>new Promise((v,p)=>{let m=_,f=F(m);if(!f){p(new Error("Failed to init canvas"));return}const x=[.9,.8,.7,.6,.5,.4],M=A=>{if(!f){p(new Error("Failed to init canvas"));return}if(A>=x.length){if(m<=256){p(new Error("画像を圧縮できませんでした"));return}m=Math.floor(m*.85),f=F(m),M(0);return}f.toBlob(C=>{if(!C){p(new Error("画像変換に失敗しました"));return}if(C.size<=ke){const Y=new File([C],`avatar-${Date.now()}.jpg`,{type:"image/jpeg"});v(Y)}else M(A+1)},"image/jpeg",x[A])};M(0)}))(512).then(e).catch(o)},t.onerror=()=>o(new Error("画像の読み込みに失敗しました")),t.src=n.result},n.onerror=()=>o(new Error("画像を読み込めませんでした")),n.readAsDataURL(a)}),$=async a=>{var n;const e=a.target,o=(n=e.files)==null?void 0:n[0];if(o){g.value=!0,h.value="";try{const t=await W(o),u=await se(t);U(u),h.value="プロフィール写真を更新しました",k.value="success"}catch(t){console.error("Failed to upload avatar",t),h.value="写真の更新に失敗しました",k.value="error"}finally{g.value=!1,e&&(e.value="")}}};return(a,e)=>{var o,n;return i(),r("div",ne,[s("section",re,[s("button",{class:"me-hero__avatar",type:"button",onClick:R,disabled:g.value},[g.value?(i(),r("div",ce)):B("",!0),(o=E(l))!=null&&o.avatarUrl?(i(),r("img",{key:1,src:E(l).avatarUrl,alt:"user"},null,8,le)):(i(),r("span",ue,d(L.value),1))],8,ie),s("input",{ref_key:"avatarInput",ref:I,type:"file",accept:"image/*",class:"sr-only",onChange:$},null,544),s("div",pe,[s("p",de,d(b.value?T.value:"ようこそ"),1),s("button",{class:"me-hero__title",type:"button",onClick:O},d(((n=E(l))==null?void 0:n.name)||"ゲスト"),1),s("div",he,[q.value?(i(),r("span",_e,[...e[0]||(e[0]=[s("span",{class:"i-lucide-badge-check mr-1"},null,-1),P("主理人 ",-1)])])):(i(),r("span",ve,"ゲスト"))]),h.value?(i(),r("p",{key:0,class:G(["me-hero__status",k.value==="error"?"is-error":""])},d(h.value),3)):B("",!0)])]),e[2]||(e[2]=s("section",{class:"m-section-title"},"マイサービス",-1)),s("div",me,[(i(),r(H,null,K(X,t=>s("form",{key:t.title,class:"service-form",onSubmit:ae(u=>t.action(),["prevent"])},[s("div",fe,[s("p",ye,d(t.title),1),s("p",we,d(t.description),1)]),s("button",be,[P(d(t.cta)+" ",1),e[1]||(e[1]=s("span",{class:"i-lucide-arrow-right"},null,-1))])],40,ge)),64))])])}}}),Se=oe(Me,[["__scopeId","data-v-5c38523f"]]);export{Se as default};
