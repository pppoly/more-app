import{d as ae,l as le,r as g,B as P,c as b,A as oe,g as ne,C as re,o as ie,u as ue,b as i,h as l,i as k,q as ce,t as d,j as R,D as ve,F as C,f as A,v as I,O as de,y as pe,E as he,P as F,L as ye,Q as me,R as fe,e as u,I as _e,x as be,J as ke,K as ge,_ as Te}from"./index-BGcABSEi.js";const Ee={class:"mobile-register"},Ie={class:"register-header"},xe={class:"header-info"},Se={key:0,class:"register-skeleton"},Ce={key:1,class:"state-card state-card--error"},Ae={key:2,class:"register-body"},we={class:"hero-card"},Me={class:"hero-title"},Ve={class:"hero-meta"},De={class:"hero-meta"},Oe={class:"hero-price"},Re={key:0,class:"ios-notice"},Fe={class:"ios-panel"},Ne={class:"panel-head"},Ue={class:"badge"},$e={key:0,class:"ios-section"},Be={class:"ios-label"},Le={key:0,class:"required"},Pe={class:"ios-input"},qe=["type","placeholder","onUpdate:modelValue"],Je=["placeholder","onUpdate:modelValue"],je=["onUpdate:modelValue"],ze=["value"],Ke={key:3,class:"ios-choice"},Ye=["name","value","onUpdate:modelValue"],Ge={key:4,class:"ios-choice"},Qe=["checked","onChange"],He={key:5,class:"ios-checkbox"},We=["checked","onChange"],Xe={key:6,class:"ios-placeholder"},Ze={key:7,class:"ios-field-error"},et={class:"ios-consent"},tt={key:0},st={class:"ios-consent__row"},at={key:1,class:"ios-error"},lt={class:"ios-tabbar"},ot=["disabled"],nt=ae({__name:"MobileEventRegister",props:{eventId:{}},setup(q){const J=q,N=oe(),x=ue(),{user:U}=le(),v=g(null),w=g(!0),T=g(null),y=g(null),E=g(!1),S=g(!1),n=P({}),h=P({}),m=b(()=>J.eventId??N.params.eventId),M=new Intl.NumberFormat("ja-JP",{style:"currency",currency:"JPY",maximumFractionDigits:0}),j=e=>{var a;if(!((a=e==null?void 0:e.ticketTypes)!=null&&a.length))return"無料 / 未定";const t=e.ticketTypes.map(r=>r.price??0),o=Math.min(...t),s=Math.max(...t);return s===0?"無料":o===s?M.format(s):`${M.format(o)} 〜 ${M.format(s)}`},z=(e,t)=>{var o,s;if(me(e)){const a=(s=(o=e.response)==null?void 0:o.data)==null?void 0:s.message;if(typeof a=="string")return a;if(Array.isArray(a)&&a.length){const r=a[0];if(typeof r=="string")return r}return e.message}return e instanceof Error?e.message:t},p=b(()=>{var o;if(!v.value)return null;const e=L(v.value.startTime),t=v.value.endTime?L(v.value.endTime):"未定";return{id:v.value.id,title:ne(v.value.title),timeText:`${e} 〜 ${t}`,locationText:v.value.locationText||"場所未定",priceText:((o=v.value.config)==null?void 0:o.priceText)??j(v.value)}}),f=b(()=>{var e;return((e=v.value)==null?void 0:e.registrationFormSchema)??[]}),K=b(()=>{var t,o;if(!((o=(t=v.value)==null?void 0:t.ticketTypes)!=null&&o.length))return null;const e=v.value.ticketTypes.find(s=>(s.price??0)===0);return(e==null?void 0:e.id)??v.value.ticketTypes[0].id}),$=b(()=>{var e,t;return((t=(e=v.value)==null?void 0:e.ticketTypes)==null?void 0:t.some(o=>(o.price??0)>0&&o.type!=="free"))??!1}),_=b(()=>v.value?v.value.status!=="open"?"現在このイベントは申込受付を行っていません。":v.value.visibility&&!["public","community-only"].includes(v.value.visibility)?"公開範囲の制限により申し込みできません。":null:null),Y=b(()=>_.value?"受付終了":S.value?"処理中…":$.value?"情報を確認":"無料で申込む"),B=b(()=>!!_.value||!E.value||S.value),G=e=>p.value?{eventId:p.value.id,title:p.value.title,timeText:p.value.timeText,locationText:p.value.locationText,priceText:p.value.priceText,paymentStatus:e,holdExpiresAt:new Date().toISOString()}:null,Q=e=>{sessionStorage.setItem(fe,JSON.stringify(e)),x.replace({name:"MobileEventSuccess",params:{eventId:e.eventId}})},V=async()=>{if(!m.value){T.value="イベントが見つかりませんでした。";return}w.value=!0,T.value=null;try{v.value=await he(m.value),H(),W()}catch(e){T.value=e instanceof Error?e.message:"イベント情報の取得に失敗しました"}finally{w.value=!1}};re(()=>m.value,(e,t)=>{e&&e!==t&&U.value&&V()}),ie(()=>{if(!U.value){x.replace({name:"organizer-apply",query:{redirect:N.fullPath}});return}V()});const H=()=>{Object.keys(n).forEach(e=>delete n[e]),Object.keys(h).forEach(e=>delete h[e]),f.value.forEach((e,t)=>{const o=c(e,t);e.type==="checkbox"?n[o]=!1:e.type==="multiChoice"?n[o]=[]:n[o]="",h[o]=null}),E.value=!1},W=()=>{try{const e=sessionStorage.getItem(F);if(!e)return;const t=JSON.parse(e);if((t==null?void 0:t.eventId)!==m.value||!(t!=null&&t.answers))return;f.value.forEach((o,s)=>{const a=c(o,s);t.answers[a]!==void 0&&(n[a]=t.answers[a])})}catch{}},X=()=>{if(_.value){y.value=_.value;return}if(!ee())return;if(!E.value){y.value="個人情報の取扱いに関する同意が必要です。";return}if(!$.value){Z();return}const e={eventId:m.value,answers:{...n},savedAt:Date.now()};sessionStorage.setItem(F,JSON.stringify(e)),x.push({name:"MobileEventCheckout",params:{eventId:m.value}})},Z=async()=>{if(m.value){if(_.value){y.value=_.value;return}S.value=!0,y.value=null;try{await ye(m.value,{ticketTypeId:K.value??void 0,formAnswers:{...n}}),sessionStorage.removeItem(F);const e=G("free");e&&Q(e)}catch(e){y.value=z(e,"申込に失敗しました")}finally{S.value=!1}}},ee=()=>{y.value=null;let e=!0;return f.value.forEach((t,o)=>{const s=c(t,o),a=n[s];h[s]=null,t.required&&(t.type==="multiChoice"?(!Array.isArray(a)||!a.length)&&(h[s]=`${t.label} を入力してください`,e=!1):t.type==="checkbox"?a||(h[s]=`${t.label} を入力してください`,e=!1):a||(h[s]=`${t.label} を入力してください`,e=!1))}),e},c=(e,t)=>e.id??`${e.label??"field"}-${t}`,D=e=>Array.isArray(e.options)?e.options:[],te=(e,t,o,s)=>{const a=c(e,t);Array.isArray(n[a])||(n[a]=[]),s?n[a].includes(o)||n[a].push(o):n[a]=n[a].filter(r=>r!==o)},se=e=>{switch(e){case"email":return"email";case"phone":return"tel";case"number":return"number";case"date":return"date";default:return"text"}},L=e=>new Date(e).toLocaleDateString(void 0,{month:"short",day:"numeric",weekday:"short",hour:"2-digit"});return(e,t)=>{var o;return u(),i("div",Ee,[l("header",Ie,[l("button",{class:"back-button",type:"button",onClick:t[0]||(t[0]=s=>ce(x).back())},[...t[2]||(t[2]=[l("span",{class:"i-lucide-chevron-left text-lg"},null,-1)])]),l("div",xe,[t[3]||(t[3]=l("p",{class:"header-label"},"イベント申込",-1)),l("h1",null,d(((o=p.value)==null?void 0:o.title)??"読み込み中…"),1)])]),w.value?(u(),i("section",Se,[...t[4]||(t[4]=[l("div",{class:"skeleton-hero shimmer"},null,-1),l("div",{class:"skeleton-card shimmer"},null,-1),l("div",{class:"skeleton-card shimmer"},null,-1)])])):T.value?(u(),i("section",Ce,[R(d(T.value)+" ",1),l("button",{type:"button",class:"retry-btn",onClick:V},"再試行")])):p.value?(u(),i("section",Ae,[l("article",we,[t[5]||(t[5]=l("p",{class:"hero-label"},"対象イベント",-1)),l("h2",Me,d(p.value.title),1),l("p",Ve,d(p.value.timeText),1),l("p",De,d(p.value.locationText),1),l("p",Oe,d(p.value.priceText),1)]),_.value?(u(),i("p",Re,d(_.value),1)):k("",!0),l("article",Fe,[l("header",Ne,[t[6]||(t[6]=l("div",null,[l("p",{class:"panel-label"},"参加者情報")],-1)),l("span",Ue,d(f.value.length?`${f.value.length}項目`:"入力不要"),1)]),f.value.length?(u(),i("div",$e,[(u(!0),i(C,null,A(f.value,(s,a)=>(u(),i("div",{key:c(s,a),class:"ios-row"},[l("div",Be,[R(d(s.label)+" ",1),s.required?(u(),i("span",Le,"*")):k("",!0)]),l("div",Pe,[["text","email","phone","number","date"].includes(s.type)?I((u(),i("input",{key:0,type:se(s.type),placeholder:s.placeholder||"请输入...","onUpdate:modelValue":r=>n[c(s,a)]=r,class:"ios-input-control"},null,8,qe)),[[_e,n[c(s,a)]]]):s.type==="textarea"?I((u(),i("textarea",{key:1,rows:"3",placeholder:s.placeholder||"请输入...","onUpdate:modelValue":r=>n[c(s,a)]=r,class:"ios-input-control"},null,8,Je)),[[be,n[c(s,a)]]]):s.type==="select"?I((u(),i("select",{key:2,"onUpdate:modelValue":r=>n[c(s,a)]=r,class:"ios-input-control"},[t[7]||(t[7]=l("option",{value:""},"選択してください",-1)),(u(!0),i(C,null,A(D(s),r=>(u(),i("option",{key:r,value:r},d(r),9,ze))),128))],8,je)),[[ke,n[c(s,a)]]]):s.type==="singleChoice"?(u(),i("div",Ke,[(u(!0),i(C,null,A(D(s),r=>(u(),i("label",{key:r},[I(l("input",{type:"radio",name:c(s,a),value:r,"onUpdate:modelValue":O=>n[c(s,a)]=O},null,8,Ye),[[ge,n[c(s,a)]]]),l("span",null,d(r),1)]))),128))])):s.type==="multiChoice"?(u(),i("div",Ge,[(u(!0),i(C,null,A(D(s),r=>(u(),i("label",{key:r},[l("input",{type:"checkbox",checked:Array.isArray(n[c(s,a)])&&n[c(s,a)].includes(r),onChange:O=>te(s,a,r,O.target.checked)},null,40,Qe),l("span",null,d(r),1)]))),128))])):s.type==="checkbox"?(u(),i("label",He,[l("input",{type:"checkbox",checked:!!n[c(s,a)],onChange:r=>n[c(s,a)]=r.target.checked},null,40,We),l("span",null,d(s.label),1)])):(u(),i("p",Xe,"この項目は現在対応していません。")),h[c(s,a)]?(u(),i("p",Ze,d(h[c(s,a)]),1)):k("",!0)])]))),128))])):k("",!0),l("div",et,[f.value.length===0?(u(),i("p",tt,"このイベントでは追加情報の入力は必要ありません。")):k("",!0),t[9]||(t[9]=l("p",null," お客様の個人情報は、日本の個人情報保護法およびSOCIALMOREのプライバシーポリシーに基づき適切に管理します。 提供いただいた内容はイベント運営および緊急連絡の目的に限って利用されます。 ",-1)),l("label",st,[I(l("input",{type:"checkbox","onUpdate:modelValue":t[1]||(t[1]=s=>E.value=s)},null,512),[[de,E.value]]),t[8]||(t[8]=l("span",null,"上記内容に同意し、個人情報の取扱いに同意します。",-1))])])]),t[10]||(t[10]=ve('<article class="ios-panel" data-v-3dff0ec5><header class="panel-head" data-v-3dff0ec5><div data-v-3dff0ec5><p class="panel-label" data-v-3dff0ec5>注意事項</p><p class="panel-hint" data-v-3dff0ec5>申し込み前に必ずお読みください。</p></div></header><ul class="ios-guideline" data-v-3dff0ec5><li data-v-3dff0ec5>キャンセルは開催前日までにご連絡ください。</li><li data-v-3dff0ec5>入力いただいた情報は主催コミュニティ間でのみ共有されます。</li><li data-v-3dff0ec5>次の画面で内容を確認後、決済（必要な場合）へ進みます。</li><li data-v-3dff0ec5>お客様の個人情報は日本の個人情報保護法に基づき厳重に管理されます。</li></ul></article>',1)),y.value?(u(),i("p",at,d(y.value),1)):k("",!0),t[11]||(t[11]=l("div",{class:"mobile-register__spacer"},null,-1))])):k("",!0),l("nav",lt,[l("button",{type:"button",class:pe(["rails-cta",{"is-disabled":B.value}]),disabled:B.value,onClick:X},[t[12]||(t[12]=l("span",{class:"i-lucide-check-circle"},null,-1)),R(" "+d(Y.value),1)],10,ot)])])}}}),it=Te(nt,[["__scopeId","data-v-3dff0ec5"]]);export{it as default};
