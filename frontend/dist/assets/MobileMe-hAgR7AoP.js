import{d as de,l as me,c as f,r as o,b as i,h as s,p as he,i as k,q as U,t as v,j as F,y as _e,F as ge,f as fe,z as ye,s as xe,w as W,n as L,v as be,x as Me,a1 as we,a2 as Ce,u as Se,A as ke,a3 as Pe,e as n,_ as Ie}from"./index-CT-XDF2b.js";const Ae={class:"mobile-me m-page"},Ee={class:"me-hero"},Re=["disabled"],Te={key:0,class:"me-hero__avatar-spinner"},Be=["src"],$e={key:2},Oe={class:"me-hero__info"},Ue={class:"me-hero__subtitle"},We={class:"me-hero__chips"},ze={key:0,class:"chip chip--success"},De={key:1,class:"chip chip--ghost"},He={class:"service-form-group"},Ve=["onSubmit"],Xe={class:"service-form__body"},Fe={class:"service-form__label"},Le={class:"service-form__meta"},Ne={type:"submit",class:"service-form__submit"},Ye={key:0,class:"me-overlay"},je={class:"me-overlay__panel"},qe={class:"me-cropper__image"},Je=["src"],Ze={class:"me-cropper__slider"},Ge={class:"me-overlay__actions"},Ke=["disabled"],Qe=200*1024,p=280,P=400,et=de({__name:"MobileMe",setup(tt){const d=Se(),z=ke(),{user:m,setUserProfile:N}=me(),I=f(()=>!!m.value),Y=f(()=>{var t;return!!((t=m.value)!=null&&t.isOrganizer)}),j=f(()=>{var t,e,a;return((a=(e=(t=m.value)==null?void 0:t.name)==null?void 0:e.charAt(0))==null?void 0:a.toUpperCase())??"M"}),q=f(()=>{var e;switch(((e=m.value)==null?void 0:e.language)??"ja"){case"zh":return"中文 / Chinese";case"en":return"English";default:return"日本語 / Japanese"}}),J=()=>{d.push({name:"my-events"})},Z=()=>{d.push({name:"my-payments"})},G=()=>{d.push({name:"favorites"})},K=()=>{d.push({name:"MobileSettings"})},Q=[{title:"参加したイベント",description:"予約・チケット",cta:"確認する",action:()=>J()},{title:"支払い履歴",description:"お支払い記録",cta:"見る",action:()=>Z()},{title:"お気に入りイベント",description:"お気に入り",cta:"開く",action:()=>G()},{title:"設定",description:"アプリ環境",cta:"設定する",action:()=>K()}],ee=()=>{I.value?d.push({path:"/me"}):d.push({name:"auth-login",query:{redirect:z.fullPath}})},D=o(null),h=o(!1),u=o(""),g=o("success"),te=()=>{var t;if(!I.value){d.push({name:"auth-login",query:{redirect:z.fullPath}});return}u.value="",(t=D.value)==null||t.click()},y=o(null),x=o(null),_=o(1.2),l=o({x:0,y:0}),b=o(0),M=o(0),w=o(!1),C=o(!1),A=o({x:0,y:0}),E=o({x:0,y:0}),ae=f(()=>({width:`${b.value}px`,height:`${M.value}px`,transform:`translate(${l.value.x}px, ${l.value.y}px)`})),se=f(()=>({width:`${b.value}px`,height:`${M.value}px`,transform:`scale(${_.value})`})),oe=t=>{var r;const e=t.target,a=(r=e.files)==null?void 0:r[0];a&&(re(a),e&&(e.value=""))},re=t=>{const e=new FileReader;e.onload=()=>{const a=new Image;a.onload=()=>{y.value=e.result,x.value=a;const r=Math.max(p/a.naturalWidth,p/a.naturalHeight);b.value=a.naturalWidth*r,M.value=a.naturalHeight*r,_.value=1.2,l.value={x:0,y:0},R(),w.value=!0},a.onerror=()=>{u.value="图片加载失败",g.value="error"},a.src=e.result},e.onerror=()=>{u.value="无法读取图片",g.value="error"},e.readAsDataURL(t)},ne=t=>{var e;w.value&&(C.value=!0,A.value={x:t.clientX,y:t.clientY},E.value={...l.value},(e=t.currentTarget)==null||e.setPointerCapture(t.pointerId))},le=t=>{if(!C.value)return;const e=t.clientX-A.value.x,a=t.clientY-A.value.y;l.value={x:E.value.x+e,y:E.value.y+a},R()},H=t=>{var e;C.value&&(C.value=!1,(e=t.currentTarget)==null||e.releasePointerCapture(t.pointerId))},R=()=>{const t=Math.max(0,(b.value*_.value-p)/2),e=Math.max(0,(M.value*_.value-p)/2);l.value={x:Math.min(t,Math.max(-t,l.value.x)),y:Math.min(e,Math.max(-e,l.value.y))}},V=()=>{w.value=!1,y.value=null,x.value=null},ce=async()=>{if(x.value){h.value=!0,u.value="";try{const t=await ie();if(t.size>Qe){u.value="图片过大，请重新选择",g.value="error",h.value=!1;return}const e=new File([t],`avatar-${Date.now()}.jpg`,{type:t.type||"image/jpeg"}),a=await Pe(e);N(a),u.value="头像已更新",g.value="success",V()}catch(t){console.error("Failed to upload avatar",t),u.value="头像上传失败",g.value="error"}finally{h.value=!1}}},ie=()=>new Promise((t,e)=>{const a=x.value;if(!a){e(new Error("未找到图片"));return}const r=document.createElement("canvas");r.width=P,r.height=P;const c=r.getContext("2d");if(!c){e(new Error("无法创建画布"));return}const S=Math.max(p/a.naturalWidth,p/a.naturalHeight)*_.value,T=p/S,B=p/S,ve=a.naturalWidth/2-l.value.x/S,pe=a.naturalHeight/2-l.value.y/S;let $=ve-T/2,O=pe-B/2;$=Math.max(0,Math.min(a.naturalWidth-T,$)),O=Math.max(0,Math.min(a.naturalHeight-B,O)),c.drawImage(a,$,O,T,B,0,0,P,P),r.toBlob(X=>{if(!X){e(new Error("无法生成头像"));return}t(X)},"image/jpeg",.92)});return(t,e)=>{var a,r;return n(),i("div",Ae,[s("section",Ee,[s("button",{class:"me-hero__avatar",type:"button",onClick:te,disabled:h.value},[h.value?(n(),i("div",Te)):k("",!0),(a=U(m))!=null&&a.avatarUrl?(n(),i("img",{key:1,src:U(m).avatarUrl,alt:"user"},null,8,Be)):(n(),i("span",$e,v(j.value),1))],8,Re),s("input",{ref_key:"avatarInput",ref:D,type:"file",accept:"image/*",class:"sr-only",onChange:oe},null,544),s("div",Oe,[s("p",Ue,v(I.value?q.value:"ようこそ"),1),s("button",{class:"me-hero__title",type:"button",onClick:ee},v(((r=U(m))==null?void 0:r.name)||"ゲスト"),1),s("div",We,[Y.value?(n(),i("span",ze,[...e[1]||(e[1]=[s("span",{class:"i-lucide-badge-check mr-1"},null,-1),F("主理人 ",-1)])])):(n(),i("span",De,"ゲスト"))]),u.value?(n(),i("p",{key:0,class:_e(["me-hero__status",g.value==="error"?"is-error":""])},v(u.value),3)):k("",!0)])]),e[5]||(e[5]=s("section",{class:"m-section-title"},"マイサービス",-1)),s("div",He,[(n(),i(ge,null,fe(Q,c=>s("form",{key:c.title,class:"service-form",onSubmit:W(ue=>c.action(),["prevent"])},[s("div",Xe,[s("p",Fe,v(c.title),1),s("p",Le,v(c.description),1)]),s("button",Ne,[F(v(c.cta)+" ",1),e[2]||(e[2]=s("span",{class:"i-lucide-arrow-right"},null,-1))])],40,Ve)),64))]),(n(),he(Ce,{to:"body"},[ye(we,{name:"fade"},{default:xe(()=>[w.value?(n(),i("div",Ye,[s("div",je,[e[4]||(e[4]=s("p",{class:"me-overlay__title"},"调整头像",-1)),s("div",{class:"me-cropper",onPointerdown:W(ne,["prevent"]),onPointermove:W(le,["prevent"]),onPointerup:H,onPointerleave:H},[s("div",qe,[s("div",{class:"me-cropper__shift",style:L(ae.value)},[y.value?(n(),i("img",{key:0,src:y.value,style:L(se.value),draggable:"false"},null,12,Je)):k("",!0)],4)]),e[3]||(e[3]=s("div",{class:"me-cropper__mask"},null,-1))],32),s("div",Ze,[be(s("input",{type:"range",min:"1",max:"3",step:"0.01","onUpdate:modelValue":e[0]||(e[0]=c=>_.value=c),onInput:R},null,544),[[Me,_.value,void 0,{number:!0}]])]),s("div",Ge,[s("button",{type:"button",class:"ghost",onClick:V},"取消"),s("button",{type:"button",class:"primary",disabled:h.value,onClick:ce},v(h.value?"上传中…":"使用此头像"),9,Ke)])])])):k("",!0)]),_:1})]))])}}}),st=Ie(et,[["__scopeId","data-v-82dfa426"]]);export{st as default};
