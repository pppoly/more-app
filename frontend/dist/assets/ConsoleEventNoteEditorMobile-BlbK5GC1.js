import{d as Z,A as Q,r as v,c as ee,b as l,h as r,i as C,t as k,q as te,F as ne,f as oe,al as A,am as se,u as ae,e as c,v as ie,x as le,a4 as re,_ as ce}from"./index-CT-XDF2b.js";const ue={class:"note-editor"},de={class:"note-editor__nav"},pe={class:"note-editor__meta"},fe={class:"note-editor__blocks"},ve={key:0,class:"note-block__actions"},me=["onClick"],ge=["onClick"],he=["onUpdate:modelValue","placeholder","data-block-id","onFocus","onClick","onKeyup","onInput"],_e={key:2,class:"note-image"},ye=["src"],xe=["onClick"],ke={key:3,class:"note-block__actions"},Ie=["onClick"],Ce=["onClick"],be={key:0,class:"note-editor__status"},$=9,Ee=5*1024*1024,Be=Z({__name:"ConsoleEventNoteEditorMobile",setup(Se){const b=ae(),E=Q(),B=E.params.communityId,S=E.query.eventId,f=(()=>{try{const e=sessionStorage.getItem(A);return e?(sessionStorage.removeItem(A),JSON.parse(e)):{}}catch{return{}}})(),a=v([]),d=v(""),_=v(!1),T=v(null),I=v({}),g=v({blockId:null,position:"after"}),y=v(null),D=new Intl.DateTimeFormat("ja-JP",{month:"long",day:"numeric",weekday:"short"}).format(new Date),P=ee(()=>a.value.filter(e=>e.type==="text").reduce((e,n)=>e+n.value.trim().length,0)),p=(e="")=>({id:`text-${Date.now()}-${Math.random().toString(36).slice(2)}`,type:"text",value:e}),m=e=>({id:`image-${Date.now()}-${Math.random().toString(36).slice(2)}`,type:"image",src:e}),h=()=>{if(!a.value.length){a.value.push(p());return}a.value.every(e=>e.type==="image")&&a.value.unshift(p())},R=e=>{if(typeof window>"u"||typeof window.DOMParser>"u")return[];try{const t=new DOMParser().parseFromString(e,"text/html"),o=[];return t.body.childNodes.forEach(s=>{var u;if(s.nodeName==="P"){const W=s.innerHTML.replace(/<br\s*\/?>/gi,`
`).replace(/<[^>]+>/g,"");o.push(p(W))}else if(s.nodeName==="FIGURE"){const i=s.querySelector("img");i!=null&&i.getAttribute("src")&&o.push(m(i.getAttribute("src")))}else if(s.nodeName==="#text"){const i=(u=s.textContent)==null?void 0:u.trim();i&&o.push(p(i))}}),o.filter(s=>s.type==="text"?s.value.trim().length>0:!!s.src)}catch{return[]}};(()=>{let e=[];f.html?e=R(f.html):f.text&&(e=[p(f.text)]),e.length||(e=[p()]),f.images&&f.images.length&&!e.some(n=>n.type==="image")&&f.images.forEach(n=>{e.push(m(n.src))}),a.value=e,h()})();const x=(e,n)=>{var o;const t=n.target;I.value={...I.value,[e]:t.selectionStart??((o=t.value)==null?void 0:o.length)??0}},N=(e,n="after")=>{var t;if(g.value={blockId:e,position:n},a.value.filter(o=>o.type==="image").length>=$){d.value="最多上传 9 张图片";return}(t=T.value)==null||t.click()},L=e=>new Promise((n,t)=>{const o=new FileReader;o.onload=()=>n(o.result),o.onerror=t,o.readAsDataURL(e)}),U=async e=>{var u;const n=e.target;if(!n.files)return;const t=a.value.filter(i=>i.type==="image").length,o=$-t;if(o<=0){d.value="最多上传 9 张图片",n.value="";return}const s=Array.from(n.files).slice(0,o);for(const i of s){if(!((u=i.type)!=null&&u.startsWith("image/"))){d.value="仅支持上传图片文件";continue}if(i.size>Ee){d.value="图片过大，请压缩后再试";continue}try{const F=await L(i);q(F),d.value=""}catch{d.value="图片读取失败，请重试"}}n.value=""},V=e=>{const n=a.value[e];if(!n||n.type!=="text")return{insertIndex:e,trailingBlock:null};const t=I.value[n.id]??n.value.length;if(t<=0||t>=n.value.length)return{insertIndex:e,trailingBlock:null};const o=n.value.slice(0,t),s=n.value.slice(t);n.value=o;const u=p(s);return a.value.splice(e+1,0,u),{insertIndex:e,trailingBlock:u}},q=e=>{const n=g.value;if(!n.blockId){const o=n.position==="before"?0:a.value.length;a.value.splice(o,0,m(e)),h(),g.value={blockId:null,position:"after"};return}const t=a.value.findIndex(o=>o.id===n.blockId);if(t===-1){a.value.push(m(e)),h(),g.value={blockId:null,position:"after"};return}if(a.value[t].type==="text"){const{insertIndex:o,trailingBlock:s}=V(t);let u=o+(n.position==="before"?0:1);s&&n.position==="after"&&(u+=1),a.value.splice(u,0,m(e))}else{const o=n.position==="before"?t:t+1;a.value.splice(o,0,m(e))}h(),g.value={blockId:null,position:"after"}},j=e=>{a.value=a.value.filter(n=>n.id!==e),h()},H=e=>{const n=document.querySelector(`textarea[data-block-id="${e}"]`);if(n){n.focus();const t=n.value.length;n.setSelectionRange(t,t)}},w=(e,n)=>{const t=p();if(e){const o=a.value.findIndex(s=>s.id===e);if(o===-1){const s=n==="before"?0:a.value.length;a.value.splice(s,0,t)}else{const s=n==="before"?0:1;a.value.splice(o+s,0,t)}}else{const o=n==="before"?0:a.value.length;a.value.splice(o,0,t)}y.value=t.id,re(()=>{y.value&&(H(y.value),y.value=null)})},M=(e,n,t)=>{if(e.type==="text"){const o=n==="before"?a.value[t-1]:a.value[t+1];if((o==null?void 0:o.type)==="image")return!1}return!0},K=e=>e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"),X=()=>a.value.map(e=>{if(e.type==="text"){const n=e.value.split(/\n{2,}/).map(t=>t.trim()).filter(Boolean);return n.length?n.map(t=>`<p>${K(t).replace(/\n/g,"<br />")}</p>`).join(""):""}return e.src?`<figure class="note-image"><img src="${e.src}" alt="活动详情图片" /></figure>`:""}).filter(Boolean).join(""),z=()=>a.value.filter(e=>e.type==="text").map(e=>e.value.trim()).filter(Boolean).join(`

`),G=()=>a.value.filter(e=>e.type==="image").map(e=>({id:e.id,src:e.src})),O=()=>{if(!B){b.back();return}b.replace({name:"ConsoleMobileEventForm",params:{communityId:B},query:S?{eventId:S}:void 0})},J=()=>{O()},Y=()=>{if(_.value)return;_.value=!0;const e={text:z(),html:X(),images:G()};sessionStorage.setItem(se,JSON.stringify(e)),_.value=!1,O()};return(e,n)=>(c(),l("section",ue,[r("header",de,[r("button",{type:"button",class:"nav-btn ghost",onClick:J},"取消"),n[0]||(n[0]=r("p",null,"活动详情",-1)),r("button",{type:"button",class:"nav-btn primary",onClick:Y},k(_.value?"保存中…":"完成"),1)]),r("div",pe,[r("span",null,k(te(D)),1),r("span",null,k(P.value)+" 字",1)]),r("section",fe,[(c(!0),l(ne,null,oe(a.value,(t,o)=>(c(),l("div",{key:t.id,class:"note-block"},[M(t,"before",o)?(c(),l("div",ve,[t.type==="text"?(c(),l("button",{key:0,type:"button",class:"insert-btn ghost",onClick:s=>N(t.id,"before")}," ＋ 在这里插入图片 ",8,me)):(c(),l("button",{key:1,type:"button",class:"insert-btn ghost",onClick:s=>w(t.id,"before")}," ＋ 在这里添加文字 ",8,ge))])):C("",!0),t.type==="text"?ie((c(),l("textarea",{key:1,"onUpdate:modelValue":s=>t.value=s,class:"note-textarea",placeholder:o===0?"像 iOS 备忘录一样，讲述你的活动故事…":"继续输入...","data-block-id":t.id,onFocus:s=>x(t.id,s),onClick:s=>x(t.id,s),onKeyup:s=>x(t.id,s),onInput:s=>x(t.id,s)},null,40,he)),[[le,t.value]]):(c(),l("div",_e,[r("img",{src:t.src,alt:"note image"},null,8,ye),r("button",{type:"button",class:"note-photo__delete",onClick:s=>j(t.id)},"×",8,xe)])),M(t,"after",o)?(c(),l("div",ke,[t.type==="text"?(c(),l("button",{key:0,type:"button",class:"insert-btn ghost",onClick:s=>N(t.id,"after")}," ＋ 在这里插入图片 ",8,Ie)):(c(),l("button",{key:1,type:"button",class:"insert-btn ghost",onClick:s=>w(t.id,"after")}," ＋ 在这里添加文字 ",8,Ce))])):C("",!0)]))),128))]),n[1]||(n[1]=r("p",{class:"note-editor__hint"},"尺寸 750×X，最多上传 9 张，默认第一张为详情页主图",-1)),d.value?(c(),l("p",be,k(d.value),1)):C("",!0),r("input",{ref_key:"fileInputRef",ref:T,type:"file",multiple:"",accept:"image/*",class:"hidden-input",onChange:U},null,544)]))}}),Me=ce(Be,[["__scopeId","data-v-edcf0e17"]]);export{Me as default};
