import{d as de,m as he,c as f,r as o,e as i,i as s,q as _e,j as S,s as U,t as v,k as me,z as X,F as ge,h as fe,A as ye,v as xe,w as F,n as L,x as we,y as be,a2 as ke,a3 as Me,u as Ce,B as Se,a4 as Pe,f as r,_ as Ie}from"./index-DncFUGrq.js";const Ae={class:"mobile-me m-page"},Ee={class:"me-hero"},Be=["disabled"],Re={key:0,class:"me-hero__avatar-spinner"},Te=["src"],$e={key:2},Oe={class:"me-hero__info"},Ue={class:"me-hero__subtitle"},We={class:"me-hero__chips"},ze={key:0,class:"chip chip--success"},De={key:1,class:"chip chip--ghost"},He={class:"service-sheet"},Ve=["onClick"],Xe={class:"service-row__info"},Fe={class:"service-row__title"},Le={class:"service-row__desc"},Ne={class:"service-row__trailing"},Ye={class:"service-row__cta"},je={key:0,class:"me-overlay"},qe={class:"me-overlay__panel"},Je={class:"me-cropper__image"},Ze=["src"],Ge={class:"me-cropper__slider"},Ke={class:"me-overlay__actions"},Qe=["disabled"],et=200*1024,p=280,P=400,tt=de({__name:"MobileMe",setup(at){const d=Ce(),W=Se(),{user:h,setUserProfile:N}=he(),I=f(()=>!!h.value),Y=f(()=>{var t;return!!((t=h.value)!=null&&t.isOrganizer)}),j=f(()=>{var t,e,a;return((a=(e=(t=h.value)==null?void 0:t.name)==null?void 0:e.charAt(0))==null?void 0:a.toUpperCase())??"M"}),q=f(()=>{var e;switch(((e=h.value)==null?void 0:e.language)??"ja"){case"zh":return"中文 / Chinese";case"en":return"English";default:return"日本語 / Japanese"}}),J=()=>{d.push({name:"my-events"})},Z=()=>{d.push({name:"my-payments"})},G=()=>{d.push({name:"favorites"})},K=()=>{d.push({name:"MobileSettings"})},Q=[{title:"参加したイベント",description:"予約・チケット",cta:"見る",icon:"i-lucide-ticket",action:()=>J()},{title:"支払い履歴",description:"お支払い記録",cta:"見る",icon:"i-lucide-receipt-japanese-yen",action:()=>Z()},{title:"お気に入りイベント",description:"お気に入り",cta:"見る",icon:"i-lucide-heart",action:()=>G()},{title:"設定",description:"アプリ環境",cta:"開く",icon:"i-lucide-settings",action:()=>K()}],ee=()=>{I.value?d.push({path:"/me"}):d.push({name:"auth-login",query:{redirect:W.fullPath}})},z=o(null),_=o(!1),u=o(""),g=o("success"),te=()=>{var t;if(!I.value){d.push({name:"auth-login",query:{redirect:W.fullPath}});return}u.value="",(t=z.value)==null||t.click()},y=o(null),x=o(null),m=o(1.2),c=o({x:0,y:0}),w=o(0),b=o(0),k=o(!1),M=o(!1),A=o({x:0,y:0}),E=o({x:0,y:0}),ae=f(()=>({width:`${w.value}px`,height:`${b.value}px`,transform:`translate(${c.value.x}px, ${c.value.y}px)`})),se=f(()=>({width:`${w.value}px`,height:`${b.value}px`,transform:`scale(${m.value})`})),oe=t=>{var n;const e=t.target,a=(n=e.files)==null?void 0:n[0];a&&(ne(a),e&&(e.value=""))},ne=t=>{const e=new FileReader;e.onload=()=>{const a=new Image;a.onload=()=>{y.value=e.result,x.value=a;const n=Math.max(p/a.naturalWidth,p/a.naturalHeight);w.value=a.naturalWidth*n,b.value=a.naturalHeight*n,m.value=1.2,c.value={x:0,y:0},B(),k.value=!0},a.onerror=()=>{u.value="图片加载失败",g.value="error"},a.src=e.result},e.onerror=()=>{u.value="无法读取图片",g.value="error"},e.readAsDataURL(t)},le=t=>{var e;k.value&&(M.value=!0,A.value={x:t.clientX,y:t.clientY},E.value={...c.value},(e=t.currentTarget)==null||e.setPointerCapture(t.pointerId))},re=t=>{if(!M.value)return;const e=t.clientX-A.value.x,a=t.clientY-A.value.y;c.value={x:E.value.x+e,y:E.value.y+a},B()},D=t=>{var e;M.value&&(M.value=!1,(e=t.currentTarget)==null||e.releasePointerCapture(t.pointerId))},B=()=>{const t=Math.max(0,(w.value*m.value-p)/2),e=Math.max(0,(b.value*m.value-p)/2);c.value={x:Math.min(t,Math.max(-t,c.value.x)),y:Math.min(e,Math.max(-e,c.value.y))}},H=()=>{k.value=!1,y.value=null,x.value=null},ce=async()=>{if(x.value){_.value=!0,u.value="";try{const t=await ie();if(t.size>et){u.value="图片过大，请重新选择",g.value="error",_.value=!1;return}const e=new File([t],`avatar-${Date.now()}.jpg`,{type:t.type||"image/jpeg"}),a=await Pe(e);N(a),u.value="头像已更新",g.value="success",H()}catch(t){console.error("Failed to upload avatar",t),u.value="头像上传失败",g.value="error"}finally{_.value=!1}}},ie=()=>new Promise((t,e)=>{const a=x.value;if(!a){e(new Error("未找到图片"));return}const n=document.createElement("canvas");n.width=P,n.height=P;const l=n.getContext("2d");if(!l){e(new Error("无法创建画布"));return}const C=Math.max(p/a.naturalWidth,p/a.naturalHeight)*m.value,R=p/C,T=p/C,ve=a.naturalWidth/2-c.value.x/C,pe=a.naturalHeight/2-c.value.y/C;let $=ve-R/2,O=pe-T/2;$=Math.max(0,Math.min(a.naturalWidth-R,$)),O=Math.max(0,Math.min(a.naturalHeight-T,O)),l.drawImage(a,$,O,R,T,0,0,P,P),n.toBlob(V=>{if(!V){e(new Error("无法生成头像"));return}t(V)},"image/jpeg",.92)});return(t,e)=>{var a,n;return r(),i("div",Ae,[s("section",Ee,[s("button",{class:"me-hero__avatar",type:"button",onClick:te,disabled:_.value},[_.value?(r(),i("div",Re)):S("",!0),(a=U(h))!=null&&a.avatarUrl?(r(),i("img",{key:1,src:U(h).avatarUrl,alt:"user"},null,8,Te)):(r(),i("span",$e,v(j.value),1))],8,Be),s("input",{ref_key:"avatarInput",ref:z,type:"file",accept:"image/*",class:"sr-only",onChange:oe},null,544),s("div",Oe,[s("p",Ue,v(I.value?q.value:"ようこそ"),1),s("button",{class:"me-hero__title",type:"button",onClick:ee},v(((n=U(h))==null?void 0:n.name)||"ゲスト"),1),s("div",We,[Y.value?(r(),i("span",ze,[...e[1]||(e[1]=[s("span",{class:"i-lucide-badge-check mr-1"},null,-1),me("主理人 ",-1)])])):(r(),i("span",De,"ゲスト"))]),u.value?(r(),i("p",{key:0,class:X(["me-hero__status",g.value==="error"?"is-error":""])},v(u.value),3)):S("",!0)])]),e[5]||(e[5]=s("section",{class:"m-section-title"},"マイサービス",-1)),s("div",He,[(r(),i(ge,null,fe(Q,l=>s("button",{key:l.title,type:"button",class:"service-row",onClick:ue=>l.action()},[s("span",{class:X(["service-row__icon",l.icon])},null,2),s("div",Xe,[s("p",Fe,v(l.title),1),s("p",Le,v(l.description),1)]),s("div",Ne,[s("span",Ye,v(l.cta),1),e[2]||(e[2]=s("span",{class:"service-row__chevron i-lucide-chevron-right"},null,-1))])],8,Ve)),64))]),(r(),_e(Me,{to:"body"},[ye(ke,{name:"fade"},{default:xe(()=>[k.value?(r(),i("div",je,[s("div",qe,[e[4]||(e[4]=s("p",{class:"me-overlay__title"},"调整头像",-1)),s("div",{class:"me-cropper",onPointerdown:F(le,["prevent"]),onPointermove:F(re,["prevent"]),onPointerup:D,onPointerleave:D},[s("div",Je,[s("div",{class:"me-cropper__shift",style:L(ae.value)},[y.value?(r(),i("img",{key:0,src:y.value,style:L(se.value),draggable:"false"},null,12,Ze)):S("",!0)],4)]),e[3]||(e[3]=s("div",{class:"me-cropper__mask"},null,-1))],32),s("div",Ge,[we(s("input",{type:"range",min:"1",max:"3",step:"0.01","onUpdate:modelValue":e[0]||(e[0]=l=>m.value=l),onInput:B},null,544),[[be,m.value,void 0,{number:!0}]])]),s("div",Ke,[s("button",{type:"button",class:"ghost",onClick:H},"取消"),s("button",{type:"button",class:"primary",disabled:_.value,onClick:ce},v(_.value?"上传中…":"使用此头像"),9,Qe)])])])):S("",!0)]),_:1})]))])}}}),ot=Ie(tt,[["__scopeId","data-v-5942397a"]]);export{ot as default};
