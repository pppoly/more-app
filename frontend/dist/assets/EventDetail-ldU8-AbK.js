import{d as ie,z as de,u as ve,c as _,r as p,A as pe,l as he,B as ye,o as _e,g as j,a as l,b as o,e as a,h as v,t as u,F as k,f as E,j as x,i as m,w as G,v as U,G as me,x as be,H as ge,I as ke,D as fe,E as we,J as Ce,K as Me,L as Ee,_ as qe}from"./index-OEpVzuiB.js";const Te={class:"detail-shell"},Re={key:0,class:"status"},Ie={key:1,class:"status error"},Le={key:0,class:"hero"},Se=["src"],Ue={class:"hero-overlay"},Ae={class:"hero-title"},Fe={class:"hero-sub"},Ve={key:0,class:"hero-dots"},De=["onClick"],Be={class:"info-card"},$e={class:"card-header"},He={key:0,class:"category-chip"},Pe={class:"card-title"},ze={class:"info-row"},Ne={class:"info-row"},je=["disabled"],xe={class:"info-row"},Ge={class:"info-row"},Ke={class:"info-card"},Oe=["innerHTML"],Je={key:1,class:"info-card"},We={key:0},Qe={key:1},Xe={key:2},Ye={key:3},Ze={key:2,class:"status info"},et={key:3,class:"info-card payment-card"},tt={class:"payment-actions"},at=["disabled"],st=["disabled"],lt={key:4,class:"status error"},ot={key:3,class:"status"},nt={key:4,class:"bottom-bar"},ut={class:"price-block"},rt={class:"price-label"},ct={class:"price-value"},it=["disabled"],dt={class:"modal"},vt={key:0},pt=["type","required","placeholder","onUpdate:modelValue"],ht={key:1},yt=["required","placeholder","onUpdate:modelValue"],_t={key:2},mt=["onUpdate:modelValue","required"],bt=["value"],gt={key:3,class:"choice-group"},kt=["name","value","onUpdate:modelValue","required"],ft={key:4,class:"choice-group"},wt=["value","checked","onChange"],Ct={key:5,class:"inline"},Mt=["checked","onChange"],Et=["disabled"],qt=ie({__name:"EventDetail",setup(Tt){const K=de(),O=ve(),f=_(()=>K.params.eventId),n=p(null),q=p([]),T=p(0),A=p(!0),w=p(null),b=p(!1),C=p(!1),y=p(null),h=p(null),R=p(!1),I=p(!1),g=p(null),L=p(!1),c=pe({}),J=he(),F=_(()=>!!J.user.value),P=async e=>{if(!e){w.value="Missing event id";return}C.value=!1,y.value=null,h.value=null,g.value=null,A.value=!0,w.value=null;try{n.value=await fe(e),q.value=await we(e),T.value=0}catch(s){w.value=s instanceof Error?s.message:"Failed to load event"}finally{A.value=!1}};ye(f,e=>{e&&P(e)}),_e(()=>{f.value&&P(f.value)});const V=_(()=>n.value?j(n.value.title):""),W=_(()=>n.value?j(n.value.description??n.value.title):""),z=_(()=>{var e;return((e=q.value[T.value])==null?void 0:e.imageUrl)??null}),Q=_(()=>{const e=n.value;return e!=null&&e.config&&e.config.price?`¥${e.config.price}`:"無料/未設定"}),D=_(()=>{const e=n.value;return e?typeof e.locationLat=="number"&&typeof e.locationLng=="number"?`https://www.google.com/maps/dir/?api=1&destination=${e.locationLat},${e.locationLng}`:`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(e.locationText)}`:null}),X=_(()=>F.value?C.value?"参加予定です":"参加する":"ログイン"),Y=_(()=>b.value||C.value||!!h.value),S=e=>e?new Date(e).toLocaleString(void 0,{month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"}):"--",Z=async()=>{if(!f.value||!F.value){y.value="ログインしてください";return}if(B.value.length){se(),L.value=!0;return}await N({})},B=_(()=>{var e;return((e=n.value)==null?void 0:e.registrationFormSchema)??[]}),N=async e=>{b.value=!0,y.value=null;try{const s=await Ce(f.value,{formAnswers:e});ee(s)}catch(s){y.value=s instanceof Error?s.message:"Failed to register for this event"}finally{b.value=!1}},ee=e=>{e.paymentRequired?(h.value={registrationId:e.registrationId,amount:e.amount},g.value="お支払いを完了すると参加が確定します。"):(C.value=!0,h.value=null,g.value=null)},te=async()=>{if(h.value){R.value=!0,y.value=null;try{await Me(h.value.registrationId),C.value=!0,h.value=null,g.value="お支払いが完了しました。参加が確定です。"}catch(e){y.value=e instanceof Error?e.message:"Failed to process payment"}finally{R.value=!1}}},ae=async()=>{var e,s;if(h.value){I.value=!0,y.value=null;try{const{checkoutUrl:t}=await Ee(h.value.registrationId);window.location.href=t}catch(t){const i=((s=(e=t==null?void 0:t.response)==null?void 0:e.data)==null?void 0:s.message)??(t instanceof Error?t.message:"Stripe Checkoutの開始に失敗しました");y.value=i,I.value=!1}}},d=(e,s)=>e.id??`${e.label??"field"}-${s}`,se=()=>{Object.keys(c).forEach(e=>delete c[e]),B.value.forEach((e,s)=>{const t=d(e,s);e.type==="checkbox"?c[t]=!1:e.type==="multiChoice"?c[t]=[]:c[t]=""})},$=()=>{b.value||(L.value=!1)},le=async()=>{L.value=!1,await N({...c})},H=e=>Array.isArray(e.options)?e.options:[],oe=(e,s,t,i)=>{const r=d(e,s);Array.isArray(c[r])||(c[r]=[]),i?c[r].includes(t)||c[r].push(t):c[r]=c[r].filter(M=>M!==t)},ne=e=>{switch(e){case"email":return"email";case"phone":return"tel";case"number":return"number";case"date":return"date";default:return"text"}},ue=()=>{O.back()},re=()=>{navigator.share&&n.value&&navigator.share({title:V.value,url:window.location.href}).catch(()=>{})},ce=()=>{D.value&&window.open(D.value,"_blank")};return(e,s)=>(o(),l("section",Te,[a("header",{class:"detail-header"},[a("button",{type:"button",class:"icon-btn",onClick:ue},"←"),s[0]||(s[0]=a("p",null,"イベント詳細",-1)),a("button",{type:"button",class:"icon-btn",onClick:re},"⋯")]),A.value?(o(),l("p",Re,"読み込み中...")):w.value?(o(),l("p",Ie,u(w.value),1)):n.value?(o(),l(k,{key:2},[z.value?(o(),l("div",Le,[a("img",{src:z.value,alt:"cover"},null,8,Se),a("div",Ue,[a("p",Ae,u(V.value),1),a("p",Fe,u(n.value.community.name),1)]),q.value.length>1?(o(),l("div",Ve,[(o(!0),l(k,null,E(q.value,(t,i)=>(o(),l("button",{key:t.id,class:x(["dot",{active:T.value===i}]),onClick:r=>T.value=i},null,10,De))),128))])):v("",!0)])):v("",!0),a("div",Be,[a("div",$e,[n.value.category?(o(),l("span",He,"#"+u(n.value.category),1)):v("",!0),a("p",Pe,u(V.value),1)]),a("div",ze,[s[1]||(s[1]=a("span",{class:"label"},"日時",-1)),a("span",null,u(S(n.value.startTime))+" 〜 "+u(n.value.endTime?S(n.value.endTime):"未定"),1)]),a("div",Ne,[s[2]||(s[2]=a("span",{class:"label"},"場所",-1)),a("span",null,[m(u(n.value.locationText)+" ",1),a("button",{type:"button",class:"link",onClick:ce,disabled:!D.value}," 地図を開く ",8,je)])]),a("div",xe,[s[3]||(s[3]=a("span",{class:"label"},"受付期間",-1)),a("span",null,u(S(n.value.regStartTime??n.value.startTime))+" 〜 "+u(S(n.value.regEndTime??n.value.startTime)),1)]),a("div",Ge,[s[4]||(s[4]=a("span",{class:"label"},"ステータス",-1)),a("span",{class:x(["status-pill",n.value.status==="open"?"open":"closed"])},u(n.value.status==="open"?"受付中":"終了"),3)])]),a("div",Ke,[s[5]||(s[5]=a("h3",null,"イベント概要",-1)),a("p",null,u(W.value),1),n.value.descriptionHtml?(o(),l("div",{key:0,class:"rich",innerHTML:n.value.descriptionHtml},null,8,Oe)):v("",!0)]),n.value.config?(o(),l("div",Je,[s[6]||(s[6]=a("h3",null,"参加ルール",-1)),a("ul",null,[n.value.config.requireCheckin?(o(),l("li",We,"✔ チェックイン必須")):v("",!0),n.value.config.enableWaitlist?(o(),l("li",Qe,"✔ キャンセル待ちあり")):v("",!0),n.value.config.refundPolicy?(o(),l("li",Xe,"返金: "+u(n.value.config.refundPolicy),1)):v("",!0),n.value.config.riskNoticeEnabled?(o(),l("li",Ye,"⚠️ 注意事項をご確認ください。")):v("",!0)])])):v("",!0),g.value?(o(),l("p",Ze,u(g.value),1)):v("",!0),h.value?(o(),l("div",et,[a("p",null,"支払額: ¥"+u(h.value.amount??0),1),a("div",tt,[a("button",{type:"button",class:"primary",onClick:ae,disabled:I.value},u(I.value?"Stripeへ移動中...":"Stripeで支払う"),9,at),a("button",{type:"button",class:"secondary",onClick:te,disabled:R.value},u(R.value?"Mock 決済中...":"Mock 支払い（デモ）"),9,st)])])):v("",!0),y.value?(o(),l("p",lt,u(y.value),1)):v("",!0)],64)):(o(),l("p",ot,"イベントが見つかりません。")),n.value?(o(),l("div",nt,[a("div",ut,[a("p",rt,u(F.value?"参加費":"ログインが必要です"),1),a("p",ct,u(Q.value),1)]),a("button",{type:"button",class:"cta-btn",disabled:Y.value,onClick:Z},u(X.value),9,it)])):v("",!0),L.value?(o(),l("div",{key:5,class:"modal-backdrop",onClick:G($,["self"])},[a("div",dt,[a("header",null,[s[7]||(s[7]=a("h3",null,"参加申込フォーム",-1)),a("button",{type:"button",class:"close",onClick:$},"×")]),a("form",{onSubmit:G(le,["prevent"]),class:"dynamic-form"},[(o(!0),l(k,null,E(B.value,(t,i)=>(o(),l("div",{key:d(t,i)},[["text","email","phone","number","date"].includes(t.type)?(o(),l("label",vt,[m(u(t.label)+" ",1),U(a("input",{type:ne(t.type),required:t.required,placeholder:t.placeholder,"onUpdate:modelValue":r=>c[d(t,i)]=r},null,8,pt),[[me,c[d(t,i)]]])])):t.type==="textarea"?(o(),l("label",ht,[m(u(t.label)+" ",1),U(a("textarea",{required:t.required,placeholder:t.placeholder,"onUpdate:modelValue":r=>c[d(t,i)]=r},null,8,yt),[[be,c[d(t,i)]]])])):t.type==="select"?(o(),l("label",_t,[m(u(t.label)+" ",1),U(a("select",{"onUpdate:modelValue":r=>c[d(t,i)]=r,required:t.required},[s[8]||(s[8]=a("option",{value:"",disabled:""},"選択してください",-1)),(o(!0),l(k,null,E(H(t),r=>(o(),l("option",{key:r,value:r},u(r),9,bt))),128))],8,mt),[[ge,c[d(t,i)]]])])):t.type==="singleChoice"?(o(),l("div",gt,[a("p",null,u(t.label),1),(o(!0),l(k,null,E(H(t),r=>(o(),l("label",{key:r,class:"inline"},[U(a("input",{type:"radio",name:d(t,i),value:r,"onUpdate:modelValue":M=>c[d(t,i)]=M,required:t.required},null,8,kt),[[ke,c[d(t,i)]]]),m(" "+u(r),1)]))),128))])):t.type==="multiChoice"?(o(),l("div",ft,[a("p",null,u(t.label),1),(o(!0),l(k,null,E(H(t),r=>(o(),l("label",{key:r,class:"inline"},[a("input",{type:"checkbox",value:r,checked:Array.isArray(c[d(t,i)])&&c[d(t,i)].includes(r),onChange:M=>oe(t,i,r,M.target.checked)},null,40,wt),m(" "+u(r),1)]))),128))])):t.type==="checkbox"?(o(),l("label",Ct,[a("input",{type:"checkbox",checked:!!c[d(t,i)],onChange:r=>c[d(t,i)]=r.target.checked},null,40,Mt),m(" "+u(t.label),1)])):v("",!0)]))),128)),a("footer",null,[a("button",{type:"button",class:"secondary",onClick:$},"キャンセル"),a("button",{type:"submit",class:"primary",disabled:b.value},u(b.value?"送信中...":"送信"),9,Et)])],32)])])):v("",!0)]))}}),It=qe(qt,[["__scopeId","data-v-605bec8b"]]);export{It as default};
