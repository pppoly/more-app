import{d as et,c as _,B as st,r as p,g as at,a as lt,o as nt,e as i,A as it,i as t,j as y,E,F as k,h as f,t as l,k as S,z as j,n as D,w as ot,as as ct,at as rt,au as dt,u as ut,av as vt,aw as pt,f as o,_ as mt}from"./index-DncFUGrq.js";import{P as ht}from"./PageMarker-B9WMY3Nd.js";const _t={class:"page"},kt={key:0,class:"skeleton-overlay","aria-hidden":"true"},bt={class:"skeleton-stack"},gt={class:"panel skeleton-panel"},yt={class:"ticket-breakdown mt-3"},ft={class:"panel skeleton-panel"},wt={key:1,class:"panel error-panel"},Ct={class:"panel-title"},xt={class:"hero-card"},Et={class:"hero-content"},St={class:"hero-head"},Pt={class:"hero-text"},Tt={class:"hero-title line-clamp-2"},Mt={class:"chip-row"},At={class:"chip"},It={class:"chip"},Lt={key:0,class:"panel"},Rt={class:"panel-head"},Ut={class:"panel-title"},jt={class:"muted"},Dt={class:"pill"},Nt={class:"progress"},Vt={class:"stat-grid"},Bt={class:"stat-card"},$t={class:"stat-value"},zt={class:"stat-hint"},Ft={class:"stat-card"},Jt={class:"stat-value"},qt={key:0,class:"ticket-breakdown"},Gt={class:"ticket-meta"},Ht={class:"ticket-name"},Kt={class:"ticket-progress"},Ot={class:"ticket-count"},Qt={class:"participants"},Wt={class:"avatar-stack"},Xt=["src"],Yt={key:1,class:"panel muted-panel"},Zt={class:"panel-head"},te={class:"pill light"},ee=["onClick"],se={class:"avatar-shell"},ae=["src"],le={key:1,class:"avatar empty"},ne={class:"entry-main"},ie={class:"entry-head"},oe={class:"entry-name"},ce={class:"entry-sub"},re={key:0,class:"empty-state"},de={class:"sheet"},ue={class:"flex items-center mb-3"},ve={class:"avatar-shell"},pe=["src"],me={key:1,class:"avatar empty"},he={class:"ml-2"},_e={class:"sheet-name"},ke={class:"sheet-sub"},be=["disabled"],ge=["disabled"],ye=et({__name:"ConsoleEventManageMobile",setup(fe){const N=st(),P=ut(),b=_(()=>N.params.eventId),M=_(()=>{var e;return(e=v.value)==null?void 0:e.communityId}),w=p(!0),m=p(""),V=_(()=>w.value||!d.value&&!m.value),v=p(null),h=p(null),g=p([]),n=p(null),A=p(null),c=p({}),d=_(()=>v.value?{id:v.value.id,title:at(v.value.title),status:v.value.status,dateTimeText:Y(v.value.startTime,v.value.endTime),locationText:v.value.locationText}:null),I=lt(),{slotMap:B}=I,$=_(()=>I.getStringValue("mobile.console.memberAvatar")||B["mobile.console.memberAvatar"].defaultValue),r=_(()=>{var U;if(!h.value)return null;const e=h.value.totalRegistrations,s=h.value.capacity??e,a=s?Math.min(100,Math.round(e/s*100)):0,x=((U=h.value.avatars)==null?void 0:U.slice(0,5))??[],tt=h.value.groups??[];return{totalConfirmed:e,capacity:s,paidCount:h.value.paidRegistrations,progressPercent:a,sampleParticipants:x.map(u=>({id:u.userId,avatarUrl:u.avatarUrl??$.value})),tickets:tt.map(u=>({id:u.label,name:u.label,confirmed:u.count,capacity:u.capacity??s,progressPercent:u.capacity?Math.min(100,Math.round(u.count/u.capacity*100)):a}))}}),T=_(()=>g.value.map(z));function z(e){var s,a;return{id:e.registrationId,name:e.user.name||"ゲスト",avatarUrl:e.user.avatarUrl??void 0,initials:((s=e.user.name)==null?void 0:s.charAt(0).toUpperCase())??"U",ticketName:((a=e.ticket)==null?void 0:a.name)??"未設定",status:e.status,paymentStatus:e.paymentStatus,attended:e.attended,noShow:e.noShow,createdAtText:new Date(e.createdAt).toLocaleString("ja-JP",{month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"})}}const L=async()=>{if(b.value){w.value=!0,m.value="";try{const[e,s,a]=await Promise.all([ct(b.value),rt(b.value),dt(b.value)]);v.value=e,h.value=s,g.value=a.items}catch(e){console.error("Failed to load event manage page",e),m.value=e instanceof Error?e.message:"数据获取失败"}finally{w.value=!1}}},F=()=>{d.value&&window.open(`/events/${d.value.id}`,"_blank")},J=()=>{if(M.value){P.push({name:"ConsoleMobileCommunityEvents",params:{communityId:M.value}});return}P.back()},q=()=>{d.value&&P.push({path:`/console/events/${d.value.id}/edit`})},G=e=>{switch(e){case"open":return"受付中";case"closed":return"終了";default:return"下書き"}},H=e=>{switch(e){case"open":return"bg-emerald-100 text-emerald-700";case"closed":return"bg-slate-100 text-slate-500";default:return"bg-amber-100 text-amber-700"}},R=e=>{if(e.attended)return"出席済み";if(e.noShow)return"無断欠席";switch(e.status){case"pending":return"審査待ち";case"approved":return"承認済み";case"rejected":return"拒否";case"paid":return"支払済み";case"refunded":return"返金済み";case"pending_refund":return"返金待ち";case"cancelled":return"キャンセル";default:switch(e.paymentStatus){case"paid":return"支払済み";case"unpaid":return"未払い";default:return e.paymentStatus}}},K=e=>e.attended?"bg-emerald-100 text-emerald-700":e.noShow?"bg-rose-100 text-rose-600":e.status==="pending"?"bg-amber-100 text-amber-700":e.status==="approved"||e.status==="paid"?"bg-slate-800 text-white":e.status==="refunded"?"bg-blue-100 text-blue-700":e.status==="pending_refund"?"bg-amber-100 text-amber-700":e.status==="rejected"||e.status==="cancelled"?"bg-slate-100 text-slate-500":e.paymentStatus==="paid"?"bg-slate-800 text-white":"bg-slate-100 text-slate-500",O=()=>{var e;(e=A.value)==null||e.scrollIntoView({behavior:"smooth"})},Q=e=>{n.value=e},C=()=>{n.value=null},W=async()=>{if(n.value){c.value={...c.value,[n.value.id]:!0};try{await vt(b.value,n.value.id),g.value=g.value.map(e=>{var s;return e.registrationId===((s=n.value)==null?void 0:s.id)?{...e,status:"approved"}:e}),C()}catch(e){m.value=e instanceof Error?e.message:"承認に失敗しました"}finally{c.value={...c.value,[n.value.id]:!1}}}},X=async()=>{if(n.value){c.value={...c.value,[n.value.id]:!0};try{await pt(b.value,n.value.id),g.value=g.value.map(e=>{var s;return e.registrationId===((s=n.value)==null?void 0:s.id)?{...e,status:"rejected"}:e}),C()}catch(e){m.value=e instanceof Error?e.message:"拒否に失敗しました"}finally{c.value={...c.value,[n.value.id]:!1}}}},Y=(e,s)=>{const a=new Date(e).toLocaleString("ja-JP",{month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"});if(!s)return a;const x=new Date(s).toLocaleString("ja-JP",{hour:"2-digit",minute:"2-digit"});return`${a}〜${x}`};nt(()=>{L()});const Z=()=>L();return(e,s)=>(o(),i(k,null,[it(ht,{label:"P7"}),t("div",_t,[t("header",{class:"nav-bar"},[t("button",{type:"button",class:"back-btn",onClick:J},"返回")]),V.value?(o(),i("div",kt,[t("div",bt,[s[4]||(s[4]=E('<section class="hero-card skeleton-card" data-v-cc450627><div class="hero-bg faded" data-v-cc450627></div><div class="hero-content" data-v-cc450627><div class="skeleton-line short" data-v-cc450627></div><div class="skeleton-line long mt-3" data-v-cc450627></div><div class="chip-row mt-3" data-v-cc450627><span class="chip skeleton-chip" data-v-cc450627></span><span class="chip skeleton-chip" data-v-cc450627></span></div><div class="hero-actions mt-4" data-v-cc450627><span class="btn ghost skeleton-line" data-v-cc450627></span><span class="btn solid skeleton-line" data-v-cc450627></span></div></div></section>',1)),t("section",gt,[s[1]||(s[1]=E('<div class="skeleton-line medium" data-v-cc450627></div><div class="skeleton-line long mt-2" data-v-cc450627></div><div class="progress mt-4" data-v-cc450627><div class="progress-bar shimmer" style="width:65%;" data-v-cc450627></div></div><div class="stat-grid mt-2" data-v-cc450627><div class="stat-card" data-v-cc450627><div class="skeleton-line medium" data-v-cc450627></div><div class="skeleton-line short mt-3" data-v-cc450627></div></div><div class="stat-card" data-v-cc450627><div class="skeleton-line medium" data-v-cc450627></div><div class="skeleton-line short mt-3" data-v-cc450627></div></div></div>',4)),t("div",yt,[(o(),i(k,null,f(2,a=>t("div",{class:"ticket-row",key:a},[...s[0]||(s[0]=[E('<div class="ticket-meta" data-v-cc450627><span class="ticket-dot" data-v-cc450627></span><span class="skeleton-line short" data-v-cc450627></span></div><div class="ticket-progress shimmer" data-v-cc450627></div><span class="skeleton-line tiny" data-v-cc450627></span>',3)])])),64))])]),t("section",ft,[s[3]||(s[3]=t("div",{class:"skeleton-line medium"},null,-1)),(o(),i(k,null,f(4,a=>t("div",{class:"skeleton-entry",key:"entry-"+a},[...s[2]||(s[2]=[E('<div class="avatar-shell" data-v-cc450627><span class="avatar empty shimmer" data-v-cc450627></span></div><div class="entry-main" data-v-cc450627><div class="skeleton-line medium" data-v-cc450627></div><div class="skeleton-line long mt-2" data-v-cc450627></div></div>',2)])])),64))])])])):m.value?(o(),i("section",wt,[s[5]||(s[5]=t("p",{class:"eyebrow"},"加载失败",-1)),t("p",Ct,l(m.value),1),t("button",{class:"btn solid mt-3 w-full",onClick:Z},"重试加载")])):d.value?(o(),i(k,{key:2},[t("section",xt,[s[11]||(s[11]=t("div",{class:"hero-bg"},null,-1)),t("div",Et,[t("div",St,[t("div",Pt,[s[8]||(s[8]=t("p",{class:"eyebrow"},"Console · イベント管理",-1)),t("h1",Tt,l(d.value.title),1),t("div",Mt,[t("span",At,[s[6]||(s[6]=t("span",{class:"i-lucide-calendar mr-1"},null,-1)),S(l(d.value.dateTimeText),1)]),t("span",It,[s[7]||(s[7]=t("span",{class:"i-lucide-map-pin mr-1"},null,-1)),S(l(d.value.locationText),1)])])]),t("span",{class:j(["status-chip",H(d.value.status)])},l(G(d.value.status)),3)]),t("div",{class:"hero-actions"},[t("button",{class:"btn ghost",onClick:F},[...s[9]||(s[9]=[t("span",{class:"i-lucide-external-link mr-1.5"},null,-1),S(" 前台ページを見る ",-1)])]),t("button",{class:"btn solid",onClick:q},[...s[10]||(s[10]=[t("span",{class:"i-lucide-pencil mr-1.5"},null,-1),S(" イベントを編集 ",-1)])])])])]),r.value?(o(),i("section",Lt,[t("div",Rt,[t("div",null,[s[12]||(s[12]=t("p",{class:"eyebrow"},"申込状況",-1)),t("h2",Ut,"合計 "+l(r.value.totalConfirmed)+"/"+l(r.value.capacity)+" 人",1),t("p",jt,"うち "+l(r.value.paidCount)+" 人が支払い済み",1)]),t("div",Dt,"進捗 "+l(r.value.progressPercent)+"%",1)]),t("div",Nt,[t("div",{class:"progress-bar",style:D({width:r.value.progressPercent+"%"})},null,4)]),t("div",Vt,[t("div",Bt,[s[13]||(s[13]=t("p",{class:"stat-label"},"現在の確定",-1)),t("p",$t,l(r.value.totalConfirmed),1),t("p",zt,"目標 "+l(r.value.capacity)+" 人",1)]),t("div",Ft,[s[14]||(s[14]=t("p",{class:"stat-label"},"支払い済み",-1)),t("p",Jt,l(r.value.paidCount),1),s[15]||(s[15]=t("p",{class:"stat-hint"},"リアルタイム更新",-1))])]),r.value.tickets.length?(o(),i("div",qt,[s[17]||(s[17]=t("p",{class:"eyebrow mb-2"},"チケット別",-1)),(o(!0),i(k,null,f(r.value.tickets,a=>(o(),i("div",{key:a.id,class:"ticket-row"},[t("div",Gt,[s[16]||(s[16]=t("span",{class:"ticket-dot"},null,-1)),t("span",Ht,l(a.name),1)]),t("div",Kt,[t("div",{class:"ticket-progress-bar",style:D({width:a.progressPercent+"%"})},null,4)]),t("span",Ot,l(a.confirmed)+"/"+l(a.capacity),1)]))),128))])):y("",!0),t("div",Qt,[t("div",Wt,[(o(!0),i(k,null,f(r.value.sampleParticipants,a=>(o(),i("img",{key:a.id,src:a.avatarUrl,class:"avatar",alt:"participant"},null,8,Xt))),128))]),t("button",{class:"link-btn",onClick:O},"参加者一覧を見る")])])):(o(),i("section",Yt,[...s[18]||(s[18]=[t("p",{class:"eyebrow"},"申込状況",-1),t("h2",{class:"panel-title"},"まだデータがありません",-1),t("p",{class:"muted"},"发布或有报名后，会自动呈现进度和票种分布。",-1)])])),t("section",{class:"panel",ref_key:"memberListRef",ref:A},[t("div",Zt,[s[19]||(s[19]=t("div",null,[t("p",{class:"eyebrow"},"参加者"),t("h2",{class:"panel-title"},"リスト")],-1)),t("span",te,l(T.value.length)+" 人",1)]),(o(!0),i(k,null,f(T.value,a=>(o(),i("div",{key:a.id,class:"entry-row",onClick:x=>Q(a)},[t("div",se,[a.avatarUrl?(o(),i("img",{key:0,src:a.avatarUrl,class:"avatar",alt:""},null,8,ae)):(o(),i("span",le,l(a.initials),1))]),t("div",ne,[t("div",ie,[t("p",oe,l(a.name),1),t("span",{class:j(["entry-chip",K(a)])},l(R(a)),3)]),t("p",ce,l(a.ticketName)+" · "+l(a.createdAtText),1)]),s[20]||(s[20]=t("span",{class:"i-lucide-chevron-right text-slate-300"},null,-1))],8,ee))),128)),!T.value.length&&!w.value?(o(),i("div",re,"まだ参加者がいません。")):y("",!0)],512),n.value?(o(),i("div",{key:2,class:"sheet-mask",onClick:ot(C,["self"])},[t("div",de,[s[21]||(s[21]=t("div",{class:"sheet-handle"},null,-1)),t("div",ue,[t("div",ve,[n.value.avatarUrl?(o(),i("img",{key:0,src:n.value.avatarUrl,class:"avatar",alt:""},null,8,pe)):(o(),i("span",me,l(n.value.initials),1))]),t("div",he,[t("p",_e,l(n.value.name),1),t("p",ke,l(n.value.ticketName)+" · "+l(R(n.value)),1)])]),n.value.status==="pending"?(o(),i("button",{key:0,class:"sheet-action",disabled:c.value[n.value.id],onClick:W},l(c.value[n.value.id]?"処理中…":"承認する"),9,be)):y("",!0),n.value.status==="pending"?(o(),i("button",{key:1,class:"sheet-action danger",disabled:c.value[n.value.id],onClick:X},l(c.value[n.value.id]?"処理中…":"拒否する"),9,ge)):y("",!0),t("button",{class:"sheet-close",onClick:C},"閉じる")])])):y("",!0)],64)):y("",!0)])],64))}}),xe=mt(ye,[["__scopeId","data-v-cc450627"]]);export{xe as default};
