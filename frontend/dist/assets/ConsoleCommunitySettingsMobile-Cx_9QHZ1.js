import{d as te,A as oe,B as ae,r as u,c as ne,o as ie,b as r,h as l,q as P,u as re,t as p,i as V,v as w,x as I,F as H,f as W,j as q,w as de,a8 as ue,a as C,g as ce,aa as pe,ab as z,ac as ve,e as d,K as ge,_ as me}from"./index-BGcABSEi.js";const be={class:"community-settings"},fe={class:"hero-card"},ye={class:"hero-text"},_e={class:"hero-status"},he={class:"form-card"},we={class:"ios-field"},Ue={class:"ios-field"},ke={class:"form-card"},Ie={class:"ios-field"},Ce={key:0,class:"chip-row"},Le={class:"form-card"},xe={class:"radio-group"},Se=["value"],Fe={class:"radio-content"},Ee={class:"radio-title"},Ve={class:"radio-desc"},De={class:"form-card"},Me={class:"upload-grid"},Ae={class:"upload-card"},Be={key:0,class:"upload-preview"},Oe=["src"],Te={key:1,class:"upload-empty"},Re={class:"upload-card"},$e={key:0,class:"upload-preview"},je=["src"],Ne={key:1,class:"upload-empty"},Pe={class:"form-card"},He={class:"card-head"},We={class:"card-head__right"},qe=["disabled"],ze={key:0,class:"stripe-hint"},Ke=["href"],Xe={key:0,class:"form-error"},Ye={class:"form-footer"},Ge=["disabled"],Je=["disabled"],Qe=te({__name:"ConsoleCommunitySettingsMobile",setup(Ze){const K=oe(),D=re(),g=K.params.communityId,t=ae({name:"",slug:"",labels:"",visibleLevel:"public",coverImageUrl:"",logoImageUrl:"",description:""}),m=u(null),b=u(null),M=u(null),A=u(null),L=u(!1),x=u(!1),f=u(!1),v=u(null),X=[{value:"public",label:"公開",desc:"誰でも閲覧できる"},{value:"semi-public",label:"社群限定",desc:"Console / 既存メンバーのみ"},{value:"private",label:"非公開",desc:"運営メモ用・外部非公開"}],S=ne(()=>t.labels.split(",").map(s=>s.trim()).filter(Boolean)),B=async()=>{if(g)try{const s=await ue(g);t.name=s.name,t.slug=s.slug,t.labels=(s.labels||[]).join(", "),t.visibleLevel=s.visibleLevel??"public",t.coverImageUrl=s.coverImageUrl||"",m.value=t.coverImageUrl?C(t.coverImageUrl):null;const e=typeof s.description=="object"&&s.description?s.description:null;t.description=ce(s.description),t.logoImageUrl=(e==null?void 0:e.logoImageUrl)??"",b.value=t.logoImageUrl?C(t.logoImageUrl):null,y.value=(e==null?void 0:e._stripeOnboardLink)??null}catch(s){v.value=s instanceof Error?s.message:"社群情報の取得に失敗しました"}},Y=()=>({original:t.description,lang:"ja",translations:{},logoImageUrl:t.logoImageUrl||null,_stripeOnboardLink:y.value||null}),G=()=>{var s;return(s=M.value)==null?void 0:s.click()},J=()=>{var s;return(s=A.value)==null?void 0:s.click()},U=u(!1),y=u(null),Q=async()=>{U.value=!0,v.value=null;try{const{url:s}=await pe(g);y.value=s,window.open(s,"_blank")}catch(s){v.value=s instanceof Error?s.message:"Stripe 連携リンクの取得に失敗しました"}finally{U.value=!1}},O=(s,e,o)=>new Promise((n,a)=>{const c=new FileReader;c.onload=()=>{const i=new Image;i.onload=()=>{const{width:$,height:F}=i;let _=$,h=_/e;h>F&&(h=F,_=h*e);const le=($-_)/2,se=(F-h)/2,E=Math.min(o,_),j=E/e,k=document.createElement("canvas");k.width=E,k.height=j;const N=k.getContext("2d");if(!N){a(new Error("Canvas not supported"));return}N.drawImage(i,le,se,_,h,0,0,E,j),n(k.toDataURL("image/jpeg",.85))},i.onerror=()=>a(new Error("Failed to load image")),i.src=c.result},c.onerror=()=>a(new Error("Failed to read file")),c.readAsDataURL(s)}),T=async(s,e)=>{const n=await(await fetch(s)).blob();return new File([n],e,{type:n.type||"image/jpeg"})},Z=async s=>{var n;const o=(n=s.target.files)==null?void 0:n[0];if(!(!o||L.value)){L.value=!0;try{const a=await O(o,1.7777777777777777,1280);m.value=a;const c=await T(a,`cover-${Date.now()}.jpg`),{imageUrl:i}=await z(c,"cover");t.coverImageUrl=i,m.value=C(i)}catch(a){console.warn(a)}finally{L.value=!1}}},ee=async s=>{var n;const o=(n=s.target.files)==null?void 0:n[0];if(!(!o||x.value)){x.value=!0;try{const a=await O(o,1,512);b.value=a;const c=await T(a,`logo-${Date.now()}.jpg`),{imageUrl:i}=await z(c,"logo");t.logoImageUrl=i,b.value=C(i)}catch(a){console.warn(a)}finally{x.value=!1}}},R=async()=>{if(!g)return;f.value=!0,v.value=null;const s={labels:S.value,visibleLevel:t.visibleLevel,coverImageUrl:t.coverImageUrl||null,logoImageUrl:t.logoImageUrl||null,description:Y()};try{await ve(g,s),await B()}catch(e){v.value=e instanceof Error?e.message:"更新に失敗しました"}finally{f.value=!1}};return ie(B),(s,e)=>(d(),r("div",be,[l("header",fe,[l("button",{class:"hero-back",type:"button",onClick:e[0]||(e[0]=o=>P(D).back())},[...e[7]||(e[7]=[l("span",{class:"i-lucide-chevron-left"},null,-1)])]),l("div",ye,[e[8]||(e[8]=l("p",{class:"hero-eyebrow"},"社群設定",-1)),l("h1",null,p(t.name||"コミュニティ"),1),e[9]||(e[9]=l("p",{class:"hero-subtext"},"公開情報と AI が参照するプロフィールをここで管理します。",-1))]),l("span",_e,p(t.visibleLevel==="private"?"非公開":"公開中"),1)]),l("form",{class:"form-sections",onSubmit:de(R,["prevent"])},[l("section",he,[e[12]||(e[12]=l("p",{class:"card-label"},"基本情報",-1)),l("div",we,[e[10]||(e[10]=l("label",null,"社群名称",-1)),w(l("input",{"onUpdate:modelValue":e[1]||(e[1]=o=>t.name=o),type:"text",placeholder:"Tokyo Community...",disabled:""},null,512),[[I,t.name]])]),l("div",Ue,[e[11]||(e[11]=l("label",null,"Slug",-1)),w(l("input",{"onUpdate:modelValue":e[2]||(e[2]=o=>t.slug=o),type:"text",disabled:""},null,512),[[I,t.slug]])])]),l("section",ke,[e[14]||(e[14]=l("div",{class:"card-head"},[l("p",{class:"card-label"},"ラベル"),l("p",{class:"card-hint"},"活動領域やキーワードをカンマ区切りで追加")],-1)),l("div",Ie,[e[13]||(e[13]=l("label",null,"キーワード",-1)),w(l("input",{"onUpdate:modelValue":e[3]||(e[3]=o=>t.labels=o),type:"text",placeholder:"多文化, 親子, コミュニティ"},null,512),[[I,t.labels]])]),S.value.length?(d(),r("div",Ce,[(d(!0),r(H,null,W(S.value,o=>(d(),r("span",{key:o,class:"chip"},p(o),1))),128))])):V("",!0)]),l("section",Le,[e[15]||(e[15]=l("div",{class:"card-head"},[l("p",{class:"card-label"},"公開範囲"),l("p",{class:"card-hint"},"ユーザー側にどこまで表示するかを選びます")],-1)),l("div",xe,[(d(),r(H,null,W(X,o=>l("label",{key:o.value,class:"radio-tile"},[w(l("input",{"onUpdate:modelValue":e[4]||(e[4]=n=>t.visibleLevel=n),value:o.value,type:"radio"},null,8,Se),[[ge,t.visibleLevel]]),l("div",Fe,[l("p",Ee,p(o.label),1),l("p",Ve,p(o.desc),1)])])),64))])]),l("section",De,[e[20]||(e[20]=l("p",{class:"card-label"},"ビジュアル",-1)),l("div",Me,[l("div",Ae,[e[17]||(e[17]=l("p",{class:"upload-title"},"ロゴ",-1)),l("div",{class:"upload-drop",onClick:J},[l("input",{ref_key:"logoInput",ref:A,type:"file",accept:"image/*",class:"hidden-input",onChange:ee},null,544),b.value?(d(),r("div",Be,[l("img",{src:b.value,alt:"logo preview"},null,8,Oe)])):(d(),r("div",Te,[...e[16]||(e[16]=[l("span",{class:"i-lucide-image-plus"},null,-1),l("p",null,"タップしてアップロード",-1)])]))])]),l("div",Re,[e[19]||(e[19]=l("p",{class:"upload-title"},"カバー画像",-1)),l("div",{class:"upload-drop",onClick:G},[l("input",{ref_key:"coverInput",ref:M,type:"file",accept:"image/*",class:"hidden-input",onChange:Z},null,544),m.value?(d(),r("div",$e,[l("img",{src:m.value,alt:"cover preview"},null,8,je)])):(d(),r("div",Ne,[...e[18]||(e[18]=[l("span",{class:"i-lucide-image-plus"},null,-1),l("p",null,"タップしてアップロード",-1)])]))])])])]),l("section",Pe,[l("div",He,[e[23]||(e[23]=l("p",{class:"card-label"},"社群紹介",-1)),l("div",We,[e[22]||(e[22]=l("p",{class:"card-hint"},"AI の憲法/歓迎文にも引用されます",-1)),l("button",{class:"link-btn",type:"button",disabled:U.value,onClick:Q},[e[21]||(e[21]=l("span",{class:"i-lucide-credit-card"},null,-1)),q(" "+p(U.value?"接続中…":"Stripe収款を連携"),1)],8,qe)])]),w(l("textarea",{"onUpdate:modelValue":e[5]||(e[5]=o=>t.description=o),rows:"6",placeholder:"社群のビジョン・活動内容・歓迎する人などを記載してください。"},null,512),[[I,t.description]]),y.value?(d(),r("p",ze,[e[24]||(e[24]=q(" リンクを開けない場合はこちら: ",-1)),l("a",{href:y.value,target:"_blank"},"Stripe Onboard",8,Ke)])):V("",!0)]),v.value?(d(),r("p",Xe,p(v.value),1)):V("",!0)],32),l("footer",Ye,[l("button",{type:"button",class:"ghost-btn",disabled:f.value,onClick:e[6]||(e[6]=o=>P(D).back())},"戻る",8,Ge),l("button",{type:"button",class:"primary-btn",disabled:f.value,onClick:R},p(f.value?"保存中…":"保存する"),9,Je)])]))}}),ll=me(Qe,[["__scopeId","data-v-0fa1f592"]]);export{ll as default};
