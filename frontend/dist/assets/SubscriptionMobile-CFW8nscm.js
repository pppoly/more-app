import{d as X,a6 as z,r as f,c as I,o as K,b as i,F as M,h as s,i as g,f as $,t as p,w as H,j as J,y as V,at as Q,a8 as Y,e as o,au as Z,a4 as ee,_ as te}from"./index-BGcABSEi.js";var R="https://js.stripe.com/v3",ne=/^https:\/\/js\.stripe\.com\/v3\/?(\?.*)?$/;var ae=function(){for(var t=document.querySelectorAll('script[src^="'.concat(R,'"]')),r=0;r<t.length;r++){var l=t[r];if(ne.test(l.src))return l}return null},q=function(t){var r="",l=document.createElement("script");l.src="".concat(R).concat(r);var e=document.head||document.body;if(!e)throw new Error("Expected document.body not to be null. Stripe.js requires a <body> element.");return e.appendChild(l),l},se=function(t,r){!t||!t._registerWrapper||t._registerWrapper({name:"stripe-js",version:"4.6.0",startTime:r})},E=null,P=null,L=null,re=function(t){return function(){t(new Error("Failed to load Stripe.js"))}},le=function(t,r){return function(){window.Stripe?t(window.Stripe):r(new Error("Stripe.js not available"))}},ie=function(t){return E!==null?E:(E=new Promise(function(r,l){if(typeof window>"u"||typeof document>"u"){r(null);return}if(window.Stripe){r(window.Stripe);return}try{var e=ae();if(!(e&&t)){if(!e)e=q(t);else if(e&&L!==null&&P!==null){var v;e.removeEventListener("load",L),e.removeEventListener("error",P),(v=e.parentNode)===null||v===void 0||v.removeChild(e),e=q(t)}}L=le(r,l),P=re(l),e.addEventListener("load",L),e.addEventListener("error",P)}catch(m){l(m);return}}),E.catch(function(r){return E=null,Promise.reject(r)}))},oe=function(t,r,l){if(t===null)return null;var e=t.apply(void 0,r);return se(e,l),e},k,W=!1,G=function(){return k||(k=ie(null).catch(function(t){return k=null,Promise.reject(t)}),k)};Promise.resolve().then(function(){return G()}).catch(function(d){W||console.warn(d)});var ue=function(){for(var t=arguments.length,r=new Array(t),l=0;l<t;l++)r[l]=arguments[l];W=!0;var e=Date.now();return G().then(function(v){return oe(v,r,e)})};const ce={class:"sub-header"},de=["disabled"],ve={key:0,class:"empty"},me={key:1,class:"empty"},pe={key:2,class:"plan-list"},fe=["disabled","onClick"],ye={class:"plan-head"},he={class:"plan-name"},_e={class:"plan-price"},be={key:0},we={key:1},Se={key:0,class:"plan-badge"},ge={class:"plan-meta"},Ee={class:"plan-meta"},ke={class:"plan-meta"},Ce={class:"plan-action"},Pe={key:0,class:"loading"},Le={key:1,class:"loading"},je={key:2,class:"current"},Fe={key:3,class:"action-cta"},xe={key:0,class:"empty"},Ae={key:3,class:"error"},Be={class:"payment-sheet"},Ie={class:"pay-header"},Te={class:"pay-title"},Me=["disabled"],Ve={key:0,class:"pay-amount"},qe=["disabled"],Re={key:0,class:"spinner"},We={key:1,class:"error"},Ge=X({__name:"SubscriptionMobile",setup(d){const t=z(),r=f([]),l=f(!1),e=f(null),v=f(null),m=f(!1),h=f(null),_=f(null),j=f(null);let b=null,w=null,y=null;const S=I(()=>t.activeCommunityId.value),F=I(()=>{var a;return((a=t.getActiveCommunity())==null?void 0:a.pricingPlanId)??null}),T=async()=>{e.value=null,l.value=!0;try{r.value=await Q()}catch(a){e.value=a instanceof Error?a.message:"无法获取套餐列表"}finally{l.value=!1}},N=a=>{if(!a.features||typeof a.features!="object")return"基础支持";const n=Object.values(a.features).flat();return n.length?n.slice(0,3).join(" / "):"基础支持"},D=async a=>{var n;if(!(!S.value||v.value)){v.value=a,e.value=null;try{const u=await Z(S.value,a);if(u.clientSecret&&u.publishableKey)_.value=a,h.value=u.clientSecret,await O(u.clientSecret,u.publishableKey);else{if((n=x(a))!=null&&n.monthlyFee&&x(a).monthlyFee>0)throw new Error("支付配置缺失，请检查后端 Stripe publishable key");await C(),window.alert("已切换套餐")}}catch(u){e.value=u instanceof Error?u.message:"订阅失败"}finally{v.value=null}}},x=a=>r.value.find(n=>n.id===a),A=I(()=>_.value?x(_.value):null),C=async()=>{await t.loadCommunities(!0),S.value&&(t.setActiveCommunity(S.value),await Y(S.value).catch(()=>{})),await T()};K(async()=>{t.loaded.value||(await t.loadCommunities(),t.ensureActiveCommunity()),await T()});const O=async(a,n)=>{if(!n)throw new Error("缺少 Stripe publishable key");if(b=await ue(n),!b)throw new Error("Stripe 初始化失败");w=b.elements({clientSecret:a,appearance:{theme:"flat"}}),await ee(),y&&y.unmount(),j.value&&(y=w.create("payment"),y.mount(j.value))},B=()=>{h.value=null,_.value=null,m.value=!1,y&&(y.unmount(),y=null),w=null,b=null},U=async()=>{if(!b||!w||!h.value){e.value="支付信息未准备好";return}m.value=!0,e.value=null;try{const{error:a}=await w.submit();if(a){e.value=a.message||"请检查支付信息后重试",m.value=!1;return}const{error:n,paymentIntent:u}=await b.confirmPayment({elements:w,clientSecret:h.value,redirect:"if_required",confirmParams:{return_url:window.location.href}});if(n){e.value=n.message||"支付失败，请重试";return}(u==null?void 0:u.status)==="succeeded"||(u==null?void 0:u.status)==="processing"?(B(),window.alert("支付提交成功，状态同步中，请稍后刷新查看。"),await C()):(window.alert("支付处理中，请稍后查看状态。"),await C())}catch(a){console.error("confirmPayment failed",a),e.value=a instanceof Error?a.message:"支付失败，请重试"}finally{m.value=!1}};return(a,n)=>{var u;return o(),i("div",{class:V(["subscription-page",{"subscription-page--payment":!!h.value}])},[h.value?(o(),i("div",{key:1,class:"payment-overlay",onClick:H(B,["self"])},[s("section",Be,[s("header",Ie,[n[5]||(n[5]=s("div",{class:"pay-handle"},null,-1)),s("div",Te,[n[3]||(n[3]=s("p",{class:"sub-label"},"支付确认",-1)),s("h1",null,p(((u=A.value)==null?void 0:u.name)||"套餐支付"),1)]),s("button",{class:"close-btn",type:"button",disabled:m.value,onClick:B},[...n[4]||(n[4]=[s("span",{class:"i-lucide-x"},null,-1)])],8,Me)]),A.value?(o(),i("div",Ve," ¥"+p(A.value.monthlyFee)+"/月 ",1)):g("",!0),n[7]||(n[7]=s("div",{class:"payment-tip"},"请在应用内完成支付，成功后自动开通套餐",-1)),s("div",{ref_key:"paymentElementContainer",ref:j,class:"payment-element"},null,512),s("button",{class:"pay-btn",type:"button",disabled:m.value,onClick:U},[m.value?(o(),i("span",Re)):g("",!0),n[6]||(n[6]=J(" 确认并支付 ",-1))],8,qe),e.value?(o(),i("p",We,p(e.value),1)):g("",!0)])])):(o(),i(M,{key:0},[s("header",ce,[n[1]||(n[1]=s("div",null,[s("p",{class:"sub-label"},"订阅计划"),s("h1",null,"选择你的收款能力")],-1)),s("button",{class:"refresh-btn",type:"button",onClick:C,disabled:l.value||m.value},[...n[0]||(n[0]=[s("span",{class:"i-lucide-refresh-ccw"},null,-1)])],8,de)]),l.value?(o(),i("div",ve,"加载中…")):S.value?(o(),i("div",pe,[(o(!0),i(M,null,$(r.value,c=>(o(),i("button",{key:c.id,class:V(["plan-card",{active:c.id===F.value,paying:_.value===c.id}]),type:"button",disabled:v.value===c.id||m.value,onClick:Ne=>D(c.id)},[s("div",ye,[s("div",null,[s("p",he,p(c.name),1),s("p",_e,[c.monthlyFee>0?(o(),i("span",be,"¥"+p(c.monthlyFee)+"/月",1)):(o(),i("span",we,"免费"))])]),c.id===F.value?(o(),i("span",Se,"当前")):g("",!0)]),s("p",ge,"手续费："+p(c.transactionFeePercent)+"% + ¥"+p(c.transactionFeeFixed),1),s("p",Ee,"结算："+p(c.payoutSchedule),1),s("p",ke,"功能："+p(N(c)),1),s("div",Ce,[v.value===c.id?(o(),i("span",Pe,"处理中...")):_.value===c.id?(o(),i("span",Le,"填写支付信息")):c.id===F.value?(o(),i("span",je,"已订阅")):(o(),i("span",Fe,"开通"))])],10,fe))),128)),r.value.length?g("",!0):(o(),i("div",xe,"暂无可选套餐"))])):(o(),i("div",me,[...n[2]||(n[2]=[s("p",null,"请先选择一个社群再订阅套餐。",-1)])])),e.value?(o(),i("p",Ae,p(e.value),1)):g("",!0)],64))],2)}}}),Oe=te(Ge,[["__scopeId","data-v-c7cc6d06"]]);export{Oe as default};
