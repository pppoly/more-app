import{d as H,b as i,S as ie,q as j,i as g,T as re,p as J,U as Y,e as n,l as ce,r as v,B as ue,c as x,A as de,g as ve,C as me,o as pe,u as he,h as a,t as r,j as M,F as fe,f as ye,y as ge,z as K,s as U,E as be,P as R,L as _e,Q as ke,R as xe,V as q,M as Ee,N as Te,_ as Ie}from"./index-CT-XDF2b.js";const Se=["disabled"],Ce={key:0,class:"mr-2 inline-flex items-center text-lg"},we={key:1,class:"ml-2 inline-flex items-center text-lg"},Me="inline-flex items-center justify-center font-medium rounded-full transition-all duration-150 active:scale-[0.98] focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 disabled:opacity-50 disabled:cursor-not-allowed gap-2",G=H({__name:"Button",props:{variant:{default:"primary"},size:{default:"md"},disabled:{type:Boolean,default:!1},iconLeft:{},iconRight:{}},setup(m){const F=m,E={primary:"bg-gradient-to-r from-[#0090D9] via-[#22BBAA] to-[#E4C250] text-white shadow-lg shadow-cyan-500/20 hover:brightness-110 active:brightness-95",outline:"bg-white text-[#0088CC] border-[1.5px] border-[#0088CC] hover:bg-[#E8F6FF]",ghost:"bg-[#F2FBFF] text-[#0088CC] border border-[#BEE3F8] hover:bg-[#E8F6FF]"},p={sm:"h-8 px-4 text-xs",md:"h-10 px-5 text-sm",lg:"h-12 px-6 text-base"},{variant:T,size:l}=F;return(b,y)=>(n(),i("button",ie({class:[Me,E[j(T)],p[j(l)]],disabled:m.disabled},b.$attrs),[m.iconLeft?(n(),i("span",Ce,[(n(),J(Y(m.iconLeft)))])):g("",!0),re(b.$slots,"default"),m.iconRight?(n(),i("span",we,[(n(),J(Y(m.iconRight)))])):g("",!0)],16,Se))}}),Re={class:"mobile-checkout"},Fe={class:"checkout-header"},Ae={class:"header-info"},Pe={key:0,class:"checkout-skeleton"},Ne={key:1,class:"state-card state-card--error"},Be={key:2,class:"checkout-body"},De={class:"hero-card"},$e={class:"hero-title"},Le={class:"hero-meta"},Oe={class:"hero-meta"},ze={class:"hero-price"},Ve={class:"ios-panel"},je={key:0,class:"confirm-list"},Je={class:"confirm-label"},Ye={class:"confirm-value"},Ke={key:1,class:"panel-hint"},Ue={class:"ios-panel"},qe={class:"checkout-actions"},Ge=["disabled"],He={key:0,class:"payment-hint"},Qe={key:1,class:"payment-hint subtle"},We={key:2,class:"payment-buttons"},Xe={key:0,class:"ios-error"},Ze=30*60*1e3,et=H({__name:"MobileEventCheckout",props:{eventId:{}},setup(m){const F=m,E=de(),p=he(),{user:T}=ce(),l=v(null),b=v(!0),y=v(null),_=v(!1),h=v(null),f=v(null),I=v(null),S=v(!1),C=v(!1),A=v(null),k=ue({}),d=x(()=>F.eventId??E.params.eventId),P=new Intl.NumberFormat("ja-JP",{style:"currency",currency:"JPY",maximumFractionDigits:0}),Q=e=>{var u;if(!((u=e==null?void 0:e.ticketTypes)!=null&&u.length))return"無料 / 未定";const t=e.ticketTypes.map(w=>w.price??0),s=Math.min(...t),o=Math.max(...t);return o===0?"無料":s===o?P.format(o):`${P.format(s)} 〜 ${P.format(o)}`},N=(e,t)=>{var s,o;if(ke(e)){const u=(o=(s=e.response)==null?void 0:s.data)==null?void 0:o.message;if(typeof u=="string")return u;if(Array.isArray(u)&&u.length){const w=u[0];if(typeof w=="string")return w}return e.message}return e instanceof Error?e.message:t},c=x(()=>{var s;if(!l.value)return null;const e=V(l.value.startTime),t=l.value.endTime?V(l.value.endTime):"未定";return{id:l.value.id,title:ve(l.value.title),timeText:`${e} 〜 ${t}`,locationText:l.value.locationText||"場所未定",priceText:((s=l.value.config)==null?void 0:s.priceText)??Q(l.value)}}),L=x(()=>{var e;return((e=l.value)==null?void 0:e.registrationFormSchema)??[]}),W=x(()=>{var t,s;if(!((s=(t=l.value)==null?void 0:t.ticketTypes)!=null&&s.length))return null;const e=l.value.ticketTypes.find(o=>(o.price??0)>0)??l.value.ticketTypes[0];return(e==null?void 0:e.id)??null}),B=x(()=>A.value?new Date(A.value).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}):null),D=e=>c.value?{eventId:c.value.id,title:c.value.title,timeText:c.value.timeText,locationText:c.value.locationText,priceText:c.value.priceText,paymentStatus:e,holdExpiresAt:new Date(Date.now()+Ze).toISOString()}:null,O=e=>{sessionStorage.setItem(xe,JSON.stringify(e)),p.replace({name:"MobileEventSuccess",params:{eventId:e.eventId}})},X=e=>{const t=D("paid");if(!t)return;A.value=t.holdExpiresAt;const s={...t,registrationId:e.registrationId};sessionStorage.setItem(q,JSON.stringify(s))},Z=()=>{sessionStorage.removeItem(q)},$=async()=>{if(!d.value){y.value="イベントが見つかりませんでした。";return}b.value=!0,y.value=null;try{l.value=await be(d.value),ee()}catch(e){y.value=N(e,"イベント情報の取得に失敗しました")}finally{b.value=!1}};me(()=>d.value,(e,t)=>{e&&e!==t&&T.value&&$()});const ee=()=>{try{const e=sessionStorage.getItem(R);if(!e){y.value="入力情報が見つかりませんでした。もう一度入力してください。",p.replace({name:"MobileEventRegister",params:{eventId:d.value}});return}const t=JSON.parse(e);if((t==null?void 0:t.eventId)!==d.value||!(t!=null&&t.answers)){p.replace({name:"MobileEventRegister",params:{eventId:d.value}});return}Object.keys(k).forEach(s=>delete k[s]),Object.assign(k,t.answers)}catch{p.replace({name:"MobileEventRegister",params:{eventId:d.value}})}};pe(()=>{if(!T.value){p.replace({name:"organizer-apply",query:{redirect:E.fullPath}});return}$()});const te=async()=>{if(d.value){_.value=!0,h.value=null;try{const e=await _e(d.value,{ticketTypeId:W.value??void 0,formAnswers:{...k}});se(e),sessionStorage.removeItem(R)}catch(e){h.value=N(e,"申込に失敗しました")}finally{_.value=!1}}},se=e=>{if(e.paymentRequired){f.value={registrationId:e.registrationId,amount:e.amount},X(e);const t=B.value;I.value=t?`お支払いを完了すると参加が確定します。枠は ${t} まで保持されます。`:"お支払いを完了すると参加が確定します。",sessionStorage.removeItem(R)}else{f.value=null;const t=D("free");sessionStorage.removeItem(R),t&&O(t)}},ae=async()=>{if(f.value){S.value=!0,h.value=null;try{await Ee(f.value.registrationId),f.value=null,I.value="お支払いが完了しました。参加が確定です。",Z();const e=D("paid");if(e){O(e);return}}catch(e){h.value=N(e,"決済処理に失敗しました")}finally{S.value=!1}}},ne=async()=>{var e,t;if(f.value){C.value=!0,h.value=null;try{const{checkoutUrl:s}=await Te(f.value.registrationId);window.location.href=s}catch(s){const o=((t=(e=s==null?void 0:s.response)==null?void 0:e.data)==null?void 0:t.message)??(s instanceof Error?s.message:"Stripe Checkoutの開始に失敗しました");h.value=o,C.value=!1}}},le=()=>{p.push({name:"MobileEventRegister",params:{eventId:d.value}})},z=(e,t)=>e.id??`${e.label??"field"}-${t}`,oe=(e,t)=>{const s=k[z(e,t)];return Array.isArray(s)?s.length?s.join(", "):"未入力":typeof s=="boolean"?s?"はい":"いいえ":s||"未入力"},V=e=>new Date(e).toLocaleDateString(void 0,{month:"short",day:"numeric",weekday:"short",hour:"2-digit"});return(e,t)=>{var s;return n(),i("div",Re,[a("header",Fe,[a("button",{class:"back-button",type:"button",onClick:le},[...t[0]||(t[0]=[a("span",{class:"i-lucide-chevron-left text-lg"},null,-1)])]),a("div",Ae,[t[1]||(t[1]=a("p",{class:"header-label"},"確認と決済",-1)),a("h1",null,r(((s=c.value)==null?void 0:s.title)??"読み込み中…"),1)])]),b.value?(n(),i("section",Pe,[...t[2]||(t[2]=[a("div",{class:"skeleton-hero shimmer"},null,-1),a("div",{class:"skeleton-card shimmer"},null,-1),a("div",{class:"skeleton-card shimmer"},null,-1)])])):y.value?(n(),i("section",Ne,[M(r(y.value)+" ",1),a("button",{type:"button",class:"retry-btn",onClick:$},"再試行")])):c.value?(n(),i("section",Be,[a("article",De,[t[3]||(t[3]=a("p",{class:"hero-label"},"参加概要",-1)),a("h2",$e,r(c.value.title),1),a("p",Le,r(c.value.timeText),1),a("p",Oe,r(c.value.locationText),1),a("p",ze,r(c.value.priceText),1)]),a("article",Ve,[t[4]||(t[4]=a("header",{class:"panel-head"},[a("div",null,[a("p",{class:"panel-label"},"入力内容の確認"),a("p",{class:"panel-hint"},"この内容で主催者に送信されます。")])],-1)),L.value.length?(n(),i("ul",je,[(n(!0),i(fe,null,ye(L.value,(o,u)=>(n(),i("li",{key:z(o,u)},[a("p",Je,r(o.label),1),a("p",Ye,r(oe(o,u)),1)]))),128))])):(n(),i("p",Ke,"特別な入力項目はありませんでした。"))]),a("article",Ue,[t[6]||(t[6]=a("header",{class:"panel-head"},[a("div",null,[a("p",{class:"panel-label"},"決済・完了"),a("p",{class:"panel-hint"},"申込を確定後、必要に応じて決済へ進みます。")])],-1)),a("div",qe,[a("button",{type:"button",class:ge(["rails-cta",{"is-disabled":_.value}]),disabled:_.value,onClick:te},[t[5]||(t[5]=a("span",{class:"i-lucide-check-circle"},null,-1)),M(" "+r(_.value?"処理中…":"申込を確定する"),1)],10,Ge),I.value?(n(),i("p",He,r(I.value),1)):g("",!0),B.value?(n(),i("p",Qe," 枠は "+r(B.value)+" まで保持されます。 ",1)):g("",!0),f.value?(n(),i("div",We,[K(G,{variant:"primary",size:"md",class:"flex-1 justify-center",disabled:C.value,onClick:ne},{default:U(()=>[M(r(C.value?"Stripeへ移動中…":"Stripeで支払う"),1)]),_:1},8,["disabled"]),K(G,{variant:"outline",size:"md",class:"flex-1 justify-center",disabled:S.value,onClick:ae},{default:U(()=>[M(r(S.value?"Mock 決済中…":"Mock 支払い（デモ）"),1)]),_:1},8,["disabled"])])):g("",!0)]),h.value?(n(),i("p",Xe,r(h.value),1)):g("",!0)])])):g("",!0)])}}}),st=Ie(et,[["__scopeId","data-v-38433564"]]);export{st as default};
