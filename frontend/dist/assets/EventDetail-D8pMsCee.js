import{d as ie,B as de,u as ve,c as m,r as h,C as he,m as pe,D as ye,o as me,g as O,e as l,f as o,i as e,j as v,t as u,F as g,h as E,z as j,k as _,w as x,x as F,J as _e,y as ke,K as be,L as ge,G as fe,H as we,M as Ce,N as Me,O as Ee,_ as qe}from"./index-DncFUGrq.js";const Te={class:"detail-shell"},Re={key:0,class:"detail-skeleton"},Le={key:1,class:"status error"},Se={key:0,class:"hero"},Ue=["src"],Fe={class:"hero-overlay"},Ie={class:"hero-title"},Ve={class:"hero-sub"},Ae={key:0,class:"hero-dots"},De=["onClick"],Be={class:"info-card"},$e={class:"card-header"},He={key:0,class:"category-chip"},Pe={class:"card-title"},Ne={class:"info-row"},ze={class:"info-row"},Oe=["disabled"],je={class:"info-row"},xe={class:"info-row"},Ge={class:"info-card"},Ke=["innerHTML"],Je={key:1,class:"info-card"},We={key:0},Qe={key:1},Xe={key:2},Ye={key:3},Ze={key:2,class:"status info"},et={key:3,class:"info-card payment-card"},tt={class:"payment-actions"},at=["disabled"],st=["disabled"],lt={key:4,class:"status error"},ot={key:3,class:"status"},nt={key:4,class:"bottom-bar"},ut={class:"price-block"},rt={class:"price-label"},ct={class:"price-value"},it=["disabled"],dt={class:"modal"},vt={key:0},ht=["type","required","placeholder","onUpdate:modelValue"],pt={key:1},yt=["required","placeholder","onUpdate:modelValue"],mt={key:2},_t=["onUpdate:modelValue","required"],kt=["value"],bt={key:3,class:"choice-group"},gt=["name","value","onUpdate:modelValue","required"],ft={key:4,class:"choice-group"},wt=["value","checked","onChange"],Ct={key:5,class:"inline"},Mt=["checked","onChange"],Et=["disabled"],qt=ie({__name:"EventDetail",setup(Tt){const G=de(),K=ve(),f=m(()=>G.params.eventId),n=h(null),q=h([]),T=h(0),I=h(!0),w=h(null),k=h(!1),C=h(!1),y=h(null),p=h(null),R=h(!1),L=h(!1),b=h(null),S=h(!1),c=he({}),J=pe(),V=m(()=>!!J.user.value),P=async t=>{if(!t){w.value="Missing event id";return}C.value=!1,y.value=null,p.value=null,b.value=null,I.value=!0,w.value=null;try{n.value=await fe(t),q.value=await we(t),T.value=0}catch(s){w.value=s instanceof Error?s.message:"Failed to load event"}finally{I.value=!1}};ye(f,t=>{t&&P(t)}),me(()=>{f.value&&P(f.value)});const A=m(()=>n.value?O(n.value.title):""),W=m(()=>n.value?O(n.value.description??n.value.title):""),N=m(()=>{var t;return((t=q.value[T.value])==null?void 0:t.imageUrl)??null}),Q=m(()=>{const t=n.value;return t!=null&&t.config&&t.config.price?`¥${t.config.price}`:"無料/未設定"}),D=m(()=>{const t=n.value;return t?typeof t.locationLat=="number"&&typeof t.locationLng=="number"?`https://www.google.com/maps/dir/?api=1&destination=${t.locationLat},${t.locationLng}`:`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(t.locationText)}`:null}),X=m(()=>V.value?C.value?"参加予定です":"参加する":"ログイン"),Y=m(()=>k.value||C.value||!!p.value),U=t=>t?new Date(t).toLocaleString(void 0,{month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"}):"--",Z=async()=>{if(!f.value||!V.value){y.value="ログインしてください";return}if(B.value.length){se(),S.value=!0;return}await z({})},B=m(()=>{var t;return((t=n.value)==null?void 0:t.registrationFormSchema)??[]}),z=async t=>{k.value=!0,y.value=null;try{const s=await Ce(f.value,{formAnswers:t});ee(s)}catch(s){y.value=s instanceof Error?s.message:"Failed to register for this event"}finally{k.value=!1}},ee=t=>{t.paymentRequired?(p.value={registrationId:t.registrationId,amount:t.amount},b.value="お支払いを完了すると参加が確定します。"):(C.value=!0,p.value=null,b.value=null)},te=async()=>{if(p.value){R.value=!0,y.value=null;try{await Me(p.value.registrationId),C.value=!0,p.value=null,b.value="お支払いが完了しました。参加が確定です。"}catch(t){y.value=t instanceof Error?t.message:"Failed to process payment"}finally{R.value=!1}}},ae=async()=>{var t,s;if(p.value){L.value=!0,y.value=null;try{const{checkoutUrl:a}=await Ee(p.value.registrationId);window.location.href=a}catch(a){const i=((s=(t=a==null?void 0:a.response)==null?void 0:t.data)==null?void 0:s.message)??(a instanceof Error?a.message:"Stripe Checkoutの開始に失敗しました");y.value=i,L.value=!1}}},d=(t,s)=>t.id??`${t.label??"field"}-${s}`,se=()=>{Object.keys(c).forEach(t=>delete c[t]),B.value.forEach((t,s)=>{const a=d(t,s);t.type==="checkbox"?c[a]=!1:t.type==="multiChoice"?c[a]=[]:c[a]=""})},$=()=>{k.value||(S.value=!1)},le=async()=>{S.value=!1,await z({...c})},H=t=>Array.isArray(t.options)?t.options:[],oe=(t,s,a,i)=>{const r=d(t,s);Array.isArray(c[r])||(c[r]=[]),i?c[r].includes(a)||c[r].push(a):c[r]=c[r].filter(M=>M!==a)},ne=t=>{switch(t){case"email":return"email";case"phone":return"tel";case"number":return"number";case"date":return"date";default:return"text"}},ue=()=>{K.back()},re=()=>{navigator.share&&n.value&&navigator.share({title:A.value,url:window.location.href}).catch(()=>{})},ce=()=>{D.value&&window.open(D.value,"_blank")};return(t,s)=>(o(),l("section",Te,[e("header",{class:"detail-header"},[e("button",{type:"button",class:"icon-btn",onClick:ue},"←"),s[0]||(s[0]=e("p",null,"イベント詳細",-1)),e("button",{type:"button",class:"icon-btn",onClick:re},"⋯")]),I.value?(o(),l("div",Re,[...s[1]||(s[1]=[e("div",{class:"skeleton-hero shimmer"},null,-1),e("div",{class:"skeleton-card shimmer"},null,-1),e("div",{class:"skeleton-card shimmer"},null,-1),e("div",{class:"skeleton-card skeleton-card--thin shimmer"},null,-1)])])):w.value?(o(),l("p",Le,u(w.value),1)):n.value?(o(),l(g,{key:2},[N.value?(o(),l("div",Se,[e("img",{src:N.value,alt:"cover"},null,8,Ue),e("div",Fe,[e("p",Ie,u(A.value),1),e("p",Ve,u(n.value.community.name),1)]),q.value.length>1?(o(),l("div",Ae,[(o(!0),l(g,null,E(q.value,(a,i)=>(o(),l("button",{key:a.id,class:j(["dot",{active:T.value===i}]),onClick:r=>T.value=i},null,10,De))),128))])):v("",!0)])):v("",!0),e("div",Be,[e("div",$e,[n.value.category?(o(),l("span",He,"#"+u(n.value.category),1)):v("",!0),e("p",Pe,u(A.value),1)]),e("div",Ne,[s[2]||(s[2]=e("span",{class:"label"},"日時",-1)),e("span",null,u(U(n.value.startTime))+" 〜 "+u(n.value.endTime?U(n.value.endTime):"未定"),1)]),e("div",ze,[s[3]||(s[3]=e("span",{class:"label"},"場所",-1)),e("span",null,[_(u(n.value.locationText)+" ",1),e("button",{type:"button",class:"link",onClick:ce,disabled:!D.value}," 地図を開く ",8,Oe)])]),e("div",je,[s[4]||(s[4]=e("span",{class:"label"},"受付期間",-1)),e("span",null,u(U(n.value.regStartTime??n.value.startTime))+" 〜 "+u(U(n.value.regEndTime??n.value.startTime)),1)]),e("div",xe,[s[5]||(s[5]=e("span",{class:"label"},"ステータス",-1)),e("span",{class:j(["status-pill",n.value.status==="open"?"open":"closed"])},u(n.value.status==="open"?"受付中":"終了"),3)])]),e("div",Ge,[s[6]||(s[6]=e("h3",null,"イベント概要",-1)),e("p",null,u(W.value),1),n.value.descriptionHtml?(o(),l("div",{key:0,class:"rich",innerHTML:n.value.descriptionHtml},null,8,Ke)):v("",!0)]),n.value.config?(o(),l("div",Je,[s[7]||(s[7]=e("h3",null,"参加ルール",-1)),e("ul",null,[n.value.config.requireCheckin?(o(),l("li",We,"✔ チェックイン必須")):v("",!0),n.value.config.enableWaitlist?(o(),l("li",Qe,"✔ キャンセル待ちあり")):v("",!0),n.value.config.refundPolicy?(o(),l("li",Xe,"返金: "+u(n.value.config.refundPolicy),1)):v("",!0),n.value.config.riskNoticeEnabled?(o(),l("li",Ye,"⚠️ 注意事項をご確認ください。")):v("",!0)])])):v("",!0),b.value?(o(),l("p",Ze,u(b.value),1)):v("",!0),p.value?(o(),l("div",et,[e("p",null,"支払額: ¥"+u(p.value.amount??0),1),e("div",tt,[e("button",{type:"button",class:"primary",onClick:ae,disabled:L.value},u(L.value?"Stripeへ移動中...":"Stripeで支払う"),9,at),e("button",{type:"button",class:"secondary",onClick:te,disabled:R.value},u(R.value?"Mock 決済中...":"Mock 支払い（デモ）"),9,st)])])):v("",!0),y.value?(o(),l("p",lt,u(y.value),1)):v("",!0)],64)):(o(),l("p",ot,"イベントが見つかりません。")),n.value?(o(),l("div",nt,[e("div",ut,[e("p",rt,u(V.value?"参加費":"ログインが必要です"),1),e("p",ct,u(Q.value),1)]),e("button",{type:"button",class:"cta-btn",disabled:Y.value,onClick:Z},u(X.value),9,it)])):v("",!0),S.value?(o(),l("div",{key:5,class:"modal-backdrop",onClick:x($,["self"])},[e("div",dt,[e("header",null,[s[8]||(s[8]=e("h3",null,"参加申込フォーム",-1)),e("button",{type:"button",class:"close",onClick:$},"×")]),e("form",{onSubmit:x(le,["prevent"]),class:"dynamic-form"},[(o(!0),l(g,null,E(B.value,(a,i)=>(o(),l("div",{key:d(a,i)},[["text","email","phone","number","date"].includes(a.type)?(o(),l("label",vt,[_(u(a.label)+" ",1),F(e("input",{type:ne(a.type),required:a.required,placeholder:a.placeholder,"onUpdate:modelValue":r=>c[d(a,i)]=r},null,8,ht),[[_e,c[d(a,i)]]])])):a.type==="textarea"?(o(),l("label",pt,[_(u(a.label)+" ",1),F(e("textarea",{required:a.required,placeholder:a.placeholder,"onUpdate:modelValue":r=>c[d(a,i)]=r},null,8,yt),[[ke,c[d(a,i)]]])])):a.type==="select"?(o(),l("label",mt,[_(u(a.label)+" ",1),F(e("select",{"onUpdate:modelValue":r=>c[d(a,i)]=r,required:a.required},[s[9]||(s[9]=e("option",{value:"",disabled:""},"選択してください",-1)),(o(!0),l(g,null,E(H(a),r=>(o(),l("option",{key:r,value:r},u(r),9,kt))),128))],8,_t),[[be,c[d(a,i)]]])])):a.type==="singleChoice"?(o(),l("div",bt,[e("p",null,u(a.label),1),(o(!0),l(g,null,E(H(a),r=>(o(),l("label",{key:r,class:"inline"},[F(e("input",{type:"radio",name:d(a,i),value:r,"onUpdate:modelValue":M=>c[d(a,i)]=M,required:a.required},null,8,gt),[[ge,c[d(a,i)]]]),_(" "+u(r),1)]))),128))])):a.type==="multiChoice"?(o(),l("div",ft,[e("p",null,u(a.label),1),(o(!0),l(g,null,E(H(a),r=>(o(),l("label",{key:r,class:"inline"},[e("input",{type:"checkbox",value:r,checked:Array.isArray(c[d(a,i)])&&c[d(a,i)].includes(r),onChange:M=>oe(a,i,r,M.target.checked)},null,40,wt),_(" "+u(r),1)]))),128))])):a.type==="checkbox"?(o(),l("label",Ct,[e("input",{type:"checkbox",checked:!!c[d(a,i)],onChange:r=>c[d(a,i)]=r.target.checked},null,40,Mt),_(" "+u(a.label),1)])):v("",!0)]))),128)),e("footer",null,[e("button",{type:"button",class:"secondary",onClick:$},"キャンセル"),e("button",{type:"submit",class:"primary",disabled:k.value},u(k.value?"送信中...":"送信"),9,Et)])],32)])])):v("",!0)]))}}),Lt=qe(qt,[["__scopeId","data-v-01dab71e"]]);export{Lt as default};
