import{d as X,a7 as K,af as $,r as f,c as I,o as H,e as i,F as R,i as a,j as g,h as J,z as V,t as m,w as Q,k as Y,ax as Z,ay as ee,a9 as te,a5 as ne,u as ae,f as o,_ as se}from"./index-DncFUGrq.js";var W="https://js.stripe.com/v3",re=/^https:\/\/js\.stripe\.com\/v3\/?(\?.*)?$/;var le=function(){for(var t=document.querySelectorAll('script[src^="'.concat(W,'"]')),s=0;s<t.length;s++){var l=t[s];if(re.test(l.src))return l}return null},q=function(t){var s="",l=document.createElement("script");l.src="".concat(W).concat(s);var r=document.head||document.body;if(!r)throw new Error("Expected document.body not to be null. Stripe.js requires a <body> element.");return r.appendChild(l),l},ie=function(t,s){!t||!t._registerWrapper||t._registerWrapper({name:"stripe-js",version:"4.6.0",startTime:s})},C=null,L=null,j=null,oe=function(t){return function(){t(new Error("Failed to load Stripe.js"))}},ue=function(t,s){return function(){window.Stripe?t(window.Stripe):s(new Error("Stripe.js not available"))}},ce=function(t){return C!==null?C:(C=new Promise(function(s,l){if(typeof window>"u"||typeof document>"u"){s(null);return}if(window.Stripe){s(window.Stripe);return}try{var r=le();if(!(r&&t)){if(!r)r=q(t);else if(r&&j!==null&&L!==null){var u;r.removeEventListener("load",j),r.removeEventListener("error",L),(u=r.parentNode)===null||u===void 0||u.removeChild(r),r=q(t)}}j=ue(s,l),L=oe(l),r.addEventListener("load",j),r.addEventListener("error",L)}catch(y){l(y);return}}),C.catch(function(s){return C=null,Promise.reject(s)}))},de=function(t,s,l){if(t===null)return null;var r=t.apply(void 0,s);return ie(r,l),r},P,G=!1,N=function(){return P||(P=ce(null).catch(function(t){return P=null,Promise.reject(t)}),P)};Promise.resolve().then(function(){return N()}).catch(function(v){G||console.warn(v)});var ve=function(){for(var t=arguments.length,s=new Array(t),l=0;l<t;l++)s[l]=arguments[l];G=!0;var r=Date.now();return N().then(function(u){return de(u,s,r)})};const me={class:"sub-header"},pe=["disabled"],fe={key:0,class:"empty"},ye={key:1,class:"empty"},he={key:2,class:"plan-list"},_e=["disabled","onClick"],be={class:"plan-head"},we={class:"plan-name"},Se={class:"plan-price"},ge={key:0},Ee={key:1},ke={key:0,class:"plan-badge"},Ce={class:"plan-meta"},Pe={class:"plan-meta"},Le={class:"plan-meta"},je={class:"plan-action"},xe={key:0,class:"loading"},Fe={key:1,class:"loading"},Te={key:2,class:"current"},Ae={key:3,class:"action-cta"},Be={key:0,class:"empty"},Ie={key:3,class:"error"},Me={class:"payment-sheet"},Re={class:"pay-header"},Ve={class:"pay-title"},qe=["disabled"],We={key:0,class:"pay-amount"},Ge=["disabled"],Ne={key:0,class:"spinner"},ze={key:1,class:"error"},De=X({__name:"SubscriptionMobile",setup(v){const t=K();ae();const s=$(),l=f([]),r=f(!1),u=f(null),y=f(null),p=f(!1),_=f(null),b=f(null),x=f(null);let w=null,S=null,h=null;const E=I(()=>t.activeCommunityId.value),F=I(()=>{var e;return((e=t.getActiveCommunity())==null?void 0:e.pricingPlanId)??null}),M=async()=>{u.value=null,r.value=!0;try{l.value=await Z()}catch(e){u.value=e instanceof Error?e.message:"无法获取套餐列表"}finally{r.value=!1}},z=e=>{if(!e.features||typeof e.features!="object")return"基础支持";const n=Object.values(e.features).flat();return n.length?n.slice(0,3).join(" / "):"基础支持"},D=async e=>{var n;if(!(!E.value||y.value)){y.value=e,u.value=null;try{const c=await ee(E.value,e);if(c.clientSecret&&c.publishableKey)b.value=e,_.value=c.clientSecret,await O(c.clientSecret,c.publishableKey);else{if((n=T(e))!=null&&n.monthlyFee&&T(e).monthlyFee>0)throw new Error("支付配置缺失，请检查后端 Stripe publishable key");await k(),s.show("已切换套餐","success")}}catch(c){u.value=c instanceof Error?c.message:"订阅失败"}finally{y.value=null}}},T=e=>l.value.find(n=>n.id===e),A=I(()=>b.value?T(b.value):null),k=async()=>{if(await t.loadCommunities(!0),E.value){const e=await te(E.value).catch(()=>null);e!=null&&e.id&&t.setActiveCommunity(e.id)}await M()};H(async()=>{t.loaded.value||(await t.loadCommunities(),t.ensureActiveCommunity()),await M()});const O=async(e,n)=>{if(!n)throw new Error("缺少 Stripe publishable key");if(w=await ve(n),!w)throw new Error("Stripe 初始化失败");S=w.elements({clientSecret:e,appearance:{theme:"flat"}}),await ne(),h&&h.unmount(),x.value&&(h=S.create("payment"),h.mount(x.value))},B=()=>{_.value=null,b.value=null,p.value=!1,h&&(h.unmount(),h=null),S=null,w=null},U=async()=>{if(!w||!S||!_.value){u.value="支付信息未准备好";return}p.value=!0,u.value=null;try{const{error:e}=await S.submit();if(e){u.value=e.message||"请检查支付信息后重试",p.value=!1;return}const{error:n,paymentIntent:c}=await w.confirmPayment({elements:S,clientSecret:_.value,redirect:"if_required",confirmParams:{}});if(n){u.value=n.message||"支付失败，请重试";return}if((c==null?void 0:c.status)==="succeeded"){await k(),B(),s.show("支付完成，正在刷新套餐状态","success");return}if((c==null?void 0:c.status)==="processing"){s.show("支付处理中，请稍后查看状态","warning"),await k();return}s.show("支付未完成，请重试","warning"),await k()}catch(e){console.error("confirmPayment failed",e),u.value=e instanceof Error?e.message:"支付失败，请重试"}finally{p.value=!1}};return(e,n)=>{var c;return o(),i("div",{class:V(["subscription-page",{"subscription-page--payment":!!_.value}])},[_.value?(o(),i("div",{key:1,class:"payment-overlay",onClick:Q(B,["self"])},[a("section",Me,[a("header",Re,[n[5]||(n[5]=a("div",{class:"pay-handle"},null,-1)),a("div",Ve,[n[3]||(n[3]=a("p",{class:"sub-label"},"支付确认",-1)),a("h1",null,m(((c=A.value)==null?void 0:c.name)||"套餐支付"),1)]),a("button",{class:"close-btn",type:"button",disabled:p.value,onClick:B},[...n[4]||(n[4]=[a("span",{class:"i-lucide-x"},null,-1)])],8,qe)]),A.value?(o(),i("div",We," ¥"+m(A.value.monthlyFee)+"/月 ",1)):g("",!0),n[7]||(n[7]=a("div",{class:"payment-tip"},"请在应用内完成支付，成功后自动开通套餐",-1)),a("div",{ref_key:"paymentElementContainer",ref:x,class:"payment-element"},null,512),a("button",{class:"pay-btn",type:"button",disabled:p.value,onClick:U},[p.value?(o(),i("span",Ne)):g("",!0),n[6]||(n[6]=Y(" 确认并支付 ",-1))],8,Ge),u.value?(o(),i("p",ze,m(u.value),1)):g("",!0)])])):(o(),i(R,{key:0},[a("header",me,[n[1]||(n[1]=a("div",null,[a("p",{class:"sub-label"},"订阅计划"),a("h1",null,"选择你的收款能力")],-1)),a("button",{class:"refresh-btn",type:"button",onClick:k,disabled:r.value||p.value},[...n[0]||(n[0]=[a("span",{class:"i-lucide-refresh-ccw"},null,-1)])],8,pe)]),r.value?(o(),i("div",fe,"加载中…")):E.value?(o(),i("div",he,[(o(!0),i(R,null,J(l.value,d=>(o(),i("button",{key:d.id,class:V(["plan-card",{active:d.id===F.value,paying:b.value===d.id}]),type:"button",disabled:y.value===d.id||p.value,onClick:Oe=>D(d.id)},[a("div",be,[a("div",null,[a("p",we,m(d.name),1),a("p",Se,[d.monthlyFee>0?(o(),i("span",ge,"¥"+m(d.monthlyFee)+"/月",1)):(o(),i("span",Ee,"免费"))])]),d.id===F.value?(o(),i("span",ke,"当前")):g("",!0)]),a("p",Ce,"手续费："+m(d.transactionFeePercent)+"% + ¥"+m(d.transactionFeeFixed),1),a("p",Pe,"结算："+m(d.payoutSchedule),1),a("p",Le,"功能："+m(z(d)),1),a("div",je,[y.value===d.id?(o(),i("span",xe,"处理中...")):b.value===d.id?(o(),i("span",Fe,"填写支付信息")):d.id===F.value?(o(),i("span",Te,"已订阅")):(o(),i("span",Ae,"开通"))])],10,_e))),128)),l.value.length?g("",!0):(o(),i("div",Be,"暂无可选套餐"))])):(o(),i("div",ye,[...n[2]||(n[2]=[a("p",null,"请先选择一个社群再订阅套餐。",-1)])])),u.value?(o(),i("p",Ie,m(u.value),1)):g("",!0)],64))],2)}}}),Xe=se(De,[["__scopeId","data-v-5f66181a"]]);export{Xe as default};
