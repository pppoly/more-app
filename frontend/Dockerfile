FROM node:20-slim AS builder

WORKDIR /app

COPY package.json package-lock.json ./
RUN npm ci

COPY . .

ARG VITE_API_BASE_URL
ARG VITE_APP_TARGET
ARG VITE_APP_ENV
ARG VITE_LIFF_ID
ARG VITE_LINE_CHANNEL_ID
ARG VITE_DEV_LOGIN_SECRET
ARG VITE_GOOGLE_MAPS_API_KEY
ARG VITE_STRIPE_FEE_PERCENT
ARG VITE_STRIPE_FEE_FIXED_JPY
ARG VITE_STRIPE_FEE_MIN_JPY
ARG VITE_PLATFORM_FEE_WAIVED

ENV VITE_API_BASE_URL=$VITE_API_BASE_URL
ENV VITE_APP_TARGET=$VITE_APP_TARGET
ENV VITE_APP_ENV=$VITE_APP_ENV
ENV VITE_LIFF_ID=$VITE_LIFF_ID
ENV VITE_LINE_CHANNEL_ID=$VITE_LINE_CHANNEL_ID
ENV VITE_DEV_LOGIN_SECRET=$VITE_DEV_LOGIN_SECRET
ENV VITE_GOOGLE_MAPS_API_KEY=$VITE_GOOGLE_MAPS_API_KEY
ENV VITE_STRIPE_FEE_PERCENT=$VITE_STRIPE_FEE_PERCENT
ENV VITE_STRIPE_FEE_FIXED_JPY=$VITE_STRIPE_FEE_FIXED_JPY
ENV VITE_STRIPE_FEE_MIN_JPY=$VITE_STRIPE_FEE_MIN_JPY
ENV VITE_PLATFORM_FEE_WAIVED=$VITE_PLATFORM_FEE_WAIVED

RUN npm run build && npm run build:liff

FROM nginx:1.27-alpine AS runner

COPY nginx.conf /etc/nginx/conf.d/default.conf
COPY --from=builder /app/dist /usr/share/nginx/html
COPY --from=builder /app/dist-liff /usr/share/nginx/html/liff

EXPOSE 80
CMD ["nginx", "-g", "daemon off;"]

